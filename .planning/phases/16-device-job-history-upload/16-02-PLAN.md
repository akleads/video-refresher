---
phase: 16-device-job-history-upload
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - views/device-progress.js
  - lib/api.js
autonomous: true

must_haves:
  truths:
    - "After device processing completes, results automatically upload to server"
    - "Upload progress bar is visible during result upload"
    - "Failed uploads show error message with retry button"
    - "Successful upload shows 'View in History' link to navigate to job detail page"
    - "User can still download ZIP locally even during/after upload"
  artifacts:
    - path: "views/device-progress.js"
      provides: "Upload-to-server logic after device processing"
      contains: "uploadResultsToServer"
    - path: "lib/api.js"
      provides: "uploadDeviceResults function using XHR for progress"
      contains: "uploadDeviceResults"
  key_links:
    - from: "views/device-progress.js"
      to: "lib/api.js"
      via: "uploadDeviceResults call"
      pattern: "uploadDeviceResults"
    - from: "lib/api.js"
      to: "/api/jobs/device"
      via: "XHR POST with FormData"
      pattern: "api/jobs/device"
---

<objective>
Wire the frontend device-progress view to automatically upload processing results to the server after device processing completes.

Purpose: Once device processing finishes, the video blobs need to be sent to the new POST /api/jobs/device endpoint so they appear in job history. The user sees upload progress and can retry on failure.

Output: Modified device-progress.js that uploads results after processing, with a progress bar for the upload phase. Modified lib/api.js with a new uploadDeviceResults helper.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-device-job-history-upload/16-01-SUMMARY.md
@views/device-progress.js
@lib/api.js
@views/upload.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add uploadDeviceResults function to lib/api.js</name>
  <files>lib/api.js</files>
  <action>
    Add a new exported function `uploadDeviceResults(formData, onProgress)` to lib/api.js.

    This function is similar to the existing `uploadFiles` function but:
    - Posts to `/api/jobs/device` (not `/api/jobs`)
    - Accepts FormData containing: `results` (multiple MP4 blob files) and `sourceFiles` (JSON string metadata)
    - Uses XHR (like `uploadFiles`) for upload progress tracking via `xhr.upload` progress events
    - Calls `onProgress(percentComplete)` during upload (0-100)
    - Includes the auth Bearer token header
    - Returns a Promise that resolves with the parsed JSON response `{jobId, status, totalVideos, totalVariations, source}` on success
    - Rejects with Error on failure (including 401 handling to redirect to login)

    Pattern to follow: Copy the structure of the existing `uploadFiles` function, changing only the URL to `API_BASE + '/api/jobs/device'`.

    The function signature:
    ```javascript
    export function uploadDeviceResults(formData, onProgress) {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        const token = localStorage.getItem('token');

        xhr.upload.addEventListener('progress', (e) => {
          if (e.lengthComputable && onProgress) {
            const percentComplete = (e.loaded / e.total) * 100;
            onProgress(percentComplete);
          }
        });

        xhr.addEventListener('load', () => {
          if (xhr.status >= 200 && xhr.status < 300) {
            try {
              resolve(JSON.parse(xhr.responseText));
            } catch (err) {
              reject(new Error('Failed to parse response'));
            }
          } else if (xhr.status === 401) {
            localStorage.removeItem('token');
            window.location.hash = '#login?expired=1';
            reject(new Error('Session expired'));
          } else {
            reject(new Error(`Upload failed: HTTP ${xhr.status}`));
          }
        });

        xhr.addEventListener('error', () => {
          reject(new Error('Network error during upload'));
        });

        xhr.open('POST', API_BASE + '/api/jobs/device');
        if (token) {
          xhr.setRequestHeader('Authorization', `Bearer ${token}`);
        }
        xhr.send(formData);
      });
    }
    ```
  </action>
  <verify>
    Read lib/api.js and confirm the new function is exported alongside existing functions. No syntax errors.
  </verify>
  <done>
    - `uploadDeviceResults` function exported from lib/api.js
    - Uses XHR with progress tracking, auth header, proper error handling
    - Posts to /api/jobs/device
  </done>
</task>

<task type="auto">
  <name>Task 2: Add upload-to-server flow after device processing completes</name>
  <files>views/device-progress.js</files>
  <action>
    Modify views/device-progress.js to add a server upload phase after device processing completes successfully.

    1. Add import at top:
       `import { uploadDeviceResults } from '../lib/api.js';`

    2. In the `renderDeviceProgress` function, add a new UI section for upload progress (created alongside other UI elements, initially hidden):
       - An "upload progress section" div containing:
         - Label text: "Uploading to server..."
         - A progress bar (same style as overall progress bar: track + fill)
         - Upload percentage text
         - An upload status text element
       - Style: same as progressSection but with display:none initially
       - Place it after the resultsSection in the DOM

    3. Add a "Retry Upload" button (initially hidden) in the buttonSection, after the download button.

    4. Modify the `startProcessing` function completion logic. After the "Processing complete!" state (when not cancelled and allResults.length > 0):

       a. Keep the download button visible (user can still download ZIP locally).
       b. Show the upload progress section.
       c. Set upload status to "Uploading results to server..."
       d. Call the new `uploadResultsToServer` helper function (defined below).

    5. Create async function `uploadResultsToServer(allResults, files, variationCount, uploadElements)`:
       - `uploadElements` is an object with references to: uploadSection, uploadBarFill, uploadText, uploadStatus, retryBtn, newBatchLink, statusText
       - Build a FormData:
         - For `sourceFiles`: create JSON array from the original `files` (File objects). Map each to `{name: file.name, variationCount: variationCount}`. Append as `formData.append('sourceFiles', JSON.stringify(sourceFilesArray))`.
         - For each result in `allResults`: `formData.append('results', result.blob, result.name)`. The `result.name` is in format `{baseName}/{baseName}_var{N}_{uuid}.mp4` -- this becomes the filename multer sees.
       - Call `uploadDeviceResults(formData, onProgress)` where onProgress updates the upload bar and text.
       - On success:
         - Update upload status to "Uploaded successfully!"
         - Update the main statusText to "Processing complete! Results saved to server."
         - Set statusText color to success green
         - Hide retry button
         - After a brief moment (500ms), optionally navigate to the job: `window.location.hash = '#job/' + result.jobId`. BUT -- do NOT auto-navigate. Instead, show a "View in History" link/button that navigates to `#job/${result.jobId}`. This gives the user control.
       - On failure:
         - Update upload status to the error message (e.g., "Upload failed: Network error")
         - Set upload status color to error red
         - Show the retry button
         - Update main statusText to "Processing complete! Upload to server failed."
         - Do NOT hide the download button -- user can still get their files via local ZIP

    6. Wire the retry button:
       - On click: hide retry button, reset upload progress to 0%, call `uploadResultsToServer` again with the same arguments
       - The retry should work because allResults (array of {name, blob}) is still in memory

    Important details:
    - The `allResults` array stays in module state, so retry has access to it
    - The `files` array (original File objects from pendingFiles) and `variationCount` are available in the startProcessing closure
    - Keep the ZIP download functional at all times -- upload is a bonus persistence step, not a replacement for local download
    - If processing was cancelled but has partial results, still attempt upload of partial results (user already has the download option)
    - Do NOT block the UI during upload -- the download button and new batch link remain interactive
  </action>
  <verify>
    1. Build/serve the frontend and navigate to device processing view
    2. Process a small video file with 1-2 variations
    3. After processing completes, verify:
       - Upload progress section appears
       - Progress bar fills during upload
       - On success: "Uploaded successfully!" message and "View in History" link appear
       - The job appears in the Jobs list (navigate to #jobs)
    4. Test retry: temporarily stop the server, process a video, observe upload failure, restart server, click retry, verify upload succeeds
  </verify>
  <done>
    - After device processing, results auto-upload to server
    - Upload progress bar visible during upload
    - Success shows "View in History" link to the job detail page
    - Failure shows error message and "Retry Upload" button
    - Local ZIP download works regardless of upload status
    - Retry button re-attempts the upload
  </done>
</task>

</tasks>

<verification>
1. Full end-to-end flow: Select file -> Process on device -> Processing completes -> Upload progress visible -> Upload succeeds -> "View in History" link works -> Job visible in job list -> Job detail shows files and download works
2. Error path: Upload fails (server down) -> Error message shown -> Retry button visible -> Local ZIP still downloadable -> Server comes back -> Retry succeeds
3. Partial results: Cancel mid-processing -> Partial results uploaded -> Job shows in history with correct variation count
</verification>

<success_criteria>
- Device processing results automatically upload to server after completion
- Upload progress is clearly visible with a progress bar
- Failed uploads display error with retry option
- Local ZIP download remains functional regardless of upload status
- Uploaded device jobs appear in job history list
</success_criteria>

<output>
After completion, create `.planning/phases/16-device-job-history-upload/16-02-SUMMARY.md`
</output>
