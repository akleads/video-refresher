---
phase: 10-foundation-abstraction
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/middleware/security.js
  - server/index.js
  - server/package.json
  - lib/effects-shared.js
  - server/lib/effects.js
autonomous: true

must_haves:
  truths:
    - "Backend API responses include Cross-Origin-Resource-Policy: cross-origin header"
    - "Frontend fetches to the API succeed when browser enforces COEP"
    - "Shared effects module generates identical effect parameter sets when given the same seed"
    - "Server uses shared effects module instead of Math.random() for effect generation"
  artifacts:
    - path: "server/middleware/security.js"
      provides: "CORP header middleware"
      contains: "Cross-Origin-Resource-Policy"
    - path: "lib/effects-shared.js"
      provides: "Isomorphic effect generation with seeded PRNG"
      exports: ["generateUniqueEffects", "buildFilterString"]
    - path: "server/lib/effects.js"
      provides: "Server wrapper re-exporting shared module"
      contains: "effects-shared"
  key_links:
    - from: "server/index.js"
      to: "server/middleware/security.js"
      via: "middleware import and app.use()"
      pattern: "import.*security"
    - from: "server/lib/effects.js"
      to: "lib/effects-shared.js"
      via: "re-export from shared module"
      pattern: "from.*effects-shared"
---

<objective>
Add Cross-Origin-Resource-Policy header to backend API responses and extract effect generation into a shared isomorphic ES module with seeded PRNG.

Purpose: Backend CORP header is required before frontend COEP can be enabled (without it, all API calls would be blocked). Shared effects module ensures browser and server generate identical variations from the same seed.
Output: CORP middleware on Express, shared effects-shared.js with seedrandom, server effects.js updated to re-export from shared module.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-foundation-abstraction/10-RESEARCH.md
@server/index.js
@server/lib/effects.js
@server/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CORP header middleware to Express</name>
  <files>server/middleware/security.js, server/index.js, server/package.json</files>
  <action>
1. Install helmet in server directory: `cd server && npm install helmet`

2. Create `server/middleware/security.js`:
```javascript
import helmet from 'helmet';

/**
 * Configure security headers for COEP compatibility.
 * Sets Cross-Origin-Resource-Policy: cross-origin so frontend
 * with COEP: require-corp can fetch from this API.
 */
export function securityHeaders() {
  return helmet({
    crossOriginResourcePolicy: { policy: "cross-origin" }
  });
}
```

3. In `server/index.js`, import and apply the middleware BEFORE the cors() middleware and routes:
- Add import: `import { securityHeaders } from './middleware/security.js';`
- Add `app.use(securityHeaders());` right after `const app = express();` and BEFORE the `app.use(cors({...}))` block.

Do NOT replace the existing cors() middleware -- both must be present. Helmet's CORP header and CORS serve different purposes.
  </action>
  <verify>
Start the server locally (`cd server && node index.js`) and verify:
- `curl -I http://localhost:8080/api/health` includes `Cross-Origin-Resource-Policy: cross-origin` in response headers
- Server starts without errors
- Existing health endpoint still returns 200
  </verify>
  <done>All API responses include `Cross-Origin-Resource-Policy: cross-origin` header. Server starts and existing routes work.</done>
</task>

<task type="auto">
  <name>Task 2: Extract shared effects module with seedrandom</name>
  <files>lib/effects-shared.js, server/lib/effects.js, server/package.json</files>
  <action>
1. Install seedrandom in server directory: `cd server && npm install seedrandom`

2. Create `lib/effects-shared.js` (at project root, NOT in server/) as a pure ES module:
```javascript
/**
 * Shared effect generation module.
 * Pure ES module -- works identically in browser and Node.js.
 * Uses seedrandom for deterministic PRNG so same seed produces
 * identical effects in both environments.
 */

/**
 * Generate a seeded random number within a range.
 * @param {Function} rng - Seeded random function from seedrandom
 * @param {number} min
 * @param {number} max
 * @returns {number}
 */
function randomInRange(rng, min, max) {
  return min + rng() * (max - min);
}

/**
 * Generate unique random effects with deterministic seed.
 * @param {Function} rng - Seeded random function (seedrandom instance)
 * @param {number} count - Number of unique effects to generate
 * @returns {Array<{rotation: number, brightness: number, contrast: number, saturation: number}>}
 */
export function generateUniqueEffects(rng, count) {
  const effects = [];
  const seen = new Set();
  const maxAttempts = count * 100;
  let attempts = 0;

  while (effects.length < count && attempts < maxAttempts) {
    attempts++;
    const effect = {
      rotation: parseFloat(randomInRange(rng, 0.001, 0.01).toFixed(4)),
      brightness: parseFloat(randomInRange(rng, -0.05, 0.05).toFixed(4)),
      contrast: parseFloat(randomInRange(rng, 0.95, 1.05).toFixed(4)),
      saturation: parseFloat(randomInRange(rng, 0.95, 1.05).toFixed(4))
    };
    const key = JSON.stringify(effect);
    if (!seen.has(key)) {
      seen.add(key);
      effects.push(effect);
    }
  }

  if (effects.length < count) {
    throw new Error(`Unable to generate ${count} unique effects after ${maxAttempts} attempts`);
  }

  return effects;
}

/**
 * Build FFmpeg filter string from effect object.
 * @param {Object} effects
 * @returns {string} FFmpeg filter string
 */
export function buildFilterString(effects) {
  return `rotate=${effects.rotation}:fillcolor=black@0,eq=brightness=${effects.brightness}:contrast=${effects.contrast}:saturation=${effects.saturation}`;
}
```

IMPORTANT design note: The shared module takes an `rng` function as parameter instead of importing seedrandom directly. This keeps the module dependency-free and lets each environment provide the PRNG however it prefers (npm import on server, CDN-loaded global on browser). The caller creates the seedrandom instance and passes it in.

3. Rewrite `server/lib/effects.js` to import seedrandom locally and delegate to the shared module:
```javascript
import seedrandom from 'seedrandom';
import { generateUniqueEffects as _generateUniqueEffects, buildFilterString } from '../../lib/effects-shared.js';

/**
 * Server wrapper for shared effects module.
 * Creates seeded PRNG and delegates to shared logic.
 * Backward-compatible: callers that don't pass a seed get random behavior.
 */
export function generateUniqueEffects(count, seed) {
  const rng = seed ? seedrandom(seed) : seedrandom();
  return _generateUniqueEffects(rng, count);
}

export { buildFilterString };
```

This maintains backward compatibility -- existing server code calling `generateUniqueEffects(count)` still works (gets random seed). New code can pass a seed for deterministic output.

4. Verify no other server files need updates by checking all imports of effects.js:
- `server/lib/processor.js` (or wherever `generateUniqueEffects` is called) should still work since the function signature is backward-compatible (count is still first param, seed is optional).
  </action>
  <verify>
Test the server still processes correctly:
- `cd server && node -e "import('./lib/effects.js').then(m => { const e = m.generateUniqueEffects(3); console.log(e); console.log(m.buildFilterString(e[0])); })"`
- Should output 3 effect objects and a filter string
- Test determinism: `node -e "import('./lib/effects.js').then(m => { console.log(JSON.stringify(m.generateUniqueEffects(3, 'test-seed'))); })"` -- run twice, output must be identical
  </verify>
  <done>Shared effects module exists at `lib/effects-shared.js`. Server effects.js delegates to it. Same seed produces identical output across runs. Existing server code works without changes.</done>
</task>

</tasks>

<verification>
1. `curl -I http://localhost:8080/api/health` shows `Cross-Origin-Resource-Policy: cross-origin`
2. Server starts without import errors
3. `generateUniqueEffects(5, 'seed-abc')` produces identical output on repeated calls
4. `buildFilterString()` produces valid FFmpeg filter syntax
5. No breaking changes to existing server behavior
</verification>

<success_criteria>
- Backend API includes CORP header on all responses
- Shared effects module is a pure ES module with no environment-specific code
- Server effects.js re-exports from shared module with backward compatibility
- seedrandom installed in server/package.json
- Deterministic: same seed = same effects
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-abstraction/10-01-SUMMARY.md`
</output>
