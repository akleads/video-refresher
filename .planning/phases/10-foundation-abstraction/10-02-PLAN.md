---
phase: 10-foundation-abstraction
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - _headers
  - lib/capability-detection.js
autonomous: true

must_haves:
  truths:
    - "Frontend pages load with COOP/COEP headers active and SharedArrayBuffer is available in browser console"
    - "Browser capability detection correctly identifies whether SharedArrayBuffer is available"
    - "Capability detection reports processing mode to the UI layer"
    - "API fetches still succeed after COEP is enabled (because CORP header from Plan 10-01 is already deployed)"
  artifacts:
    - path: "_headers"
      provides: "COOP/COEP headers for Cloudflare Pages"
      contains: "Cross-Origin-Embedder-Policy"
    - path: "lib/capability-detection.js"
      provides: "Browser capability detection for SharedArrayBuffer and processing mode"
      exports: ["supportsClientProcessing", "getProcessingMode"]
  key_links:
    - from: "_headers"
      to: "window.crossOriginIsolated"
      via: "Browser sets crossOriginIsolated=true when COOP+COEP headers present"
      pattern: "Cross-Origin-Opener-Policy.*same-origin"
    - from: "lib/capability-detection.js"
      to: "window.crossOriginIsolated"
      via: "Reads browser API to determine client processing support"
      pattern: "crossOriginIsolated"
---

<objective>
Restore COOP/COEP headers on Cloudflare Pages and add browser capability detection for SharedArrayBuffer.

Purpose: COOP/COEP headers enable SharedArrayBuffer in the browser, which FFmpeg.wasm requires for multi-threaded processing. Capability detection lets the UI know whether device processing is available, enabling graceful fallback to server mode.
Output: Updated `_headers` file with COOP/COEP rules, `lib/capability-detection.js` module.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-foundation-abstraction/10-RESEARCH.md
@.planning/phases/10-foundation-abstraction/10-01-SUMMARY.md
@_headers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restore COOP/COEP headers in Cloudflare Pages _headers file</name>
  <files>_headers</files>
  <action>
Replace the contents of `_headers` with:
```
# Cloudflare Pages custom headers
# COOP/COEP required for SharedArrayBuffer (FFmpeg.wasm multi-threaded processing)
/*
  Cross-Origin-Opener-Policy: same-origin
  Cross-Origin-Embedder-Policy: require-corp
```

This restores the v1.0 configuration that was removed in Phase 9 (v2.0). The `/*` pattern applies headers to ALL paths including the root document.

IMPORTANT: This MUST only be deployed AFTER Plan 10-01 has been deployed (backend CORP header). Without the backend sending `Cross-Origin-Resource-Policy: cross-origin`, COEP: require-corp will block all API calls to Fly.io.

Verify CDN compatibility: jsDelivr (used for FFmpeg.wasm CDN) already sends CORP headers, so CDN resources will not be blocked.
  </action>
  <verify>
After deploying to Cloudflare Pages:
- `curl -I https://video-refresher.pages.dev/` should show both `Cross-Origin-Opener-Policy: same-origin` and `Cross-Origin-Embedder-Policy: require-corp`
- Open browser console on the deployed page and type `window.crossOriginIsolated` -- should return `true`
- Open browser console and type `typeof SharedArrayBuffer` -- should return `"function"`
- Existing API calls (login, job list) still work (because backend CORP header is live from Plan 10-01)

For local testing before deploy: verify the file content is correct with `cat _headers`.
  </verify>
  <done>`_headers` file contains COOP/COEP rules. After deployment, `window.crossOriginIsolated` returns true and SharedArrayBuffer is available.</done>
</task>

<task type="auto">
  <name>Task 2: Create browser capability detection module</name>
  <files>lib/capability-detection.js</files>
  <action>
Create `lib/capability-detection.js`:
```javascript
/**
 * Browser capability detection for client-side processing.
 * Checks cross-origin isolation (COOP+COEP) and SharedArrayBuffer availability.
 */

/**
 * Check if browser supports client-side FFmpeg.wasm processing.
 * Requires both cross-origin isolation and SharedArrayBuffer.
 * @returns {boolean} True if client-side processing available
 */
export function supportsClientProcessing() {
  if (typeof window === 'undefined') {
    return false;
  }

  if (!window.crossOriginIsolated) {
    console.warn('[capability] Cross-origin isolation not enabled (COOP/COEP headers missing)');
    return false;
  }

  if (typeof SharedArrayBuffer === 'undefined') {
    console.warn('[capability] SharedArrayBuffer not available despite cross-origin isolation');
    return false;
  }

  return true;
}

/**
 * Get recommended processing mode based on browser capabilities.
 * @returns {'device'|'server'} Processing mode
 */
export function getProcessingMode() {
  return supportsClientProcessing() ? 'device' : 'server';
}
```

Notes:
- Use 'device' not 'client' to match the UI terminology from the requirements ("Process on device" vs "Send to server")
- The `typeof window === 'undefined'` guard makes it safe to import in Node.js test contexts
- Console warnings use `[capability]` prefix for easy filtering in DevTools
- This module has NO side effects -- it only exports pure detection functions
- The UI layer (Phase 13) will call these functions to determine which mode toggle options to enable

Do NOT wire this into any existing views yet -- that happens in Phase 13 (Upload View Integration).
  </action>
  <verify>
Verify the module exists and is syntactically valid:
- `cat lib/capability-detection.js` -- file should exist with both exports
- In deployed browser console: `import('/lib/capability-detection.js').then(m => console.log(m.getProcessingMode()))` -- should log 'device' if COOP/COEP headers are active, 'server' otherwise
  </verify>
  <done>`lib/capability-detection.js` exists with `supportsClientProcessing()` and `getProcessingMode()` exports. Detection correctly returns true/device when COOP/COEP active, false/server when not.</done>
</task>

</tasks>

<verification>
1. `_headers` file contains COOP and COEP header rules under `/*` pattern
2. `lib/capability-detection.js` exports `supportsClientProcessing` and `getProcessingMode`
3. After deployment: `window.crossOriginIsolated === true` in browser console
4. After deployment: `typeof SharedArrayBuffer === "function"` in browser console
5. After deployment: API calls to backend still succeed (CORP header from 10-01 permits cross-origin resource loading)
6. `getProcessingMode()` returns 'device' when isolation active, 'server' when not
</verification>

<success_criteria>
- COOP/COEP headers restored in _headers file
- Capability detection module created with no side effects
- Detection uses window.crossOriginIsolated as primary check
- Processing mode uses 'device'/'server' terminology matching requirements
- No existing functionality broken
</success_criteria>

<output>
After completion, create `.planning/phases/10-foundation-abstraction/10-02-SUMMARY.md`
</output>
