---
phase: 02-memory-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [app.js]
autonomous: true

must_haves:
  truths:
    - "Blob URLs for original and processed videos are revoked when no longer needed"
    - "processedVideos array never exceeds 20 entries"
    - "Oldest processed video resources are cleaned up when evicted from bounded array"
    - "FFmpeg virtual filesystem cleaned between operations (existing behavior maintained)"
  artifacts:
    - path: "app.js"
      provides: "BlobURLRegistry class, bounded processedVideos with eviction, blob URL revocation at lifecycle points"
      contains: "class BlobURLRegistry"
  key_links:
    - from: "BlobURLRegistry"
      to: "handleFile()"
      via: "register() for originalURL, revoke old originalURL before new upload"
      pattern: "blobRegistry\\.register"
    - from: "BlobURLRegistry"
      to: "processVideo()"
      via: "register() for processedURL"
      pattern: "blobRegistry\\.register"
    - from: "processedVideos eviction"
      to: "BlobURLRegistry"
      via: "onEvict callback revokes evicted video's blob URL"
      pattern: "blobRegistry\\.revoke"
---

<objective>
Implement blob URL lifecycle management and bounded processedVideos array to eliminate memory leaks from unreleased blob URLs and unbounded array growth.

Purpose: Prevent linear memory growth with each processed video, which would cause browser crashes during batch operations in Phase 4.
Output: app.js with BlobURLRegistry class, blob URL revocation at all lifecycle points, and processedVideos capped at 20 entries with automatic eviction cleanup.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-memory-management/02-RESEARCH.md
@app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BlobURLRegistry class and wire blob URL revocation into handleFile and processVideo</name>
  <files>app.js</files>
  <action>
Add a BlobURLRegistry class near the top of app.js (after the imports and utility functions, before the FFmpeg variables around line 15).

The class must have:
- `urls` Map property (URL string -> metadata object with `created` timestamp)
- `register(blob, metadata)` method: calls `URL.createObjectURL(blob)`, stores in map with metadata + created timestamp, returns URL string
- `revoke(url)` method: calls `URL.revokeObjectURL(url)` if URL exists in map, then deletes from map
- `revokeAll()` method: iterates all URLs, calls `URL.revokeObjectURL()` on each, then clears map

Instantiate a singleton: `const blobRegistry = new BlobURLRegistry();`

Wire into existing code:

1. **handleFile() — line 319 area** (`const originalURL = URL.createObjectURL(file)`):
   - Before creating the new originalURL, revoke the previous one if it exists. Track it in a module-level variable `let currentOriginalURL = null;`
   - Replace `URL.createObjectURL(file)` with `blobRegistry.register(file, { type: 'original' })`
   - Store result in `currentOriginalURL`
   - Before registering new one: `if (currentOriginalURL) { blobRegistry.revoke(currentOriginalURL); }`

2. **processVideo() — line 483 area** (`const processedURL = URL.createObjectURL(blob)`):
   - Replace `URL.createObjectURL(blob)` with `blobRegistry.register(blob, { type: 'processed' })`

3. **Add beforeunload handler** as safety net (after the BlobURLRegistry instantiation):
   `window.addEventListener('beforeunload', () => blobRegistry.revokeAll());`

Do NOT revoke processedURLs immediately — they are needed for the video list display. They will be revoked via eviction in Task 2.
  </action>
  <verify>
Search app.js for raw `URL.createObjectURL` calls — should find ZERO (all replaced with blobRegistry.register). Search for `class BlobURLRegistry` — should find exactly one. Search for `currentOriginalURL` — should find declaration and usage in handleFile.
  </verify>
  <done>
All blob URL creation goes through BlobURLRegistry. Old original video blob URL is revoked when user uploads a new video. beforeunload handler revokes all remaining blob URLs on page close.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement bounded processedVideos array with eviction and blob URL cleanup</name>
  <files>app.js</files>
  <action>
Replace the plain `let processedVideos = [];` array (line 121) with a bounded array that has eviction logic.

Implementation approach — keep it simple, no separate class needed:

1. Add a constant: `const MAX_PROCESSED_VIDEOS = 20;`

2. Create a function `addProcessedVideo(videoInfo)` that:
   - Pushes videoInfo to processedVideos array
   - If `processedVideos.length > MAX_PROCESSED_VIDEOS`:
     - `const evicted = processedVideos.shift();` (remove oldest)
     - `blobRegistry.revoke(evicted.processedURL);` (revoke evicted blob URL)
     - Log: `console.log('Evicted oldest processed video, revoked blob URL');`
   - Calls `updateProcessedVideosList()`

3. In processVideo() (around line 501), replace:
   `processedVideos.push(processedVideoInfo);`
   with:
   `addProcessedVideo(processedVideoInfo);`

4. Remove the separate `updateProcessedVideosList()` call on line 504 since addProcessedVideo already calls it.

5. Keep `processedVideos` as a plain array (`let processedVideos = [];`). The bounding logic lives in `addProcessedVideo()`. This keeps the rest of the codebase (updateProcessedVideosList, downloadProcessedVideo) working without changes — they read from processedVideos directly.
  </action>
  <verify>
Search app.js for direct `processedVideos.push(` — should find ZERO (replaced with addProcessedVideo call). Search for `MAX_PROCESSED_VIDEOS` — should find the constant. Search for `addProcessedVideo` — should find the function definition and its call in processVideo.
  </verify>
  <done>
processedVideos array capped at 20 entries. When a 21st video is added, the oldest entry is evicted and its processed blob URL is revoked through the registry. No unbounded memory growth from stored video references.
  </done>
</task>

</tasks>

<verification>
After both tasks:
1. `grep -c 'URL.createObjectURL' app.js` should return 0 (all replaced with blobRegistry.register)
2. `grep -c 'processedVideos.push' app.js` should return 0 (replaced with addProcessedVideo)
3. `grep -c 'class BlobURLRegistry' app.js` should return 1
4. `grep -c 'MAX_PROCESSED_VIDEOS' app.js` should return at least 1
5. `grep -c 'blobRegistry.revoke' app.js` should return at least 2 (eviction + originalURL cleanup)
6. `grep -c 'beforeunload' app.js` should return 1
</verification>

<success_criteria>
- All blob URL creation centralized through BlobURLRegistry (zero raw createObjectURL calls)
- Old original video blob URL revoked when new video uploaded
- processedVideos bounded at 20 with oldest-eviction and blob URL cleanup
- FFmpeg filesystem cleanup maintained (existing try-finally pattern untouched)
- beforeunload safety net revokes all remaining blob URLs
</success_criteria>

<output>
After completion, create `.planning/phases/02-memory-management/02-01-SUMMARY.md`
</output>
