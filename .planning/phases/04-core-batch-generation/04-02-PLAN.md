---
phase: 04-core-batch-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified: [index.html, app.js]
autonomous: false

must_haves:
  truths:
    - "User can specify variation count via number input (1-20 range with validation)"
    - "UI displays per-variation progress: Processing variation 3/10... with progress bar"
    - "User can cancel batch processing mid-operation and partial work stops cleanly"
    - "First completed variation displays in preview area for quality check"
    - "All processed variations appear in processed videos list"
  artifacts:
    - path: "index.html"
      provides: "Batch controls UI: variation count input, generate button, cancel button"
      contains: "variationCount"
    - path: "app.js"
      provides: "generateBatch orchestrator, cancellation flag, batch progress, UI wiring"
      contains: "generateBatch"
  key_links:
    - from: "index.html #generateBtn"
      to: "app.js generateBatch()"
      via: "click event listener"
      pattern: "generateBtn.*addEventListener.*click"
    - from: "index.html #cancelBtn"
      to: "app.js batchCancelled"
      via: "click event listener sets flag"
      pattern: "cancelBtn.*addEventListener.*click"
    - from: "app.js generateBatch()"
      to: "app.js processVideo()"
      via: "sequential loop with effects and variationIndex"
      pattern: "processVideo.*preloadedBuffer.*effects\\[i\\]"
    - from: "app.js generateBatch()"
      to: "app.js generateUniqueEffects()"
      via: "generates effect combinations before loop"
      pattern: "generateUniqueEffects.*variationCount"
    - from: "app.js generateBatch() first variation"
      to: "processedVideo element"
      via: "set video src to first result URL"
      pattern: "processedVideo\\.src.*result.*url"
---

<objective>
Build the batch UI controls, generateBatch() orchestrator with cancellation, wire everything together, and verify the complete batch generation workflow end-to-end.

Purpose: This plan turns the logic foundations from Plan 01 into a working feature. The user will be able to specify how many variations they want, click Generate, see progress, cancel if needed, and preview results.
Output: Working batch generation feature with UI controls in index.html and orchestration logic in app.js.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-core-batch-generation/04-RESEARCH.md
@.planning/phases/04-core-batch-generation/04-01-SUMMARY.md
@app.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add batch controls to index.html and implement generateBatch() orchestrator with cancellation in app.js</name>
  <files>index.html, app.js</files>
  <action>
**index.html changes:**

Add a batch controls section AFTER the upload section div (after the closing `</div>` of `<div class="upload-section">`) and BEFORE the queue section. This new section should be hidden by default and shown when a video is uploaded:

```html
<div class="batch-section" id="batchSection" style="display: none;">
    <h3>Batch Generation</h3>
    <div class="batch-controls">
        <label for="variationCount">Number of variations:</label>
        <input type="number" id="variationCount" min="1" max="20" value="5" class="variation-input">
        <button id="generateBtn" class="generate-btn">Generate Variations</button>
        <button id="cancelBtn" class="cancel-btn" style="display: none;">Cancel</button>
    </div>
    <div class="batch-progress" id="batchProgress" style="display: none;">
        <p id="batchProgressText">Processing variation 1/5...</p>
    </div>
</div>
```

Key HTML details:
- Input type="number" with min="1" max="20" value="5" — browser-enforced range
- id="variationCount" for the number input
- id="generateBtn" for the generate button
- id="cancelBtn" for the cancel button (hidden by default, shown during processing)
- id="batchProgress" container for batch-level progress text
- id="batchProgressText" for the "Processing variation 3/10..." text

**app.js changes:**

1. Add module-level cancellation flag near the top (after `let currentOriginalURL = null;`):
   ```javascript
   let batchCancelled = false;
   let isBatchProcessing = false;
   ```

2. Add `generateBatch(file, variationCount)` function after `processVideo()` and before `updateProcessedVideosList()`:

```javascript
async function generateBatch(file, variationCount) {
    console.log(`Starting batch generation: ${variationCount} variations`);

    // Validate range
    if (variationCount < 1 || variationCount > 20) {
        throw new Error('Variation count must be between 1 and 20');
    }

    // Reset cancellation
    batchCancelled = false;
    isBatchProcessing = true;

    // Show cancel button, disable generate button
    const cancelBtn = document.getElementById('cancelBtn');
    const generateBtn = document.getElementById('generateBtn');
    const batchProgress = document.getElementById('batchProgress');
    const batchProgressText = document.getElementById('batchProgressText');

    if (cancelBtn) cancelBtn.style.display = 'inline-block';
    if (generateBtn) generateBtn.disabled = true;
    if (batchProgress) batchProgress.style.display = 'block';

    // Load buffer once (Phase 3 infrastructure)
    const buffer = await loadVideoBuffer(file);

    // Write to MEMFS once
    await loadFFmpeg();
    await ffmpeg.writeFile('input.mp4', buffer);

    // Generate unique effect combinations
    const effects = generateUniqueEffects(variationCount);

    const results = [];
    const batchStartTime = performance.now();

    for (let i = 0; i < variationCount; i++) {
        // Check cancellation before each variation
        if (batchCancelled) {
            console.log(`Batch cancelled after ${i} variations`);
            break;
        }

        // Update batch progress text: "Processing variation 3/10..."
        const current = i + 1;
        if (batchProgressText) {
            batchProgressText.textContent = `Processing variation ${current}/${variationCount}...`;
        }
        updateProgress(0, `Processing variation ${current}/${variationCount}...`);

        // Process variation
        const variationIndex = i + 1; // 1-based
        const isLastVariation = (i === variationCount - 1) || batchCancelled;

        try {
            const result = await processVideo(
                file,
                buffer,                    // preloadedBuffer: reuse buffer
                isLastVariation,           // cleanupInput: only on last
                effects[i],                // unique effect parameters
                variationIndex             // for filename
            );

            results.push(result);

            // Display first variation immediately in preview
            if (i === 0) {
                const processedVideo = document.getElementById('processedVideo');
                if (processedVideo) {
                    processedVideo.src = result.url;
                    processedVideo.style.display = 'block';
                }
                const processingStatus = document.getElementById('processingStatus');
                if (processingStatus) {
                    processingStatus.textContent = 'First variation ready! Continuing batch...';
                    processingStatus.style.display = 'flex';
                }
            }

        } catch (error) {
            console.error(`Variation ${variationIndex} failed:`, error);
            // Continue with next variation, preserve partial results
        }
    }

    // Batch complete — cleanup MEMFS if cancelled early (input might still be there)
    if (batchCancelled && results.length < variationCount) {
        try {
            await ffmpeg.deleteFile('input.mp4');
        } catch (e) {
            console.warn('Cleanup after cancel:', e);
        }
    }

    const batchEndTime = performance.now();
    const batchTimeSeconds = ((batchEndTime - batchStartTime) / 1000).toFixed(2);

    console.log(`Batch complete: ${results.length}/${variationCount} variations in ${batchTimeSeconds}s`);

    // Update UI to show completion
    isBatchProcessing = false;
    if (cancelBtn) cancelBtn.style.display = 'none';
    if (generateBtn) generateBtn.disabled = false;

    const completionText = batchCancelled
        ? `Batch cancelled: ${results.length}/${variationCount} variations completed in ${batchTimeSeconds}s`
        : `Batch complete: ${results.length} variations in ${batchTimeSeconds}s`;

    if (batchProgressText) {
        batchProgressText.textContent = completionText;
    }
    updateProgress(100, completionText);

    return results;
}
```

3. Add event listener wiring inside `initializeUploadHandlers()` — at the end of the function, before the console.log('Upload handlers initialized') line, add:

```javascript
// Batch generation controls
const generateBtn = document.getElementById('generateBtn');
const cancelBtn = document.getElementById('cancelBtn');

if (generateBtn) {
    generateBtn.addEventListener('click', async () => {
        const variationCountInput = document.getElementById('variationCount');
        const count = parseInt(variationCountInput.value, 10);

        // Validate
        if (isNaN(count) || count < 1 || count > 20) {
            alert('Please enter a number between 1 and 20.');
            return;
        }

        // Need a file to process
        if (!currentFile) {
            alert('Please upload a video first.');
            return;
        }

        try {
            await generateBatch(currentFile, count);
        } catch (error) {
            console.error('Batch generation failed:', error);
            const processingStatus = document.getElementById('processingStatus');
            if (processingStatus) {
                processingStatus.textContent = `Batch error: ${error.message}`;
                processingStatus.style.display = 'flex';
            }
        }
    });
}

if (cancelBtn) {
    cancelBtn.addEventListener('click', () => {
        batchCancelled = true;
        const batchProgressText = document.getElementById('batchProgressText');
        if (batchProgressText) {
            batchProgressText.textContent = 'Cancelling... Current variation will complete.';
        }
        updateProgress(0, 'Cancelling... Current variation will complete.');
    });
}
```

4. Add a module-level `currentFile` variable to store the last uploaded file. Near the top where `currentOriginalURL` is declared, add:
   ```javascript
   let currentFile = null;
   ```

5. In the `handleFile()` function, after the line `const originalURL = blobRegistry.register(file, { type: 'original' });` (around line 403), add:
   ```javascript
   currentFile = file;
   ```

6. Also in `handleFile()`, after showing the preview section (`previewSection.style.display = 'grid';`), add:
   ```javascript
   // Show batch controls when video is uploaded
   const batchSection = document.getElementById('batchSection');
   if (batchSection) batchSection.style.display = 'block';
   ```

IMPORTANT constraints:
- The existing single-file processVideo() call in handleFile() MUST remain — when user uploads, it still processes once immediately with default effects. The batch feature is additive (user clicks Generate after seeing the first result).
- Do NOT remove or modify the existing file queue processing logic.
- The cancel button only stops BETWEEN variations — the current variation must finish. Make this clear in the cancel feedback text.
- Use the existing progress bar (progressBar/progressText) for per-variation FFmpeg progress. The batchProgressText shows batch-level progress ("Processing variation 3/10...").
  </action>
  <verify>
1. Verify index.html has batch section: search for "batchSection" and "variationCount" and "generateBtn" and "cancelBtn"
2. Verify app.js has generateBatch: search for "async function generateBatch"
3. Verify cancellation flag: search for "batchCancelled" — should appear in module scope and in generateBatch and in cancel handler
4. Verify currentFile tracking: search for "currentFile = file" in handleFile
5. Verify event listeners: search for "generateBtn.*addEventListener" and "cancelBtn.*addEventListener"
6. Verify first variation preview: search for "processedVideo.src = result.url" within generateBatch
7. Run dev server, load page — batch controls should be hidden initially
8. Upload a video — batch section should appear with number input, generate button
9. Run `npm run build` or equivalent if build step exists (this project has none — static files)
  </verify>
  <done>
Batch controls visible after video upload. generateBatch() orchestrator processes N variations sequentially with buffer reuse and cancellation support. Cancel button appears during processing. First variation shows in preview. Batch progress text updates per variation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add minimal CSS for batch controls</name>
  <files>index.html</files>
  <action>
Add inline styles or a style block for the batch controls. Since the project uses an external styles.css, check if styles.css exists and add styles there. If not, add a small style block in the head of index.html.

Check for styles.css first. If it exists, add styles to it. If not, add to index.html head.

Required styles (keep them minimal and consistent with existing UI):

```css
/* Batch generation controls */
.batch-section {
    margin: 1.5rem 0;
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}

.batch-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.batch-controls label {
    font-weight: 500;
    color: #495057;
}

.variation-input {
    width: 80px;
    padding: 0.5rem;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 1rem;
    text-align: center;
}

.generate-btn {
    padding: 0.5rem 1.5rem;
    background: #28a745;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}

.generate-btn:hover {
    background: #218838;
}

.generate-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
}

.cancel-btn {
    padding: 0.5rem 1.5rem;
    background: #dc3545;
    color: white;
    border: none;
    border-radius: 4px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.2s;
}

.cancel-btn:hover {
    background: #c82333;
}

.batch-progress {
    margin-top: 1rem;
    padding: 0.75rem;
    background: #e9ecef;
    border-radius: 4px;
    font-size: 0.95rem;
    color: #495057;
}
```

These styles use the same color palette and spacing conventions as the existing UI (green for primary action, red for cancel/destructive).
  </action>
  <verify>
1. Check that batch control styles exist (either in styles.css or index.html)
2. Load page in browser — batch section should look visually consistent with rest of UI
3. Variation input should be a compact number field
4. Generate button should be green, cancel button should be red
5. Disabled generate button should be gray
  </verify>
  <done>
Batch controls styled consistently with existing UI. Green generate button, red cancel button, clean layout with flexbox wrapping for responsiveness.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete batch generation workflow</name>
  <what-built>Complete batch generation feature: variation count input (1-20), unique effect combinations per variation, batch progress tracking, cancellation support, first variation preview, and variation naming pattern.</what-built>
  <how-to-verify>
1. Start dev server: `python3 -m http.server 8080` from project root
2. Open http://localhost:8080 in Chrome (ensure COOP/COEP headers if needed, or use the Cloudflare dev setup)
3. Upload a short MP4 video (under 10MB for quick testing)
4. After initial processing completes, you should see a "Batch Generation" section with:
   - Number input (default 5, range 1-20)
   - Green "Generate Variations" button
5. Set variation count to 3 and click "Generate Variations"
6. Verify:
   - Batch progress text shows "Processing variation 1/3...", then "2/3...", then "3/3..."
   - Progress bar resets for each variation (per-variation FFmpeg progress)
   - Cancel button appears during processing
   - First completed variation appears in preview area
   - All 3 variations appear in "All Processed Videos" list
   - Filenames follow pattern: originalname_var1_XXXXXX.mp4, originalname_var2_XXXXXX.mp4, etc.
   - Console shows "Generated 3 unique effect combinations in N attempts"
   - Console shows "Batch complete: 3/3 variations in X.XXs"
7. Test cancellation: Set count to 5, click Generate, then click Cancel after 1-2 variations complete
   - Verify: "Cancelling... Current variation will complete." message appears
   - Verify: Processing stops after current variation finishes
   - Verify: Partial results are preserved in processed videos list
8. Test validation: Try entering 0 or 25 in the number input — should show alert
9. Test the original workflow still works: Upload a new video — it should process normally with default effects before showing batch controls
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. Batch section visible after video upload with number input (1-20), generate button, cancel button
2. Generate 3 variations — all complete with unique effects, correct filenames, progress tracking
3. Cancel mid-batch — stops cleanly, partial results preserved
4. First variation displays in preview immediately after completion
5. All variations appear in processed videos list with download buttons
6. Original single-video workflow still works unchanged
7. No memory leaks (blob URLs managed by existing BlobURLRegistry + eviction)
</verification>

<success_criteria>
- BATCH-01: Number input with 1-20 range validation works
- BATCH-02: Each variation has unique effect combo (console shows generation stats)
- BATCH-03: Cancel stops batch between variations, preserves partial results
- BATCH-04: Filenames follow originalname_var{N}_{hexID}.mp4 pattern
- PROG-01: "Processing variation 3/10..." text updates per variation, progress bar tracks FFmpeg progress
- PROG-02: First completed variation displays in preview area
</success_criteria>

<output>
After completion, create `.planning/phases/04-core-batch-generation/04-02-SUMMARY.md`
</output>
