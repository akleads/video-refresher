---
phase: 01-ffmpeg-wasm-upgrade
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - app.js
autonomous: false

must_haves:
  truths:
    - "User can upload a video and it processes successfully with FFmpeg 0.12.x"
    - "Processed video plays correctly in the browser preview"
    - "Download button produces a valid MP4 file"
    - "Progress bar updates during processing"
    - "FFmpeg filesystem is cleaned up after processing"
    - "Error messages display when processing fails"
  artifacts:
    - path: "app.js"
      provides: "Async file system operations for 0.12.x"
      contains: "await ffmpeg.writeFile"
    - path: "app.js"
      provides: "New exec() command execution"
      contains: "await ffmpeg.exec(["
    - path: "app.js"
      provides: "Async file reading"
      contains: "await ffmpeg.readFile"
    - path: "app.js"
      provides: "Async file cleanup"
      contains: "await ffmpeg.deleteFile"
  key_links:
    - from: "app.js processVideo()"
      to: "ffmpeg.writeFile"
      via: "async file write replacing sync FS('writeFile')"
      pattern: "await ffmpeg\\.writeFile\\("
    - from: "app.js processVideo()"
      to: "ffmpeg.exec"
      via: "command execution replacing ffmpeg.run"
      pattern: "await ffmpeg\\.exec\\(\\["
    - from: "app.js processVideo()"
      to: "ffmpeg.readFile"
      via: "async file read replacing sync FS('readFile')"
      pattern: "await ffmpeg\\.readFile\\("
    - from: "app.js processVideo()"
      to: "ffmpeg.deleteFile"
      via: "async cleanup replacing sync FS('unlink')"
      pattern: "await ffmpeg\\.deleteFile\\("
---

<objective>
Migrate the processVideo() function from FFmpeg.wasm 0.11.x API to 0.12.x async API, completing the full upgrade.

Purpose: Plan 01 established the new FFmpeg 0.12.x instance and loading. processVideo() still uses old 0.11.x calls (ffmpeg.FS, ffmpeg.run) which will crash with the new instance. This plan completes the migration so the full video processing pipeline works end-to-end.

Output: Fully working app.js where users can upload, process, preview, and download videos using FFmpeg.wasm 0.12.x.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ffmpeg-wasm-upgrade/01-RESEARCH.md
@.planning/phases/01-ffmpeg-wasm-upgrade/01-01-SUMMARY.md
@app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate processVideo() to 0.12.x async API</name>
  <files>app.js</files>
  <action>
Migrate the `processVideo()` function in app.js to use FFmpeg.wasm 0.12.x API. This function was left unchanged by Plan 01 and still uses old 0.11.x patterns that are incompatible with the new FFmpeg instance.

**There are exactly 4 API changes needed in processVideo().** Do NOT change any other function in the file — only processVideo().

**Change 1: writeFile (around original line 350)**

Replace:
```javascript
ffmpeg.FS('writeFile', inputFileName, uint8Array);
```

With:
```javascript
await ffmpeg.writeFile(inputFileName, uint8Array);
```

Why: All FS operations are async in 0.12.x. The old synchronous FS() method no longer exists.

**Change 2: run() to exec() (around original line 405)**

Replace:
```javascript
await ffmpeg.run(
    '-i', inputFileName,
    '-vf', 'rotate=0.00349,eq=brightness=0.01:contrast=1.01:saturation=1.01',
    '-r', '29.97',
    ...encodingSettings,
    '-map_metadata', '-1',
    '-threads', '4',
    '-pix_fmt', 'yuv420p',
    '-movflags', '+faststart',
    outputFileName
);
```

With:
```javascript
await ffmpeg.exec([
    '-i', inputFileName,
    '-vf', 'rotate=0.00349,eq=brightness=0.01:contrast=1.01:saturation=1.01',
    '-r', '29.97',
    ...encodingSettings,
    '-map_metadata', '-1',
    '-threads', '4',
    '-pix_fmt', 'yuv420p',
    '-movflags', '+faststart',
    outputFileName
]);
```

Why: 0.12.x renamed `run(...args)` to `exec([args])` — arguments are now passed as a single array instead of spread arguments.

**Change 3: readFile (around original line 435)**

Replace:
```javascript
const data = ffmpeg.FS('readFile', outputFileName);
```

With:
```javascript
const data = await ffmpeg.readFile(outputFileName);
```

Why: readFile is now async in 0.12.x and returns a Uint8Array directly.

**Change 4: deleteFile cleanup (around original lines 466-469)**

Replace:
```javascript
try {
    ffmpeg.FS('unlink', inputFileName);
    ffmpeg.FS('unlink', outputFileName);
} catch (e) {
    console.warn('Cleanup warning:', e);
}
```

With:
```javascript
try {
    await ffmpeg.deleteFile(inputFileName);
    await ffmpeg.deleteFile(outputFileName);
} catch (e) {
    console.warn('Cleanup warning:', e);
}
```

Why: `FS('unlink', ...)` replaced by `deleteFile()` which is async in 0.12.x.

**IMPORTANT constraints:**
- Do NOT change the encoding settings (bitrate, preset, crf values) — those are FFmpeg CLI args, not API calls
- Do NOT change the Blob creation: `new Blob([data.buffer], { type: 'video/mp4' })` — readFile in 0.12.x still returns Uint8Array with a .buffer property
- Do NOT change any other function (loadFFmpeg, handleFile, updateProgress, queue functions, etc.)
- Do NOT modify how the output filename is generated
- Do NOT modify the error handling logic (OOM checks, abort checks) — those check error.message strings which remain the same
- Do NOT modify DOM manipulation code
  </action>
  <verify>
1. Read app.js and confirm processVideo() contains:
   - `await ffmpeg.writeFile(inputFileName, uint8Array)` (not `ffmpeg.FS('writeFile', ...)`)
   - `await ffmpeg.exec([...])` (not `await ffmpeg.run(...)`)
   - `await ffmpeg.readFile(outputFileName)` (not `ffmpeg.FS('readFile', ...)`)
   - `await ffmpeg.deleteFile(inputFileName)` and `await ffmpeg.deleteFile(outputFileName)` (not `ffmpeg.FS('unlink', ...)`)

2. Confirm NO old 0.11.x patterns remain anywhere in app.js:
   - Search for `createFFmpeg` — should find 0 matches
   - Search for `ffmpeg.FS(` — should find 0 matches
   - Search for `ffmpeg.run(` — should find 0 matches
   - Search for `esm.sh` — should find 0 matches
   - Search for `0.11` — should find 0 matches

3. Confirm encoding settings are unchanged (bitrate values, preset names, crf values)
4. Confirm Blob creation line is unchanged
  </verify>
  <done>
processVideo() fully migrated to 0.12.x API: writeFile (async), exec (array args), readFile (async), deleteFile (async). No old 0.11.x API calls remain anywhere in app.js. Encoding settings, error handling, DOM manipulation, and all other functions remain unchanged.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete FFmpeg.wasm 0.11.6 to 0.12.x migration — imports, initialization with SharedArrayBuffer detection, multi-threaded/single-threaded fallback, and full processVideo() API migration.</what-built>
  <how-to-verify>
1. Start the dev server: `python3 server.py` from the project root
2. Open http://localhost:8000 in Chrome (Chrome has best SharedArrayBuffer support)
3. Open browser DevTools Console (F12 or Cmd+Option+I)
4. Upload a small MP4 file (under 10MB for quick testing)
5. Watch the console for:
   - "Creating FFmpeg instance..." log
   - "Loading FFmpeg (multi-threaded)..." OR "Loading FFmpeg (single-threaded)..." log
   - "FFmpeg loaded successfully (multi-threaded)" OR "FFmpeg loaded successfully (single-threaded)" log
   - "FFmpeg progress: XX%" logs during processing
   - "FFmpeg processing completed" log
6. Verify the progress bar updates during processing
7. Verify the processed video appears in the preview and plays correctly
8. Click the Download button and verify the downloaded file is a valid MP4
9. Check console for no errors (especially no "ffmpeg.FS is not a function" or "ffmpeg.run is not a function")
10. OPTIONAL: Check `crossOriginIsolated` in console — should be `true` with server.py

If multi-threading is working, the console will show "Loading FFmpeg (multi-threaded)..."
If it falls back, it will show the fallback message — this is also acceptable.
  </how-to-verify>
  <resume-signal>Type "approved" if video processes correctly, or describe any issues you see.</resume-signal>
</task>

</tasks>

<verification>
1. Full app.js uses ONLY 0.12.x API patterns — no 0.11.x remnants
2. Video upload -> process -> preview -> download works end-to-end
3. Console shows FFmpeg loading with correct core type (multi-threaded or single-threaded)
4. Progress bar updates during processing
5. No JavaScript errors in console during full processing cycle
</verification>

<success_criteria>
- Zero instances of old 0.11.x API calls in app.js (no createFFmpeg, no ffmpeg.FS, no ffmpeg.run, no esm.sh import)
- User can upload an MP4, process it, see the preview, and download the result
- Console confirms FFmpeg 0.12.x loaded (multi-threaded or single-threaded with fallback)
- Progress bar shows processing progress
- Processed video is a valid playable MP4 file
</success_criteria>

<output>
After completion, create `.planning/phases/01-ffmpeg-wasm-upgrade/01-02-SUMMARY.md`
</output>
