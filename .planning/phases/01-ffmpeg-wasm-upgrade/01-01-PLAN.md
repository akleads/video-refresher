---
phase: 01-ffmpeg-wasm-upgrade
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - app.js
  - _headers
autonomous: true

must_haves:
  truths:
    - "FFmpeg.wasm 0.12.x loads successfully in the browser"
    - "Multi-threaded core loads when SharedArrayBuffer is available"
    - "Single-threaded fallback loads when SharedArrayBuffer is unavailable"
    - "COOP/COEP headers are correctly configured for both dev server and Cloudflare Pages"
    - "Progress events fire during FFmpeg operations"
  artifacts:
    - path: "app.js"
      provides: "FFmpeg 0.12.x initialization with SharedArrayBuffer detection"
      contains: "new FFmpeg()"
    - path: "app.js"
      provides: "Event-based progress tracking"
      contains: "ffmpeg.on('progress'"
    - path: "app.js"
      provides: "CDN loading via toBlobURL"
      contains: "toBlobURL"
    - path: "_headers"
      provides: "COOP/COEP headers for Cloudflare Pages"
      contains: "Cross-Origin-Opener-Policy"
  key_links:
    - from: "app.js"
      to: "https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.14/+esm"
      via: "ES module import"
      pattern: "import.*FFmpeg.*@ffmpeg/ffmpeg"
    - from: "app.js"
      to: "https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.2/+esm"
      via: "ES module import"
      pattern: "import.*toBlobURL.*@ffmpeg/util"
    - from: "app.js loadFFmpeg()"
      to: "https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.10/dist/esm"
      via: "toBlobURL for CORS bypass"
      pattern: "core-mt@0\\.12\\.10"
    - from: "app.js loadFFmpeg()"
      to: "https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.12.10/dist/esm"
      via: "toBlobURL fallback for no SharedArrayBuffer"
      pattern: "core-st@0\\.12\\.10"
---

<objective>
Rewrite FFmpeg.wasm initialization from 0.11.6 to 0.12.x with multi-threading support and automatic single-threaded fallback.

Purpose: The existing 0.11.x API (createFFmpeg, sync FS, callback progress) is completely incompatible with 0.12.x. This plan establishes the new FFmpeg instance, CDN loading via toBlobURL, SharedArrayBuffer detection, and event-based progress — the foundation that all video processing depends on.

Output: Updated app.js with working 0.12.x initialization and verified _headers file for COOP/COEP.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-ffmpeg-wasm-upgrade/01-RESEARCH.md
@app.js
@_headers
@server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify and update COOP/COEP headers</name>
  <files>_headers</files>
  <action>
Read the existing `_headers` file. It should contain COOP/COEP headers for SharedArrayBuffer support.

Verify it has EXACTLY this content (the `/*` route applies headers to all pages):
```
/*
  Cross-Origin-Opener-Policy: same-origin
  Cross-Origin-Embedder-Policy: require-corp
```

The existing file already has this content. Confirm it is correct and does NOT need changes.

Also verify `server.py` already sends these headers for local dev (it does — `Cross-Origin-Opener-Policy: same-origin` and `Cross-Origin-Embedder-Policy: require-corp`). No changes needed to server.py.

If _headers is correct, no file write needed. If it's missing headers or has incorrect values, update it.
  </action>
  <verify>
Read `_headers` file and confirm it contains `Cross-Origin-Opener-Policy: same-origin` and `Cross-Origin-Embedder-Policy: require-corp` under the `/*` route.
Read `server.py` and confirm it sends the same two headers.
  </verify>
  <done>
_headers file has correct COOP/COEP headers for Cloudflare Pages deployment. server.py has matching headers for local development. Both files verified as correct for SharedArrayBuffer support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite FFmpeg imports and initialization for 0.12.x</name>
  <files>app.js</files>
  <action>
Rewrite the top section of app.js (lines 1-57) to use FFmpeg.wasm 0.12.x API. Keep ALL other code (lines 58-523) EXACTLY as-is for now — Plan 02 will migrate processVideo().

**Step 1: Replace imports (line 1-3)**

Remove:
```javascript
import { createFFmpeg, fetchFile } from 'https://esm.sh/@ffmpeg/ffmpeg@0.11.6';
```

Replace with:
```javascript
import { FFmpeg } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.14/+esm';
import { fetchFile, toBlobURL } from 'https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.2/+esm';
```

Why jsdelivr not esm.sh: Research confirmed jsdelivr is proven in official 0.12.x docs. esm.sh compatibility with 0.12.x worker files is unclear.

**Step 2: Add SharedArrayBuffer detection function (after imports, before ffmpeg vars)**

```javascript
function supportsMultiThreading() {
    return typeof SharedArrayBuffer !== 'undefined' && crossOriginIsolated === true;
}
```

Why check BOTH conditions: SharedArrayBuffer may exist as a global but be disabled without COOP/COEP headers. `crossOriginIsolated` confirms the headers are active.

**Step 3: Add a variable to track multi-threading status**

After the existing `let ffmpegLoaded = false;` line, add:
```javascript
let isMultiThreaded = false;
```

**Step 4: Rewrite loadFFmpeg() function entirely**

Replace the entire loadFFmpeg() function (lines 18-57) with:

```javascript
async function loadFFmpeg() {
    if (ffmpegLoaded) {
        console.log('FFmpeg already loaded');
        return;
    }

    const statusText = document.getElementById('processingStatus');
    if (statusText) {
        statusText.textContent = 'Loading FFmpeg... This may take a moment.';
    }

    try {
        console.log('Creating FFmpeg instance...');
        ffmpeg = new FFmpeg();

        // Event-based progress (replaces callback in 0.11.x)
        ffmpeg.on('progress', ({ progress, time }) => {
            // Clamp progress to 0-1 range (known bug: can return negative values)
            const clampedProgress = Math.max(0, Math.min(1, progress));
            const progressPercent = Math.round(clampedProgress * 100);
            console.log('FFmpeg progress:', progressPercent + '%');
            updateProgress(progressPercent, `Processing... ${progressPercent}%`);
        });

        ffmpeg.on('log', ({ message }) => {
            console.log('FFmpeg:', message);
        });

        // Detect SharedArrayBuffer support for multi-threading
        isMultiThreaded = supportsMultiThreading();
        const coreType = isMultiThreaded ? 'multi-threaded' : 'single-threaded';
        console.log(`Loading FFmpeg (${coreType})...`);

        const baseURL = isMultiThreaded
            ? 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-mt@0.12.10/dist/esm'
            : 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.12.10/dist/esm';

        const loadConfig = {
            coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
            wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
        };

        // Multi-threaded requires worker file
        if (isMultiThreaded) {
            loadConfig.workerURL = await toBlobURL(`${baseURL}/ffmpeg-core.worker.js`, 'text/javascript');
        }

        console.log('Loading FFmpeg core...');
        await ffmpeg.load(loadConfig);

        ffmpegLoaded = true;
        console.log(`FFmpeg loaded successfully (${coreType})`);
    } catch (error) {
        console.error('Error loading FFmpeg:', error);
        console.error('Error details:', error.message, error.stack);

        // If multi-threaded loading failed, try single-threaded fallback
        if (isMultiThreaded) {
            console.warn('Multi-threaded loading failed, falling back to single-threaded...');
            isMultiThreaded = false;
            try {
                const stBaseURL = 'https://cdn.jsdelivr.net/npm/@ffmpeg/core-st@0.12.10/dist/esm';
                await ffmpeg.load({
                    coreURL: await toBlobURL(`${stBaseURL}/ffmpeg-core.js`, 'text/javascript'),
                    wasmURL: await toBlobURL(`${stBaseURL}/ffmpeg-core.wasm`, 'application/wasm'),
                });
                ffmpegLoaded = true;
                console.log('FFmpeg loaded successfully (single-threaded fallback)');
                return;
            } catch (fallbackError) {
                console.error('Single-threaded fallback also failed:', fallbackError);
            }
        }

        if (statusText) {
            statusText.textContent = `Error loading FFmpeg: ${error.message}. Please refresh the page.`;
        }
        throw error;
    }
}
```

Key changes explained:
- `createFFmpeg({...})` replaced with `new FFmpeg()` — 0.12.x uses class constructor
- Progress callback replaced with `ffmpeg.on('progress', ...)` — event-based in 0.12.x
- Progress values clamped to 0-1 — known bug where 0.12.x can return negative values
- `log: true` replaced with `ffmpeg.on('log', ...)` — event-based logging
- `corePath` replaced with `toBlobURL()` loading — required for CORS bypass from CDN
- SharedArrayBuffer detection added — loads core-mt or core-st package accordingly
- Fallback mechanism — if multi-threaded load fails, automatically retries with single-threaded
- `workerURL` only provided for multi-threaded — single-threaded has no worker

**IMPORTANT: Do NOT modify anything below the loadFFmpeg() function.** Lines 59-523 (updateProgress, queue handling, handleFile, processVideo, updateProcessedVideosList, downloadProcessedVideo) must remain exactly as they are. Plan 02 will handle the processVideo() migration.

Note: After this change, processVideo() will be TEMPORARILY BROKEN because it still uses old 0.11.x API calls (ffmpeg.FS, ffmpeg.run). This is expected — Plan 02 fixes it. The goal of this plan is to get FFmpeg 0.12.x loading correctly.
  </action>
  <verify>
1. Read app.js and confirm:
   - Line 1 imports FFmpeg from `@ffmpeg/ffmpeg@0.12.14`
   - Line 2 imports fetchFile and toBlobURL from `@ffmpeg/util@0.12.2`
   - `supportsMultiThreading()` function exists
   - `new FFmpeg()` used (not createFFmpeg)
   - `ffmpeg.on('progress', ...)` used (not callback)
   - `ffmpeg.on('log', ...)` used (not log: true)
   - `toBlobURL()` used for CDN loading
   - SharedArrayBuffer detection with both `typeof SharedArrayBuffer !== 'undefined'` AND `crossOriginIsolated === true`
   - Multi-threaded fallback to single-threaded on failure
   - `isMultiThreaded` variable tracks which mode loaded
   - Progress clamped to 0-1 range
   - core-mt@0.12.10 URL for multi-threaded
   - core-st@0.12.10 URL for single-threaded
   - processVideo() and everything below loadFFmpeg() is UNCHANGED

2. Verify no syntax errors: Check that the file is valid JavaScript (no unclosed brackets, missing semicolons, etc.)
  </verify>
  <done>
app.js imports updated to @ffmpeg/ffmpeg@0.12.14 and @ffmpeg/util@0.12.2 from jsdelivr CDN. loadFFmpeg() completely rewritten with: new FFmpeg() constructor, event-based progress with clamping, event-based logging, toBlobURL CDN loading, SharedArrayBuffer detection for automatic multi-threaded/single-threaded selection, and fallback mechanism if multi-threaded loading fails. The `isMultiThreaded` variable tracks which mode was loaded. All code below loadFFmpeg() remains unchanged (will be migrated in Plan 02).
  </done>
</task>

</tasks>

<verification>
1. Read the complete app.js file and verify the import section and loadFFmpeg() match 0.12.x patterns from the research document
2. Verify _headers file has correct COOP/COEP headers
3. Verify all code after loadFFmpeg() is unchanged from the original
4. Confirm no references to old 0.11.x patterns remain in the initialization section (no createFFmpeg, no corePath, no progress callback in constructor)
</verification>

<success_criteria>
- app.js uses `new FFmpeg()` instead of `createFFmpeg()`
- CDN URLs point to jsdelivr with correct versions (@ffmpeg/ffmpeg@0.12.14, @ffmpeg/util@0.12.2, core-mt@0.12.10, core-st@0.12.10)
- SharedArrayBuffer detection function exists and checks both `typeof SharedArrayBuffer` and `crossOriginIsolated`
- Progress event uses clamping (0-1 range)
- Fallback from multi-threaded to single-threaded is implemented
- _headers file verified correct
- No changes to code below loadFFmpeg() (processVideo still uses old API temporarily)
</success_criteria>

<output>
After completion, create `.planning/phases/01-ffmpeg-wasm-upgrade/01-01-SUMMARY.md`
</output>
