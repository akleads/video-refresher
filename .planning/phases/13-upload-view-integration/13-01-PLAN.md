---
phase: 13-upload-view-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/upload.js
autonomous: true

must_haves:
  truths:
    - "Upload page shows 'Send to server' and 'Process on device' radio buttons above the drop zone"
    - "Server radio is selected by default for first-time users"
    - "Selecting a radio button saves the preference to localStorage immediately"
    - "Returning users see their last choice pre-selected"
    - "When SharedArrayBuffer is unavailable, device radio is disabled with 'Not supported in this browser' text"
    - "If saved preference is device but SharedArrayBuffer unavailable, server is silently selected"
    - "Selecting device mode and submitting navigates to #device-progress with files passed via setDeviceProcessingData()"
    - "Selecting server mode and submitting uploads via FormData and navigates to #job/{jobId}"
    - "Radio buttons are disabled once processing/upload starts"
    - "Files stay selected when switching modes"
  artifacts:
    - path: "views/upload.js"
      provides: "Mode toggle radio buttons, localStorage persistence, mode-aware submit routing"
      contains: "processing-mode"
  key_links:
    - from: "views/upload.js"
      to: "lib/capability-detection.js"
      via: "import supportsClientProcessing"
      pattern: "import.*supportsClientProcessing.*capability-detection"
    - from: "views/upload.js"
      to: "views/device-progress.js"
      via: "import setDeviceProcessingData"
      pattern: "import.*setDeviceProcessingData.*device-progress"
    - from: "views/upload.js"
      to: "localStorage"
      via: "setItem/getItem with namespaced key"
      pattern: "video-refresher\\.processing-mode"
---

<objective>
Add processing mode radio buttons to the upload page with localStorage persistence, capability-based disabling, and mode-aware submit routing.

Purpose: This is the final v3.0 integration piece -- users can now choose between device and server processing from the upload page. Device processing (Phase 11) and server processing (existing) are already built; this plan wires them into a unified upload workflow.

Output: Modified `views/upload.js` with radio toggle, preference persistence, and dual-path submission.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@views/upload.js
@lib/capability-detection.js
@views/device-progress.js
@app.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add radio button toggle with localStorage persistence and capability detection</name>
  <files>views/upload.js</files>
  <action>
Add two new imports at the top of `views/upload.js`:
- `import { supportsClientProcessing } from '../lib/capability-detection.js';`
- `import { setDeviceProcessingData } from './device-progress.js';`

Add localStorage helper functions (module-level, before renderUpload):
- `const STORAGE_KEY = 'video-refresher.processing-mode';`
- `saveProcessingMode(mode)` -- wraps `localStorage.setItem(STORAGE_KEY, mode)` in try-catch with console.warn on failure
- `loadProcessingMode()` -- wraps `localStorage.getItem(STORAGE_KEY) || 'server'` in try-catch, returns 'server' on failure

Inside `renderUpload()`, after the `instructions` paragraph and before the hidden `fileInput`, add radio button creation:

1. Check capability: `const canProcessOnDevice = supportsClientProcessing();`
2. Load saved preference: `const savedMode = loadProcessingMode();`
3. Compute effective mode: if `savedMode === 'device' && !canProcessOnDevice`, use `'server'` (silent fallback)
4. Create a container div (`modeSection`) with inline flex styling: `display: flex; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem;`
5. Create server radio wrapper (div with flex/center/gap:0.5rem):
   - `input[type=radio]` with `name='processing-mode'`, `value='server'`, `id='mode-server'`
   - `label[for='mode-server']` with text "Send to server", `cursor: pointer`
6. Create device radio wrapper (same layout):
   - `input[type=radio]` with `name='processing-mode'`, `value='device'`, `id='mode-device'`
   - `label[for='mode-device']` with text "Process on device", `cursor: pointer`
7. Set initial checked state based on `effectiveMode`
8. If `!canProcessOnDevice`:
   - Set `deviceRadio.disabled = true`
   - Set device label color to `#999`, cursor to `not-allowed`
   - Append a span to device label with text " (Not supported in this browser)" styled `font-size: 0.85em; color: #999; font-weight: normal;`
9. Attach `change` event listeners on both radios to call `saveProcessingMode()` with respective value
10. Insert `modeSection` into wrapper AFTER instructions and BEFORE fileInput (use `wrapper.insertBefore(modeSection, fileInput)` -- note fileInput is already appended to wrapper at this point, so insert before the fileInput element)

Important: The radio buttons are labels-only, no section header, no container border -- just the inline radio buttons per user decision. Do NOT add any descriptive subtext, trade-off hints, or recommendations beneath the labels.

Store references to `serverRadio` and `deviceRadio` in the function scope so Task 2 can access them in the submit handler.
  </action>
  <verify>
Open `http://localhost:8080/#upload` (or wherever the app runs). Verify:
1. Two radio buttons appear above the drop zone: "Send to server" (selected by default) and "Process on device"
2. Clicking a radio saves to localStorage (check DevTools > Application > Local Storage for key `video-refresher.processing-mode`)
3. Refresh the page -- last selected mode persists
4. If testing without COOP/COEP headers, device option should be disabled with "(Not supported in this browser)" message
  </verify>
  <done>Radio buttons render above drop zone, default to server, persist to localStorage on change, and disable device option when SharedArrayBuffer unavailable</done>
</task>

<task type="auto">
  <name>Task 2: Wire mode-aware submit routing and lock radios during processing</name>
  <files>views/upload.js</files>
  <action>
Modify the existing `submitBtn` click handler in `renderUpload()` to branch on selected processing mode:

1. At the start of the click handler, read the selected mode:
   `const selectedMode = document.querySelector('input[name="processing-mode"]:checked').value;`

2. Immediately after disabling the submit button (existing code), disable both radio buttons:
   ```
   serverRadio.disabled = true;
   deviceRadio.disabled = true;
   ```

3. Add mode branching AFTER the validation and button disabling:

   **If `selectedMode === 'device'`:**
   - Call `setDeviceProcessingData(selectedFiles, variations)` (variations already parsed above)
   - Navigate: `window.location.hash = '#device-progress';`
   - Return early (skip the server upload path entirely)

   **If `selectedMode === 'server'` (else branch):**
   - Keep ALL existing server upload code unchanged (show progress section, create FormData, call uploadFiles, navigate to job detail)
   - In the existing catch block (error handler), also re-enable radio buttons:
     - `serverRadio.disabled = false;`
     - `deviceRadio.disabled = false;`
     - But if `!canProcessOnDevice`, keep `deviceRadio.disabled = true` (re-apply capability constraint)

4. Update the submit button text to be mode-aware:
   - Default text: keep "Upload and Process" (works for both modes since it's generic enough)
   - When processing starts (device mode): `submitBtn.textContent = 'Processing...'` before navigation
   - When uploading (server mode): keep existing `submitBtn.textContent = 'Uploading...'`

Important implementation notes:
- The `selectedFiles` array is module-level state that persists across radio changes -- do NOT reset it on mode switch (files stay selected per user decision)
- The `canProcessOnDevice` variable from Task 1 must be accessible in the error handler for proper re-enable logic. Since both tasks are in the same function scope, this works naturally.
- Device mode navigation happens synchronously (no async needed) -- `setDeviceProcessingData` + hash change is all that's needed
- Server mode is the existing async flow with FormData upload -- no changes to the upload logic itself
  </action>
  <verify>
Test both paths:

**Device mode test:**
1. Select "Process on device" radio (if SharedArrayBuffer available)
2. Select one or more MP4 files
3. Click "Upload and Process"
4. Verify navigation to `#device-progress` with files present
5. Verify radio buttons were disabled before navigation

**Server mode test:**
1. Select "Send to server" radio
2. Select one or more MP4 files
3. Click "Upload and Process"
4. Verify upload progress bar appears and job completes normally
5. Verify navigation to `#job/{jobId}` on success

**Mode switching test:**
1. Select files, switch from server to device mode -- files should remain in the list
2. Switch back to server -- files should still be there

**Error recovery test (server mode):**
1. Trigger an upload error (e.g., disconnect network)
2. Verify radio buttons re-enable (respecting capability constraint for device radio)
3. Verify submit button re-enables
  </verify>
  <done>Submit handler routes to device (setDeviceProcessingData + #device-progress) or server (FormData upload + #job/{jobId}) based on selected radio. Radio buttons lock during processing. Error recovery re-enables controls.</done>
</task>

</tasks>

<verification>
1. Radio buttons appear above drop zone on upload page
2. Server is default for first-time visitor (no localStorage key)
3. Preference persists across page refreshes (localStorage check)
4. Device radio disabled with message when SharedArrayBuffer unavailable
5. Silent fallback to server when saved preference is device but capability missing
6. Device mode submission: files passed via setDeviceProcessingData, navigates to #device-progress
7. Server mode submission: FormData upload with progress, navigates to #job/{jobId}
8. Radio buttons disabled during processing/upload
9. Files remain selected when switching modes
10. Error recovery re-enables radio buttons (respecting capability)
</verification>

<success_criteria>
Upload page provides mode selection between device and server processing, persists preference in localStorage, correctly routes submissions to the appropriate processing path, and handles capability detection gracefully.
</success_criteria>

<output>
After completion, create `.planning/phases/13-upload-view-integration/13-01-SUMMARY.md`
</output>
