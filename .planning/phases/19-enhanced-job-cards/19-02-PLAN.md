---
phase: 19-enhanced-job-cards
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - lib/api.js
  - lib/notifications.js
  - views/job-list.js
  - views/upload.js
  - styles.css
  - app.js
  - index.html
autonomous: true

must_haves:
  truths:
    - "Job cards display a small thumbnail image on the left side"
    - "Cards without thumbnails show a generic video icon placeholder"
    - "User receives browser notification when a server job completes (if permission granted)"
    - "Notification permission prompt appears on first server job submission"
    - "In-app toggle controls notification enable/disable"
    - "Notifications fire when tab is in background"
  artifacts:
    - path: "lib/notifications.js"
      provides: "Notification permission management, fire notification, in-app toggle state"
      exports: ["requestPermissionIfNeeded", "fireJobCompleteNotification", "isNotificationsEnabled", "setNotificationsEnabled"]
    - path: "views/job-list.js"
      provides: "Job cards with thumbnail images and notification detection for completed jobs"
      contains: "job-card-thumb"
    - path: "views/upload.js"
      provides: "Notification permission prompt on first server job submit"
      contains: "requestPermissionIfNeeded"
    - path: "styles.css"
      provides: "Thumbnail layout CSS and notification toggle CSS"
      contains: "job-card-thumb"
    - path: "app.js"
      provides: "Notification toggle wired into nav"
      contains: "notifications"
  key_links:
    - from: "views/upload.js"
      to: "lib/notifications.js"
      via: "requestPermissionIfNeeded import"
      pattern: "requestPermissionIfNeeded"
    - from: "views/job-list.js"
      to: "lib/notifications.js"
      via: "fireJobCompleteNotification import"
      pattern: "fireJobCompleteNotification"
    - from: "views/job-list.js"
      to: "server/routes/jobs.js"
      via: "thumbnailUrl from API response"
      pattern: "thumbnailUrl"
---

<objective>
Add thumbnail display to job cards and browser notification system for completed server jobs.

Purpose: Thumbnails provide quick visual identification of jobs in the card grid. Browser notifications alert users when server jobs complete, supporting the fire-and-forget workflow where users submit a job and switch to other tasks.

Output: Job cards show video thumbnails inline, notification module with permission management and in-app toggle, notifications fire on job completion.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-enhanced-job-cards/19-01-SUMMARY.md

@views/job-list.js
@views/upload.js
@styles.css
@app.js
@index.html
@lib/api.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Notification module and thumbnail/notification CSS</name>
  <files>lib/notifications.js, styles.css</files>
  <action>
1. Create `lib/notifications.js` with the following exports:

   - `requestPermissionIfNeeded()`: Check if Notification API available. Check localStorage key `video-refresher.notif-prompted` -- if not set, request `Notification.requestPermission()`, set the prompted flag, and if granted also set `video-refresher.notif-enabled` to 'true'. If already prompted, do nothing. Returns the permission state.

   - `fireJobCompleteNotification(jobId)`: If notifications not enabled (check `isNotificationsEnabled()`), return. If `document.visibilityState === 'visible'`, return (no notification if tab is in foreground -- per user decision: background tab only). Create `new Notification('Video Refresher: Your videos are ready to download')`. On click: `window.focus()` to bring the Video Refresher tab to front, then `notification.close()`. Auto-dismiss after 10 seconds via `setTimeout(() => notification.close(), 10000)` (Claude's discretion).

   - `isNotificationsEnabled()`: Returns true if localStorage key `video-refresher.notif-enabled` is 'true' AND `Notification.permission === 'granted'`. Both must be true.

   - `setNotificationsEnabled(enabled)`: Sets localStorage `video-refresher.notif-enabled` to 'true' or 'false'. If enabling and permission not yet granted, requests permission.

   - `isNotificationSupported()`: Returns `'Notification' in window`.

2. In `styles.css`, add CSS for job card thumbnails and notification toggle:

   **Thumbnail styles:**
   - `.job-card-body`: `display: flex; align-items: flex-start; gap: var(--space-3); margin-bottom: var(--space-2);` -- wraps thumbnail + text content side by side
   - `.job-card-thumb`: `width: 56px; height: 56px; border-radius: var(--radius-md); object-fit: cover; flex-shrink: 0; background: var(--color-bg-elevated);` -- 56px square (within 48-64px range, Claude's discretion), cover crop (Claude's discretion)
   - `.job-card-thumb-placeholder`: Same dimensions as .job-card-thumb, `display: flex; align-items: center; justify-content: center; background: var(--color-bg-elevated); border-radius: var(--radius-md); color: var(--color-text-muted); flex-shrink: 0;` -- generic placeholder box
   - `.job-card-content`: `flex: 1; min-width: 0;` -- text content wrapper, min-width: 0 for text-overflow to work in flex

   **Notification toggle styles:**
   - `.notif-toggle`: `display: flex; align-items: center; gap: var(--space-2); cursor: pointer; font-size: var(--font-size-xs); color: var(--color-text-secondary);`
   - `.notif-toggle-switch`: A small toggle switch (16px height, 28px width), rounded, with `input[type=checkbox]` hidden, using `::before` pseudo-element for the knob. Background changes when checked. Use CSS variables for colors.
   - `.notif-toggle.disabled`: `opacity: 0.5; cursor: not-allowed;` -- when Notification API not supported
  </action>
  <verify>
  Read lib/notifications.js and verify all 5 functions are exported. Read styles.css and verify .job-card-thumb, .job-card-body, .job-card-thumb-placeholder, .notif-toggle classes exist.
  </verify>
  <done>Notification module handles permission, firing, and toggle state. CSS provides thumbnail layout (56px square, left-aligned) and notification toggle styling.</done>
</task>

<task type="auto">
  <name>Task 2: Job card thumbnails, notification detection in job list, permission prompt on submit, and nav toggle</name>
  <files>views/job-list.js, views/upload.js, app.js, index.html</files>
  <action>
1. **`views/job-list.js`** -- Add thumbnail display and notification firing:

   a. Import `fireJobCompleteNotification` and `isNotificationsEnabled` from `../lib/notifications.js`.

   b. Add a module-level Set `notifiedJobs` to track which job IDs have already fired a notification (prevents duplicate notifications on poll). Also maintain `previousJobStatuses` Map to track the last known status of each job.

   c. In `fetchAndRenderJobs()`, after receiving jobs from API, detect newly completed server jobs:
      - For each job: if `job.status === 'completed'` AND `job.source === 'server'` AND `previousJobStatuses.get(job.id) !== 'completed'` AND `!notifiedJobs.has(job.id)`:
        - Call `fireJobCompleteNotification(job.id)`
        - Add to `notifiedJobs`
      - After detection, update `previousJobStatuses` with current statuses for all jobs.
      - On first load (previousJobStatuses is empty), populate statuses without firing notifications (don't notify for already-completed jobs).

   d. In `renderJobsList()`, update the card structure to include thumbnails:
      - After creating `jobCard`, create a `job-card-body` wrapper div.
      - Create thumbnail element:
        - If `job.thumbnailUrl`: create an `<img>` with `className: 'job-card-thumb'`, `src` set to the full API URL (use the same API_BASE pattern -- import it or build from job data). Set `alt` to first filename. Add `loading="lazy"`. The thumbnail URL from API is relative (`/api/jobs/{id}/thumbnail`), so prepend the API_BASE. Import API_BASE from `../lib/api.js` -- but API_BASE is not exported. Instead, compute the thumbnail URL the same way: check `window.location.hostname === 'localhost'` for base, or just use the thumbnailUrl as-is since the API call already uses the right base. Actually, the simplest approach: add a small exported getter `getApiBase()` to `lib/api.js`, OR construct the img src using the same logic. Better yet: export `API_BASE` from `lib/api.js` as a named export.
        - If no `thumbnailUrl`: create a `div` with `className: 'job-card-thumb-placeholder'` containing an SVG video/film icon (small, e.g., 24x24, film frame or play button icon).
      - Move the existing header (title + badge) and meta into a `.job-card-content` wrapper div.
      - Structure becomes: `jobCard > [job-card-body > [thumb, job-card-content > [header, meta]], actions]`

   e. In `cleanupJobList()`, also clear `notifiedJobs` and `previousJobStatuses`.

2. **`lib/api.js`** -- Export the API_BASE constant:
   - Change `const API_BASE` to `export const API_BASE` so job-list.js can import it for thumbnail URLs.

3. **`views/upload.js`** -- Add notification permission prompt:
   - Import `requestPermissionIfNeeded` from `../lib/notifications.js`.
   - In the submit button click handler, when `selectedMode === 'server'` (server processing path), before the upload call, call `requestPermissionIfNeeded()`. This is a non-blocking call -- don't await it if it would delay the upload. Actually, `Notification.requestPermission()` shows a browser prompt that doesn't block JS execution in modern browsers (it returns a promise). Call it with await before the upload starts so the prompt appears right when they submit (per user decision). If the user dismisses or denies, processing continues normally.

4. **`app.js` and `index.html`** -- Add notification toggle to nav:
   - In `index.html`, add a placeholder element in the nav for the toggle. Add it between the nav-tabs and logout button: `<div id="notif-toggle-container" class="notif-toggle"></div>`. Or better, create it dynamically in app.js.
   - In `app.js`, import `isNotificationsEnabled`, `setNotificationsEnabled`, `isNotificationSupported` from `./lib/notifications.js`.
   - In the DOMContentLoaded handler, create the notification toggle UI:
     - If `isNotificationSupported()` is false, skip (don't show toggle).
     - Create a label element with class `notif-toggle`.
     - Create a checkbox input. Set `checked` to `isNotificationsEnabled()`.
     - Create a span for the toggle switch visual (class `notif-toggle-switch`).
     - Create a text span: "Notifications".
     - On checkbox change: call `setNotificationsEnabled(checkbox.checked)`.
     - Insert the toggle into the nav, before the logout button.
  </action>
  <verify>
  Read all modified files and verify:
  - job-list.js imports notification functions, has thumbnail rendering with img/placeholder, has notification detection logic
  - upload.js calls requestPermissionIfNeeded before server upload
  - app.js creates notification toggle in nav
  - lib/api.js exports API_BASE
  Run `node -e "import('./lib/notifications.js')"` -- no syntax errors (well, this is browser-only code, so instead just read and verify)
  </verify>
  <done>Job cards show 56px thumbnails on left with placeholder for missing ones. Newly completed server jobs fire browser notifications. Permission prompt on first server submit. Nav has notification toggle.</done>
</task>

</tasks>

<verification>
1. Read `lib/notifications.js` -- all functions exported, permission logic correct
2. Read `views/job-list.js` -- thumbnail images rendered, notification detection for completed jobs
3. Read `views/upload.js` -- requestPermissionIfNeeded called on server submit
4. Read `app.js` -- notification toggle created in nav
5. Read `styles.css` -- thumbnail and toggle CSS present
6. Read `lib/api.js` -- API_BASE exported
7. Verify no syntax errors in modified files
</verification>

<success_criteria>
- Job cards display 56px thumbnail on left side (from API thumbnailUrl)
- Missing thumbnails show a generic video icon placeholder
- Notification permission requested on first server job submission
- Browser notification fires when a server job transitions to completed (background tab only)
- In-app toggle in nav controls notification enable/disable
- Notifications use generic text: "Video Refresher: Your videos are ready to download"
- Click on notification focuses the Video Refresher tab
- No notifications for device jobs
- No notifications for already-completed jobs on page load
</success_criteria>

<output>
After completion, create `.planning/phases/19-enhanced-job-cards/19-02-SUMMARY.md`
</output>
