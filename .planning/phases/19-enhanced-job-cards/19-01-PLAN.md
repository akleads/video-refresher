---
phase: 19-enhanced-job-cards
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/db/schema.js
  - server/db/queries.js
  - server/lib/ffmpeg.js
  - server/lib/processor.js
  - server/routes/jobs.js
autonomous: true

must_haves:
  truths:
    - "Server jobs generate a WebP thumbnail during FFmpeg processing"
    - "Device job uploads generate a WebP thumbnail from the first uploaded result file"
    - "Thumbnail is accessible via authenticated GET endpoint"
    - "Job list API includes thumbnail URL for each job"
  artifacts:
    - path: "server/db/schema.js"
      provides: "thumbnail_path column migration on jobs table"
      contains: "thumbnail_path"
    - path: "server/db/queries.js"
      provides: "updateJobThumbnail prepared statement and thumbnail_path in job list query"
      contains: "updateJobThumbnail"
    - path: "server/lib/ffmpeg.js"
      provides: "extractThumbnail function using ffmpeg to grab frame at ~2s"
      contains: "extractThumbnail"
    - path: "server/lib/processor.js"
      provides: "Thumbnail extraction call during server job processing"
      contains: "extractThumbnail"
    - path: "server/routes/jobs.js"
      provides: "GET /:id/thumbnail endpoint serving WebP file, thumbnail generation on device upload, thumbnailUrl in job list response"
      contains: "thumbnail"
  key_links:
    - from: "server/lib/processor.js"
      to: "server/lib/ffmpeg.js"
      via: "extractThumbnail import and call"
      pattern: "extractThumbnail"
    - from: "server/routes/jobs.js"
      to: "server/db/queries.js"
      via: "updateJobThumbnail query"
      pattern: "updateJobThumbnail"
---

<objective>
Add server-side thumbnail generation and serving for job cards.

Purpose: Generate a small WebP thumbnail from the first source video during processing so job cards can display a visual preview. Thumbnails are generated during FFmpeg processing for server jobs and on upload for device jobs, stored alongside output files, and served via an authenticated API endpoint.

Output: Thumbnail generation integrated into processing pipeline, thumbnail serving endpoint, thumbnail URL included in job list API response.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@server/db/schema.js
@server/db/queries.js
@server/lib/ffmpeg.js
@server/lib/processor.js
@server/routes/jobs.js
@server/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Schema migration, thumbnail extraction function, and query updates</name>
  <files>server/db/schema.js, server/db/queries.js, server/lib/ffmpeg.js</files>
  <action>
1. In `server/db/schema.js` `migrateSchema()`, add a new column migration:
   - `{ table: 'jobs', name: 'thumbnail_path', sql: "ALTER TABLE jobs ADD COLUMN thumbnail_path TEXT" }`

2. In `server/db/queries.js` `createJobQueries()`, add:
   - `updateJobThumbnail`: prepared statement `UPDATE jobs SET thumbnail_path = ? WHERE id = ?`
   - Update `listJobsWithFiles` query to include `j.thumbnail_path` in the SELECT (it already uses `j.*` so this should already be included, but verify the response mapping in the route)

3. In `server/lib/ffmpeg.js`, add a new exported function `extractThumbnail(inputPath, outputPath)`:
   - Spawns ffmpeg: `ffmpeg -i {inputPath} -ss 2 -vframes 1 -vf "scale=128:-1" -q:v 80 -f webp {outputPath}`
   - The `-ss 2` seeks to 2 seconds in to avoid black intros (per user decision)
   - Scale to 128px width (within 48-64px display range, provides crisp 2x for retina)
   - WebP format (per user decision)
   - Quality 80 (reasonable size/quality tradeoff -- Claude's discretion)
   - Returns a Promise that resolves on success, rejects on error
   - If the video is shorter than 2 seconds, ffmpeg still grabs a frame (it picks the nearest available)
   - Best-effort: catch errors and resolve with null or false so thumbnail failure never blocks processing
  </action>
  <verify>
  Read the three modified files and confirm:
  - schema.js has the thumbnail_path migration
  - queries.js has updateJobThumbnail statement
  - ffmpeg.js exports extractThumbnail function with correct ffmpeg args
  </verify>
  <done>Schema migration adds thumbnail_path column, extractThumbnail function spawns ffmpeg to extract a 128px WebP frame at ~2s, updateJobThumbnail query exists</done>
</task>

<task type="auto">
  <name>Task 2: Integrate thumbnail generation into processing pipeline and device upload</name>
  <files>server/lib/processor.js, server/routes/jobs.js</files>
  <action>
1. In `server/lib/processor.js`:
   - Import `extractThumbnail` from `./ffmpeg.js`
   - In `processJob()`, after the first file is successfully processed (after the first iteration of the files loop where processFile succeeds), generate a thumbnail:
     - Get the upload_path of the first file (`files[0].upload_path`)
     - Thumbnail output path: `path.join(outputDir, job.id, 'thumb.webp')`
     - Call `await extractThumbnail(files[0].upload_path, thumbnailPath)` wrapped in try/catch
     - If successful, call `queries.updateJobThumbnail.run(thumbnailPath, job.id)`
     - If extraction fails (e.g., corrupt video), log warning and continue -- thumbnail is non-critical
   - IMPORTANT: Extract thumbnail BEFORE cleaning up upload files (step 7). The thumbnail extraction needs the original source file. Move the thumbnail extraction to happen right after the processing loop (step 4-6) but before upload cleanup (step 7).

2. In `server/routes/jobs.js`:
   - **Device upload endpoint** (`POST /device`): After the transaction that creates job records and moves files, generate a thumbnail from the first uploaded result file:
     - Get the first result file path from the output directory (the first file that was moved to `jobOutputDir`)
     - Thumbnail path: `path.join(jobOutputDir, 'thumb.webp')`
     - Call `extractThumbnail(firstResultPath, thumbnailPath)` (import from `../lib/ffmpeg.js`)
     - If successful, update the job: `queries.updateJobThumbnail.run(thumbnailPath, jobId)`
     - Wrap in try/catch -- don't fail the device upload if thumbnail generation fails

   - **Job list endpoint** (`GET /`): Update the response mapping to include a `thumbnailUrl` field:
     - If `job.thumbnail_path` is truthy: `thumbnailUrl: \`/api/jobs/${job.id}/thumbnail\``
     - If null: `thumbnailUrl: null`

   - **Job status endpoint** (`GET /:id`): Similarly add `thumbnailUrl` to response.

   - **New thumbnail endpoint** (`GET /:id/thumbnail`): Add before the download endpoint:
     - Requires auth (already on router)
     - Get job from `queries.getJob.get(req.params.id)`
     - If no job or no `thumbnail_path`: return 404
     - Check the file exists on disk (`fs.existsSync`)
     - If file missing: return 404
     - Set `Content-Type: image/webp` header
     - Stream the file: `fs.createReadStream(job.thumbnail_path).pipe(res)`
  </action>
  <verify>
  Run `node -e "import('./server/lib/processor.js')"` and `node -e "import('./server/routes/jobs.js')"` to verify no syntax errors. Read both files and confirm:
  - processor.js calls extractThumbnail after processing loop, before upload cleanup
  - jobs.js has thumbnail endpoint, device upload thumbnail generation, and thumbnailUrl in list/status responses
  </verify>
  <done>Server jobs generate thumbnail during processing from first source video, device uploads generate thumbnail from first result file, job list and status APIs include thumbnailUrl, GET /:id/thumbnail serves the WebP file</done>
</task>

</tasks>

<verification>
1. Read `server/db/schema.js` -- thumbnail_path migration exists
2. Read `server/db/queries.js` -- updateJobThumbnail prepared statement exists
3. Read `server/lib/ffmpeg.js` -- extractThumbnail exported function exists
4. Read `server/lib/processor.js` -- extractThumbnail called after processing, before upload cleanup
5. Read `server/routes/jobs.js` -- thumbnail endpoint, device upload thumbnail, thumbnailUrl in API responses
6. `node -e "import('./server/lib/processor.js')"` -- no import errors
7. `node -e "import('./server/routes/jobs.js')"` -- no import errors
</verification>

<success_criteria>
- Schema migration adds thumbnail_path column to jobs table
- extractThumbnail function extracts a 128px WebP frame at ~2 seconds
- Server job processing generates thumbnail from first source video
- Device upload generates thumbnail from first result file
- GET /api/jobs/:id/thumbnail serves the thumbnail image
- Job list and status APIs include thumbnailUrl in response
- Thumbnail failure never blocks job processing or device upload
</success_criteria>

<output>
After completion, create `.planning/phases/19-enhanced-job-cards/19-01-SUMMARY.md`
</output>
