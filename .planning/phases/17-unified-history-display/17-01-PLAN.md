---
phase: 17-unified-history-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/db/queries.js
  - server/routes/jobs.js
  - views/job-list.js
  - styles.css
autonomous: true

must_haves:
  truths:
    - "Job list displays both device-processed and server-processed jobs together"
    - "Job cards show original source video filenames instead of generic Job N labels"
    - "Video count, variation count, and timestamp align properly in job card layout"
    - "User can distinguish device vs server jobs via a visual indicator"
  artifacts:
    - path: "server/db/queries.js"
      provides: "listJobs query with source filename aggregation"
      contains: "listJobsWithFiles"
    - path: "server/routes/jobs.js"
      provides: "GET / returns fileNames array for each job"
      contains: "fileNames"
    - path: "views/job-list.js"
      provides: "Job cards with filenames, source badge, aligned layout"
      contains: "source"
    - path: "styles.css"
      provides: "Styles for source badge and improved card layout"
      contains: "job-card-title"
  key_links:
    - from: "server/routes/jobs.js"
      to: "server/db/queries.js"
      via: "listJobsWithFiles query"
      pattern: "queries\\.listJobsWithFiles"
    - from: "views/job-list.js"
      to: "/api/jobs response"
      via: "job.fileNames and job.source rendering"
      pattern: "job\\.fileNames|job\\.source"
---

<objective>
Unify device and server jobs in history with improved job card layout showing source filenames and source type indicators.

Purpose: Users need to see all their jobs (device and server) in one place, identify them by their original video filenames rather than opaque job IDs, and distinguish which processing mode was used.

Output: Updated job list API returning filenames, redesigned job cards with filename titles, source badges, and properly aligned metadata.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-device-job-history-upload/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add source filenames to job list API response</name>
  <files>server/db/queries.js, server/routes/jobs.js</files>
  <action>
  In server/db/queries.js, add a new prepared statement `listJobsWithFiles` that joins jobs with job_files to get the original filenames. Use GROUP_CONCAT to aggregate filenames into a single comma-separated string per job:

  ```sql
  SELECT j.*, GROUP_CONCAT(jf.original_name) as file_names
  FROM jobs j
  LEFT JOIN job_files jf ON jf.job_id = j.id
  GROUP BY j.id
  ORDER BY j.created_at DESC
  LIMIT 50
  ```

  Keep the existing `listJobs` statement (other code may use it). Add `listJobsWithFiles` alongside it.

  In server/routes/jobs.js, update the `GET /` route handler to:
  1. Use `queries.listJobsWithFiles.all()` instead of `queries.listJobs.all()`
  2. In the response mapper, add a `fileNames` field by splitting the `file_names` string on commas. If `file_names` is null/empty, return an empty array.
  3. Keep all existing fields (id, status, totalVideos, totalVariations, source, createdAt).

  The response shape per job becomes:
  ```json
  {
    "id": "abc123",
    "status": "completed",
    "totalVideos": 2,
    "totalVariations": 10,
    "source": "device",
    "fileNames": ["video1.mp4", "video2.mov"],
    "createdAt": "2026-02-10T..."
  }
  ```
  </action>
  <verify>
  Start the server (`npm start` or `node server/index.js`) and use curl to verify:
  ```
  curl -s -H "Authorization: Bearer TOKEN" http://localhost:PORT/api/jobs | node -e "process.stdin.on('data',d=>{const j=JSON.parse(d);console.log(j[0]?.fileNames);console.log(typeof j[0]?.source)})"
  ```
  Confirm fileNames is an array and source is a string.
  If no auth token is available, verify by reading the code and confirming the query and mapper are correct.
  </verify>
  <done>GET /api/jobs returns fileNames array and source field for every job. Existing fields unchanged.</done>
</task>

<task type="auto">
  <name>Task 2: Redesign job cards with filenames, source badge, and aligned layout</name>
  <files>views/job-list.js, styles.css</files>
  <action>
  **CSS additions in styles.css:**

  Add these new classes after the existing `.job-card-header` styles (around line 348):

  1. `.job-card-title` - The card title showing filenames. Style: `font-weight: var(--font-weight-semibold); font-size: var(--font-size-base); color: var(--color-text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 70%;`

  2. `.job-card-meta` - Container for the counts and timestamp row below the header. Style: `display: flex; justify-content: space-between; align-items: center; color: var(--color-text-secondary); font-size: var(--font-size-sm);`

  3. `.job-card-source` - Small inline badge for device/server. Style: `font-size: var(--font-size-xs); padding: 2px var(--spacing-sm); border-radius: var(--radius-full); font-weight: var(--font-weight-medium); text-transform: uppercase; letter-spacing: 0.5px;`

  4. `.job-card-source-device` - Device variant: `background: rgba(5, 150, 105, 0.15); color: var(--color-green-500);`

  5. `.job-card-source-server` - Server variant: `background: var(--color-info-bg); color: var(--color-info-text);`

  6. Update `.job-card-details` to remove default styling if it conflicts, or leave if compatible. The new `.job-card-meta` replaces the loose paragraph approach.

  **Frontend changes in views/job-list.js:**

  Update the `renderJobsList` function. Replace the current card structure with:

  **Card header row** (`.job-card-header`):
  - Left side: `.job-card-title` element containing the display name
    - If `job.fileNames` has 1 file: show the filename (e.g., "video1.mp4")
    - If `job.fileNames` has 2-3 files: show comma-joined (e.g., "video1.mp4, video2.mp4")
    - If `job.fileNames` has 4+ files: show first two + " +N more" (e.g., "video1.mp4, video2.mp4 +3 more")
    - If `job.fileNames` is empty/missing: fall back to "Job {job.id}" (backward compat with any edge case)
  - Right side: status badge (existing badge logic, keep as-is)

  **Meta row** (`.job-card-meta`) below the header:
  - Left side: A span with source badge (`.job-card-source` + `.job-card-source-device` or `.job-card-source-server`) showing "Device" or "Server", followed by a text span showing "{N} videos, {M} variations" (use the middle dot or bullet character as separator between badge and text if they look too close)
  - Right side: timestamp span (using existing `timeAgo` function)

  **Actions row** (`.job-card-actions`): Keep exactly as-is (cancel button, action links).

  Remove the old `.job-card-id` span and the old `.job-card-details` div with its two paragraph children. Replace them with the new structure above.

  Set `title` attribute on the `.job-card-title` element to the full comma-joined filename list, so users can hover to see all names when truncated.

  Do NOT change: polling logic, click handlers, cancel button, action link logic, expiry logic. Only change the card rendering inside the `jobs.forEach` loop.
  </action>
  <verify>
  Read the modified files to confirm:
  1. `styles.css` has the new `.job-card-title`, `.job-card-meta`, `.job-card-source`, `.job-card-source-device`, `.job-card-source-server` classes
  2. `views/job-list.js` renders filenames in card title, source badge, and aligned meta row
  3. No references to `job-card-id` remain in job-list.js (replaced by job-card-title)
  4. The `timeAgo` import is still present
  5. Fallback to "Job {id}" when fileNames is empty
  </verify>
  <done>Job cards display source filenames as titles with text truncation, device/server source badges, and properly aligned video count + variation count + timestamp in a clean row layout.</done>
</task>

</tasks>

<verification>
1. Both device and server jobs appear in the same list at #jobs
2. Job cards show original filenames (e.g., "my_ad.mp4") instead of "Job abc123"
3. Each card has a small "Device" or "Server" badge indicating processing source
4. Video count, variation count, and timestamp are aligned in a single row
5. Long filenames truncate with ellipsis and show full name on hover
6. Cards with 4+ files show "file1.mp4, file2.mp4 +N more" format
7. All existing functionality (polling, cancel, actions, expiry) works unchanged
</verification>

<success_criteria>
- GET /api/jobs returns fileNames array for each job
- Job cards show filenames instead of "Job N"
- Source badge distinguishes device vs server jobs
- Meta row aligns counts and timestamp horizontally
- No regressions in polling, cancel, or navigation
</success_criteria>

<output>
After completion, create `.planning/phases/17-unified-history-display/17-01-SUMMARY.md`
</output>
