---
phase: 12-server-job-cancellation
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - views/job-detail.js
  - views/job-list.js
  - styles.css
autonomous: true

must_haves:
  truths:
    - "Job detail page shows a Cancel button when job status is 'processing' or 'queued'"
    - "Clicking Cancel shows a confirmation dialog before sending the request"
    - "While cancellation is in progress, button shows 'Cancelling...' and is disabled"
    - "After cancellation, status updates to 'Cancelled' with gray badge"
    - "Cancelled jobs show completion count: 'Cancelled (3/10)' format"
    - "Job list shows inline Cancel button for processing/queued jobs"
    - "Cancelled jobs with completed variations show a Download button"
    - "Polling stops when status becomes 'cancelled'"
  artifacts:
    - path: "views/job-detail.js"
      provides: "Cancel button, cancelled status display, partial download"
      contains: "cancel"
    - path: "views/job-list.js"
      provides: "Inline cancel button, cancelled status badge"
      contains: "cancel"
    - path: "styles.css"
      provides: "Cancelled status badge styling (gray/neutral)"
      contains: "cancelled"
  key_links:
    - from: "views/job-detail.js"
      to: "/api/jobs/:id/cancel"
      via: "apiCall POST on cancel button click"
      pattern: "apiCall.*cancel"
    - from: "views/job-list.js"
      to: "/api/jobs/:id/cancel"
      via: "apiCall POST on inline cancel button click"
      pattern: "apiCall.*cancel"
    - from: "views/job-detail.js"
      to: "polling stop"
      via: "stopPolling() called when status is cancelled"
      pattern: "cancelled.*stopPolling|status.*cancelled"
---

<objective>
Add Cancel button UI to job detail and job list views, with confirmation dialog, "Cancelling..." intermediate state, and cancelled status display (gray badge, completion count).

Purpose: Users need visible controls to cancel in-progress and queued server jobs, with clear feedback during and after cancellation. Cancelled jobs with partial results should remain downloadable.

Output: Updated job-detail.js and job-list.js views with cancel functionality, and CSS for cancelled status badge.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-server-job-cancellation/12-CONTEXT.md
@.planning/phases/12-server-job-cancellation/12-01-SUMMARY.md

@views/job-detail.js
@views/job-list.js
@lib/api.js
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Cancel button and cancelled status on job detail page</name>
  <files>views/job-detail.js</files>
  <action>
Modify `views/job-detail.js` to add cancellation UI. All DOM creation must use `document.createElement()` (no innerHTML -- project convention).

1. **Add Cancel button to the DOM structure in `renderJobDetail()`:**
   After creating the `downloadSection` div and before `errorSection`, create a cancel section:
   ```js
   const cancelSection = document.createElement('div');
   cancelSection.id = 'cancel-section';
   cancelSection.style.display = 'none';

   const cancelBtn = document.createElement('button');
   cancelBtn.className = 'btn btn-danger';
   cancelBtn.id = 'cancel-btn';
   cancelBtn.textContent = 'Cancel Job';
   cancelBtn.addEventListener('click', () => handleCancel());

   cancelSection.appendChild(cancelBtn);
   ```
   Append `cancelSection` to container (between downloadSection and errorSection).

2. **Add `handleCancel()` function:**
   ```js
   async function handleCancel() {
     // Confirmation dialog
     const confirmed = confirm('Cancel this job? Completed variations will be kept.');
     if (!confirmed) return;

     // Disable button, show "Cancelling..."
     const cancelBtn = document.getElementById('cancel-btn');
     cancelBtn.disabled = true;
     cancelBtn.textContent = 'Cancelling...';
     cancelBtn.classList.add('btn-disabled');

     try {
       const response = await apiCall(`/api/jobs/${currentJobId}/cancel`, {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' }
       });
       const data = await response.json();

       // Immediately fetch fresh job data to update UI
       fetchAndUpdateJob();
     } catch (err) {
       console.error('Cancel failed:', err);
       // Re-enable button for retry (per CONTEXT.md: show error, re-enable for retry)
       cancelBtn.disabled = false;
       cancelBtn.textContent = 'Cancel Job';
       cancelBtn.classList.remove('btn-disabled');
       alert(`Failed to cancel job: ${err.message}`);
     }
   }
   ```

3. **Update `updateJobDetailUI()` to handle 'cancelled' status:**

   In the status badge section (after the existing if/else chain for queued/processing/completed/failed), add:
   ```js
   } else if (data.status === 'cancelled') {
     statusBadge.classList.add('badge-gray');
   }
   ```

   Update the status badge text for cancelled jobs to include completion count:
   ```js
   if (data.status === 'cancelled') {
     const completedVars = data.files
       ? data.files.reduce((sum, f) => sum + (f.completedVariations || 0), 0)
       : 0;
     statusBadge.textContent = `Cancelled (${completedVars}/${data.totalVariations})`;
   } else {
     statusBadge.textContent = data.status;
   }
   ```

   Show Cancel button section for processing and queued jobs:
   ```js
   const cancelSection = document.getElementById('cancel-section');
   if (data.status === 'processing' || data.status === 'queued') {
     cancelSection.style.display = 'block';
     // Reset button state (in case we're polling and it was previously "Cancelling...")
     // Only reset if not currently in "Cancelling..." state
     const cancelBtn = document.getElementById('cancel-btn');
     if (!cancelBtn.disabled) {
       cancelBtn.textContent = 'Cancel Job';
     }
   } else {
     cancelSection.style.display = 'none';
   }
   ```

   Show download section for cancelled jobs that have output files (partial results):
   Update the download section logic. Change from only showing for 'completed' to also showing for 'cancelled' when there are completed variations:
   ```js
   const hasCompletedVariations = data.files
     ? data.files.some(f => (f.completedVariations || 0) > 0)
     : false;

   if (data.status === 'completed' || (data.status === 'cancelled' && hasCompletedVariations)) {
     downloadSection.textContent = '';
     downloadSection.style.display = 'block';
     // ... (existing download button creation code)
   }
   ```

   Stop polling when status is 'cancelled':
   ```js
   if (data.status === 'completed' || data.status === 'failed' || data.status === 'cancelled') {
     stopPolling();
   }
   ```
   (Update the existing check in `fetchAndUpdateJob()` that currently only checks for 'completed' and 'failed'.)

4. **Add cancelled timestamp to summary section:**
   In the summary area of `updateJobDetailUI()`, when status is 'cancelled' and `data.cancelledAt` exists, add:
   ```js
   if (data.cancelledAt) {
     const cancelledInfo = document.createElement('p');
     cancelledInfo.className = 'cancelled-info';
     cancelledInfo.textContent = `Cancelled at ${new Date(data.cancelledAt.endsWith('Z') ? data.cancelledAt : data.cancelledAt + 'Z').toLocaleString()}`;
     summarySection.appendChild(cancelledInfo);
   }
   ```
  </action>
  <verify>
    Read the modified job-detail.js and confirm:
    1. `handleCancel` function exists and calls `apiCall` with POST method
    2. `confirm()` dialog appears before cancel request
    3. Cancel button disabled + "Cancelling..." during request
    4. Status 'cancelled' handled in badge logic with gray class
    5. Polling stops on 'cancelled' status
    6. Download section shows for cancelled jobs with completed variations
  </verify>
  <done>
    - Cancel button visible on job detail page for processing/queued jobs
    - Confirmation dialog before cancel
    - "Cancelling..." state during request
    - Button re-enables on error for retry
    - Cancelled status shows "Cancelled (X/Y)" format with gray badge
    - Partial results downloadable from cancelled jobs
    - Polling stops on cancelled status
  </done>
</task>

<task type="auto">
  <name>Task 2: Job list cancel button + cancelled status CSS</name>
  <files>
    views/job-list.js
    styles.css
  </files>
  <action>
1. **views/job-list.js** -- Add inline Cancel button and cancelled status handling.

   In `renderJobsList()`, update the status badge logic to handle 'cancelled':
   ```js
   } else if (job.status === 'cancelled') {
     statusBadge.classList.add('badge-gray');
     // Show completion count in badge
     const completedVars = job.completedVariations || 0;
     const totalVars = job.totalVariations || 0;
     statusBadge.textContent = `Cancelled (${completedVars}/${totalVars})`;
   }
   ```
   NOTE: The job list API (GET /api/jobs) currently returns `id, status, totalVideos, totalVariations, createdAt`. It does NOT return `completedVariations`. For the job list badge, use the simpler format `Cancelled` without counts (the detail page shows the full count). So:
   ```js
   } else if (job.status === 'cancelled') {
     statusBadge.classList.add('badge-gray');
     statusBadge.textContent = 'Cancelled';
   }
   ```

   In the actions section where action links are created (line ~193-211), add Cancel button for processing and queued jobs. Update the existing logic:
   ```js
   if (job.status === 'completed') {
     actionLink.textContent = 'Download';
     actionLink.className = 'btn btn-primary btn-sm';
     actions.appendChild(actionLink);
   } else if (job.status === 'processing' || job.status === 'queued') {
     // View progress/details link
     actionLink.textContent = job.status === 'processing' ? 'View Progress' : 'View Details';
     actionLink.className = 'btn btn-secondary btn-sm';
     actions.appendChild(actionLink);

     // Cancel button
     const cancelBtn = document.createElement('button');
     cancelBtn.className = 'btn btn-danger btn-sm';
     cancelBtn.textContent = 'Cancel';
     cancelBtn.addEventListener('click', async (e) => {
       e.stopPropagation(); // Don't navigate to detail
       e.preventDefault();

       const confirmed = confirm('Cancel this job? Completed variations will be kept.');
       if (!confirmed) return;

       cancelBtn.disabled = true;
       cancelBtn.textContent = 'Cancelling...';
       cancelBtn.classList.add('btn-disabled');

       try {
         await apiCall(`/api/jobs/${job.id}/cancel`, {
           method: 'POST',
           headers: { 'Content-Type': 'application/json' }
         });
         // Re-fetch job list to update UI
         fetchAndRenderJobs();
       } catch (err) {
         console.error('Cancel failed:', err);
         cancelBtn.disabled = false;
         cancelBtn.textContent = 'Cancel';
         cancelBtn.classList.remove('btn-disabled');
         alert(`Failed to cancel: ${err.message}`);
       }
     });
     actions.appendChild(cancelBtn);
   } else if (job.status === 'cancelled') {
     actionLink.href = `#job/${job.id}`;
     actionLink.textContent = 'View Details';
     actionLink.className = 'btn btn-secondary btn-sm';
     actions.appendChild(actionLink);
   } else if (job.status === 'failed') {
     actionLink.textContent = 'View Details';
     actionLink.className = 'btn btn-secondary btn-sm';
     actions.appendChild(actionLink);
   }
   ```

   Import `apiCall` at the top of job-list.js (it already imports from `../lib/api.js` -- just add `apiCall` to the existing import).

2. **styles.css** -- Add cancelled status badge and cancel button styles.

   After the existing `.status-failed` block (around line 515), add:
   ```css
   .status-cancelled {
     background: #e0e0e0;
     color: #555;
   }
   ```

   The views use `.badge` + `.badge-gray` class convention (not `.status-badge` + `.status-cancelled`). The `.badge-gray` class may not exist in CSS. Check: the existing code uses `badge-gray` for queued and expired. Since the CSS uses `.status-*` classes but the JS uses `.badge-*` classes, there's an inconsistency. Follow the JS convention and add these badge classes if they don't exist:
   ```css
   /* Badge system (used by job views) */
   .badge {
     display: inline-block;
     padding: 4px 12px;
     border-radius: 12px;
     font-size: 0.85em;
     font-weight: 600;
     text-transform: uppercase;
   }

   .badge-gray {
     background: #e0e0e0;
     color: #555;
   }

   .badge-blue {
     background: #cfe2ff;
     color: #084298;
   }

   .badge-green {
     background: #d1e7dd;
     color: #0f5132;
   }

   .badge-red {
     background: #f8d7da;
     color: #842029;
   }
   ```
   Place these right after the `.status-expired` block. NOTE: Only add these if they don't already exist in the CSS. Read the full CSS first.

   Add cancel button danger style:
   ```css
   .btn-danger {
     background: #dc3545;
     color: white;
     border: none;
     padding: 10px 20px;
     border-radius: 6px;
     cursor: pointer;
     font-size: 1em;
     font-weight: 500;
     transition: background 0.2s;
   }

   .btn-danger:hover {
     background: #c82333;
   }

   .btn-danger.btn-sm {
     padding: 6px 12px;
     font-size: 0.85em;
   }

   .btn-disabled {
     opacity: 0.6;
     cursor: not-allowed;
   }
   ```

   Add cancelled info text style:
   ```css
   .cancelled-info {
     color: #666;
     font-size: 0.9em;
     margin-top: 8px;
   }
   ```
  </action>
  <verify>
    Read the modified files and confirm:
    1. job-list.js has Cancel button for processing/queued jobs with event listener
    2. job-list.js handles 'cancelled' status in badge display
    3. job-list.js imports apiCall
    4. styles.css has .badge, .badge-gray, .badge-blue, .badge-green, .badge-red classes
    5. styles.css has .btn-danger and .btn-disabled classes
    6. styles.css has .cancelled-info class
    7. No innerHTML used -- only createElement

    Serve the frontend and verify it loads without JS errors: open browser dev tools console.
  </verify>
  <done>
    - Job list shows Cancel button for processing/queued jobs
    - Cancel button triggers confirmation dialog
    - "Cancelling..." state during cancel request
    - Cancelled jobs show gray "Cancelled" badge in job list
    - Cancelled jobs have "View Details" link
    - Badge classes (.badge, .badge-gray etc.) exist in CSS
    - Cancel button styled red (.btn-danger)
    - Disabled state styled (.btn-disabled)
  </done>
</task>

</tasks>

<verification>
1. Job detail page shows Cancel button for processing/queued jobs
2. Job list page shows inline Cancel button for processing/queued jobs
3. Clicking Cancel shows browser confirm() dialog
4. During cancellation, button shows "Cancelling..." and is disabled
5. Failed cancel re-enables button for retry
6. Cancelled jobs display gray badge with "Cancelled (X/Y)" on detail page
7. Cancelled jobs display gray "Cancelled" badge on list page
8. Cancelled jobs with completed variations show Download button on detail page
9. Polling stops when status becomes 'cancelled'
10. All DOM created with createElement (no innerHTML)
</verification>

<success_criteria>
- Cancel button appears and functions on both job detail and job list pages
- Confirmation dialog prevents accidental cancellation
- "Cancelling..." intermediate state provides user feedback
- Cancelled status visually distinct from failed (gray vs red)
- Partial results remain downloadable
- Polling behavior correct (stops on cancelled)
</success_criteria>

<output>
After completion, create `.planning/phases/12-server-job-cancellation/12-02-SUMMARY.md`
</output>
