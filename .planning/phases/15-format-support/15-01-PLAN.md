---
phase: 15-format-support
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - views/upload.js
  - server/middleware/upload.js
  - server/lib/processor.js
  - server/routes/jobs.js
  - lib/device-processing/ffmpeg-worker.js
  - lib/device-processing/worker-pool.js
autonomous: true

must_haves:
  truths:
    - "User can select .mov files via click or drag-and-drop on upload page"
    - "MOV files pass frontend validation and appear in selected file list"
    - "MOV files pass server upload validation (multer fileFilter accepts video/quicktime)"
    - "MOV files process successfully in device mode via FFmpeg.wasm"
    - "MOV files process successfully in server mode via native FFmpeg"
    - "Output is always MP4 format regardless of whether input was MP4 or MOV"
    - "ZIP download folder names are correct for MOV source files (extension stripped)"
  artifacts:
    - path: "views/upload.js"
      provides: "Frontend MOV acceptance in file input, drag-drop validation, and UI text"
      contains: "video/quicktime"
    - path: "server/middleware/upload.js"
      provides: "Server-side MOV MIME type acceptance"
      contains: "video/quicktime"
    - path: "server/lib/processor.js"
      provides: "Extension-agnostic base name extraction for output filenames"
      contains: "path.extname"
    - path: "server/routes/jobs.js"
      provides: "Extension-agnostic folder name in ZIP download"
      contains: "replace.*\\.(mp4|mov)"
    - path: "lib/device-processing/ffmpeg-worker.js"
      provides: "Extension-aware virtual filesystem naming for FFmpeg.wasm input"
      contains: "inputExt"
    - path: "lib/device-processing/worker-pool.js"
      provides: "Passes original file extension to FFmpeg worker via postMessage"
      contains: "inputExt"
  key_links:
    - from: "views/upload.js"
      to: "server/middleware/upload.js"
      via: "FormData upload -> multer fileFilter"
      pattern: "video/quicktime"
    - from: "views/upload.js"
      to: "lib/device-processing/ffmpeg-worker.js"
      via: "File object -> arrayBuffer -> worker postMessage"
      pattern: "inputExt"
    - from: "lib/device-processing/worker-pool.js"
      to: "lib/device-processing/ffmpeg-worker.js"
      via: "postMessage with inputExt field"
      pattern: "inputExt"
    - from: "server/lib/processor.js"
      to: "server/lib/ffmpeg.js"
      via: "spawnFFmpeg with input file path (FFmpeg auto-detects container)"
      pattern: "spawnFFmpeg.*upload_path"
---

<objective>
Add MOV file support across the entire upload-to-processing pipeline so users can upload .mov files alongside .mp4, with output always in MP4 format.

Purpose: MOV is the native format for iPhone/Mac screen recordings and many professional video tools. Ad creative teams frequently have MOV source files that currently get rejected.

Output: All 6 files updated to accept, validate, and correctly process MOV files in both device and server modes.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@views/upload.js
@server/middleware/upload.js
@server/lib/processor.js
@server/routes/jobs.js
@lib/device-processing/ffmpeg-worker.js
@lib/device-processing/worker-pool.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MOV acceptance to frontend upload and server middleware</name>
  <files>views/upload.js, server/middleware/upload.js</files>
  <action>
**views/upload.js:**

1. Line 68 - Change `fileInput.accept` from `'video/mp4'` to `'video/mp4,.mov,video/quicktime'` so the file picker shows both MP4 and MOV files.

2. Line 60 - Change instructions text from `'Upload one or more MP4 files to create variations.'` to `'Upload one or more MP4 or MOV files to create variations.'`.

3. Line 166 - Change drop zone text from `'Click to select files or drag and drop MP4 videos here'` to `'Click to select files or drag and drop videos here'`.

4. Lines 373-400 - Refactor the `addFiles()` function to accept both MP4 and MOV:
   - Rename `mp4Files` to `validFiles` and `nonMp4Files` to `rejectedFiles`.
   - Change the condition on line 379 to also match MOV: `file.type === 'video/mp4' || file.type === 'video/quicktime' || file.name.toLowerCase().endsWith('.mp4') || file.name.toLowerCase().endsWith('.mov')`.
   - Update the warning message on line 395 from `'non-MP4 file(s) skipped. Only MP4 videos are accepted.'` to `'unsupported file(s) skipped. Only MP4 and MOV videos are accepted.'`.
   - Update variable references from `mp4Files` to `validFiles` and `nonMp4Files` to `rejectedFiles` throughout the function.

**server/middleware/upload.js:**

5. Line 24 - Change the fileFilter condition from `file.mimetype === 'video/mp4'` to accept both: `['video/mp4', 'video/quicktime'].includes(file.mimetype)`. Note: Some systems report MOV as `video/quicktime`, this is the standard MIME type for MOV.

6. Line 26 - Change error message from `'Only MP4 files are accepted'` to `'Only MP4 and MOV files are accepted'`.
  </action>
  <verify>
Verify with manual inspection:
- `grep -n 'quicktime\|\.mov' views/upload.js` shows acceptance of MOV in file input accept attribute, type check, and extension check.
- `grep -n 'quicktime\|\.mov' server/middleware/upload.js` shows MOV MIME type accepted in fileFilter.
- `grep -n 'non-MP4' views/upload.js` returns no results (old message replaced).
- `grep -n 'Only MP4 files' server/middleware/upload.js` returns no results (old message replaced).
  </verify>
  <done>
- File input accept attribute includes video/quicktime and .mov
- Frontend addFiles() validates both MP4 and MOV by type and extension
- Server multer fileFilter accepts video/quicktime MIME type
- UI text updated to reference both formats
- Warning messages reference both formats
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix extension handling in server processor, download route, and device worker</name>
  <files>server/lib/processor.js, server/routes/jobs.js, lib/device-processing/ffmpeg-worker.js, lib/device-processing/worker-pool.js</files>
  <action>
**server/lib/processor.js:**

1. Line 50 - Replace `path.basename(file.original_name, '.mp4')` with `path.basename(file.original_name, path.extname(file.original_name))` so it correctly strips any extension (.mp4, .mov, or others) from the original filename. This is the idiomatic Node.js way to strip extensions generically. The output filename on line 51 already appends `.mp4`, which is correct (output always MP4).

**server/routes/jobs.js:**

2. Line 177 - Replace `jf.original_name.replace(/\.mp4$/i, '')` with `jf.original_name.replace(/\.(mp4|mov)$/i, '')` so ZIP folder names are correct for both MP4 and MOV source files. Using explicit extensions rather than a generic strip because this is user-visible naming in the ZIP structure.

**lib/device-processing/ffmpeg-worker.js:**

3. The `processVideo` function currently hardcodes `input.mp4` as the virtual filesystem filename. FFmpeg.wasm uses the file extension to determine the input demuxer/container format. For MOV files, the input must have a `.mov` extension so FFmpeg correctly identifies the QuickTime container.

   Modify `processVideo` to accept an `inputExt` parameter (the original file extension):
   - Update the function signature to: `async function processVideo(videoData, effect, outputName, inputExt)`
   - Derive the input filename: `const inputFilename = 'input' + (inputExt || '.mp4');`
   - Replace all 4 occurrences of the string `'input.mp4'` with `inputFilename`:
     - `ffmpeg.writeFile(inputFilename, ...)` (line 87)
     - `'-i', inputFilename` in the exec args (line 94)
     - `ffmpeg.deleteFile(inputFilename)` (line 105)
   - The output remains `'output.mp4'` (always MP4 output) - do NOT change output filename.
   - In the message handler `case 'process':` (around line 139), destructure `inputExt` from `e.data` and pass it: `const { videoData, effect, outputName, inputExt } = e.data;` then `await processVideo(videoData, effect, outputName, inputExt);`

**lib/device-processing/worker-pool.js:**

4. In `lib/device-processing/worker-pool.js` line 170-181, the `processNext()` method sends the process message to the worker. Add `inputExt` to the message payload:
   - Before the `postMessage` call, extract the extension from the original video file name. The `processVideo` method (line 99) receives `videoFile` which is a File object with a `.name` property. Store the extension when creating jobs.
   - In the `processVideo` method around line 108, after extracting `videoBaseName`, also extract: `const videoExt = '.' + videoFile.name.split('.').pop().toLowerCase();`
   - Store `videoExt` on the class instance: `this.currentVideoExt = videoExt;`
   - In `processNext()`, add `inputExt: this.currentVideoExt` to the postMessage data object alongside `videoData`, `effect`, and `outputName`.
  </action>
  <verify>
Verify with manual inspection:
- `grep -n 'path.extname' server/lib/processor.js` shows generic extension stripping.
- `grep -n 'mp4|mov' server/routes/jobs.js` shows both extensions handled in folder name.
- `grep -n 'inputFilename\|inputExt' lib/device-processing/ffmpeg-worker.js` shows extension-aware virtual file naming.
- `grep -n 'inputExt\|currentVideoExt' lib/device-processing/worker-pool.js` shows extension passed to worker.
- Verify no remaining hardcoded `'input.mp4'` in ffmpeg-worker.js: `grep -c "input.mp4" lib/device-processing/ffmpeg-worker.js` should return 0.
  </verify>
  <done>
- Server processor strips any extension generically using path.extname
- ZIP download route strips both .mp4 and .mov for folder names
- FFmpeg.wasm worker uses correct input file extension so FFmpeg identifies the container format
- Worker pool passes the original file extension to the worker
- Output is always .mp4 regardless of input format in all code paths
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Frontend validation: The file input `accept` attribute includes `.mov` and `video/quicktime`.
2. Frontend filtering: `addFiles()` accepts both MP4 and MOV files by MIME type and extension.
3. Server validation: multer fileFilter accepts `video/quicktime` alongside `video/mp4`.
4. Server processing: `processor.js` strips extensions generically, always outputs `.mp4`.
5. Server download: ZIP folder names correctly strip `.mov` extension.
6. Device processing: FFmpeg.wasm receives correct input extension for container detection.
7. All output files are `.mp4` regardless of input format (no changes needed - already the case).
8. No hardcoded `'input.mp4'` remains in ffmpeg-worker.js.
</verification>

<success_criteria>
- MOV files can be selected via the file picker (accept attribute includes .mov)
- MOV files dropped on drop zone pass validation and appear in file list
- MOV files uploaded to server are accepted by multer (video/quicktime MIME type)
- Server FFmpeg processes MOV input and produces MP4 output (native FFmpeg handles this natively)
- Device FFmpeg.wasm processes MOV input with correct virtual filesystem extension
- ZIP download folder names are clean for both MP4 and MOV source files
- All UI text references both MP4 and MOV formats
</success_criteria>

<output>
After completion, create `.planning/phases/15-format-support/15-01-SUMMARY.md`
</output>
