---
phase: 06-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/package.json
  - server/index.js
  - server/db/index.js
  - server/db/schema.js
  - server/db/queries.js
  - server/lib/token.js
  - server/routes/auth.js
  - server/routes/health.js
  - server/middleware/auth.js
  - server/middleware/error.js
autonomous: true

must_haves:
  truths:
    - "Server starts with `node index.js` and listens on PORT 8080"
    - "GET /api/health returns 200 with JSON status"
    - "POST /api/auth with correct password returns a bearer token"
    - "POST /api/auth with wrong password returns 401"
    - "Requests to protected routes without bearer token return 401"
    - "SQLite database is created in WAL mode with jobs and job_files tables"
  artifacts:
    - path: "server/package.json"
      provides: "ESM package with express, better-sqlite3, multer, nanoid, cors dependencies"
      contains: "type.*module"
    - path: "server/index.js"
      provides: "Express 5 app with middleware chain and server startup"
      exports: ["default"]
    - path: "server/db/index.js"
      provides: "Database initialization with WAL mode and pragmas"
      exports: ["initDatabase"]
    - path: "server/db/schema.js"
      provides: "CREATE TABLE statements for jobs and job_files"
      exports: ["createTables"]
    - path: "server/db/queries.js"
      provides: "Prepared statement wrappers for job and file CRUD"
      exports: ["createJobQueries"]
    - path: "server/lib/token.js"
      provides: "HMAC token generation and verification using node:crypto"
      exports: ["generateToken", "verifyToken", "checkPassword"]
    - path: "server/routes/auth.js"
      provides: "POST /api/auth endpoint"
      exports: ["authRouter"]
    - path: "server/routes/health.js"
      provides: "GET /api/health endpoint"
      exports: ["healthRouter"]
    - path: "server/middleware/auth.js"
      provides: "Bearer token verification middleware"
      exports: ["requireAuth"]
    - path: "server/middleware/error.js"
      provides: "Global Express error handler"
      exports: ["errorHandler"]
  key_links:
    - from: "server/index.js"
      to: "server/db/index.js"
      via: "initDatabase() call on startup"
      pattern: "initDatabase"
    - from: "server/routes/auth.js"
      to: "server/lib/token.js"
      via: "checkPassword + generateToken imports"
      pattern: "import.*token\\.js"
    - from: "server/middleware/auth.js"
      to: "server/lib/token.js"
      via: "verifyToken import"
      pattern: "verifyToken"
    - from: "server/index.js"
      to: "server/routes/health.js"
      via: "app.use('/api/health', healthRouter)"
      pattern: "api/health"
---

<objective>
Create the Express 5 server foundation with SQLite database, shared-password authentication, and health endpoint.

Purpose: Establish the runnable server skeleton that all subsequent API routes (jobs, upload) will mount onto. After this plan, `node server/index.js` starts a working server that responds to health checks and authenticates users.

Output: 10 files in `server/` directory -- a fully functional Express app with DB, auth, and health.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-foundation/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server package and database layer</name>
  <files>
    server/package.json
    server/db/index.js
    server/db/schema.js
    server/db/queries.js
  </files>
  <action>
Create the `server/` directory structure.

**server/package.json:**
```json
{
  "name": "video-refresher-api",
  "version": "2.0.0",
  "type": "module",
  "private": true,
  "scripts": {
    "start": "node index.js",
    "dev": "node --watch --env-file=.env index.js"
  },
  "dependencies": {
    "express": "^5.2.0",
    "multer": "^2.0.2",
    "better-sqlite3": "^12.6.0",
    "nanoid": "^5.0.0",
    "cors": "^2.8.5"
  }
}
```

Then run `cd server && npm install` to generate package-lock.json and install dependencies.

**server/db/index.js:**
- Export `initDatabase(dbPath)` function
- Create parent directory with `fs.mkdirSync(dir, { recursive: true })`
- Open database with `new Database(dbPath)`
- Set pragmas: `journal_mode = WAL`, `busy_timeout = 5000`, `foreign_keys = ON`, `synchronous = NORMAL`
- Call `createTables(db)` from schema.js
- Return the db instance
- Follow the exact pattern from 06-RESEARCH.md "Pattern 4"

**server/db/schema.js:**
- Export `createTables(db)` function
- Use `db.exec()` to run the schema SQL from research:
  - `jobs` table: id (TEXT PK), status (TEXT DEFAULT 'queued'), created_at, updated_at, expires_at, total_videos, total_variations, error
  - `job_files` table: id (TEXT PK), job_id (TEXT FK -> jobs.id ON DELETE CASCADE), original_name, upload_path, file_size, status (DEFAULT 'queued'), created_at
  - Indexes: idx_jobs_status, idx_jobs_expires, idx_job_files_job_id
- Use CREATE TABLE IF NOT EXISTS and CREATE INDEX IF NOT EXISTS (idempotent)

**server/db/queries.js:**
- Export `createJobQueries(db)` function that returns an object with prepared statements:
  - `insertJob(id, totalVideos, totalVariations)` -- INSERT INTO jobs with expires_at = datetime('now', '+24 hours')
  - `insertJobFile(id, jobId, originalName, uploadPath, fileSize)` -- INSERT INTO job_files
  - `getJob(id)` -- SELECT * FROM jobs WHERE id = ?
  - `getJobFiles(jobId)` -- SELECT * FROM job_files WHERE job_id = ?
  - `listJobs()` -- SELECT * FROM jobs ORDER BY created_at DESC LIMIT 50
- Use `db.prepare()` for all queries (better-sqlite3 prepared statements)
  </action>
  <verify>
Run from project root:
```bash
cd server && node -e "
import { initDatabase } from './db/index.js';
const db = initDatabase('/tmp/test-vr.db');
console.log('WAL mode:', db.pragma('journal_mode', { simple: true }));
console.log('Tables:', db.prepare(\"SELECT name FROM sqlite_master WHERE type='table'\").all());
db.close();
import('fs').then(fs => fs.unlinkSync('/tmp/test-vr.db'));
"
```
Should print WAL mode and list jobs + job_files tables.
  </verify>
  <done>
- server/package.json exists with "type": "module" and all 5 dependencies
- node_modules/ populated via npm install
- Database initializes in WAL mode with jobs and job_files tables
- Prepared queries create and retrieve jobs and files
  </done>
</task>

<task type="auto">
  <name>Task 2: Create auth system, health route, error handler, and Express app</name>
  <files>
    server/lib/token.js
    server/routes/auth.js
    server/routes/health.js
    server/middleware/auth.js
    server/middleware/error.js
    server/index.js
  </files>
  <action>
**server/lib/token.js:**
- Import `crypto` from `node:crypto`
- `TOKEN_SECRET`: read from `process.env.TOKEN_SECRET`, fallback to `crypto.randomBytes(32).toString('hex')` (generates random secret on startup if not set -- fine for single-instance)
- `TOKEN_EXPIRY_MS`: 24 hours (24 * 60 * 60 * 1000)
- Export `generateToken()`: Create timestamp string, HMAC-SHA256 it with TOKEN_SECRET, return base64url-encoded `timestamp:hmac`
- Export `verifyToken(token)`: Decode base64url, split on ':', check expiry, timing-safe compare HMAC. Return boolean.
- Export `checkPassword(input)`: Compare against `process.env.AUTH_PASSWORD` using `crypto.timingSafeEqual`. Return false if lengths differ or no password set.
- Follow exact pattern from 06-RESEARCH.md "Pattern 5"

**server/middleware/auth.js:**
- Export `requireAuth` middleware function
- Extract `Authorization` header, check `Bearer ` prefix
- Call `verifyToken(token)` from lib/token.js
- Return 401 JSON `{ error: "Authorization required" }` if missing header
- Return 401 JSON `{ error: "Invalid or expired token" }` if token invalid
- Call `next()` on success

**server/routes/auth.js:**
- Export `authRouter` using `Router()` from express
- POST `/` handler: extract `password` from `req.body`, validate with `checkPassword()`, generate token with `generateToken()`, return `{ token }`
- Return 400 if no password in body
- Return 401 if password wrong

**server/routes/health.js:**
- Export `healthRouter` using `Router()` from express
- GET `/` handler: check `fs.existsSync(DATA_DIR)` for volume mount status
- Return JSON: `{ status: "ok", timestamp, volumeMounted, nodeVersion, uptime }`

**server/middleware/error.js:**
- Export `errorHandler(err, req, res, next)` -- the 4-arg Express error handler
- Handle Multer-specific error codes: LIMIT_FILE_SIZE (413), LIMIT_FILE_COUNT (400)
- Log `err.stack` to console.error
- Default: return `err.status || 500` with `{ error: err.message || "Internal server error" }`

**server/index.js:**
- Import express, cors, fs from node:fs, path from node:path
- Import all routes: authRouter, healthRouter
- Import errorHandler from middleware/error.js
- Import initDatabase from db/index.js
- Import createJobQueries from db/queries.js
- Read env vars: PORT (default 8080), DATA_DIR (default '/data'), DB_PATH, UPLOAD_DIR, OUTPUT_DIR
- Call `verifyVolume()` function: ensure DATA_DIR, UPLOAD_DIR, OUTPUT_DIR, and `${DATA_DIR}/tmp` directories exist (mkdir recursive). Write + delete test file to verify writable. On error, log FATAL and exit(1). **Important:** In local dev (no /data mount), use `./data` as fallback -- check `process.env.DATA_DIR || './data'` for local dev.
- Initialize database: `const db = initDatabase(DB_PATH)`
- Create Express app
- Apply CORS: origin array includes `https://video-refresher.pages.dev` and `http://localhost:8000`, methods GET/POST/DELETE/OPTIONS, allowedHeaders Content-Type/Authorization
- Apply `express.json()` middleware
- Mount routes: `/api/health` (no auth), `/api/auth` (no auth)
- Apply errorHandler as last middleware
- `app.listen(PORT)` with startup log
- Store db and queries on `app.locals` so routes can access: `app.locals.db = db; app.locals.queries = createJobQueries(db);`

**Local dev consideration:** For local development without Fly Volume, use relative `./data` directory. The `verifyVolume()` function should create it. Set env vars via `server/.env` file:
```
PORT=8080
DATA_DIR=./data
DB_PATH=./data/video-refresher.db
UPLOAD_DIR=./data/uploads
OUTPUT_DIR=./data/output
AUTH_PASSWORD=devpassword123
```
Create this `server/.env` file as well. Add `server/.env` to the project's `.gitignore`.
  </action>
  <verify>
1. Create server/.env with AUTH_PASSWORD=testpass123 and DATA_DIR=./data and DB_PATH=./data/test.db and UPLOAD_DIR=./data/uploads and OUTPUT_DIR=./data/output
2. Start server: `cd server && node --env-file=.env index.js &`
3. Test health: `curl http://localhost:8080/api/health` -- expect 200 with status: ok
4. Test auth (no password): `curl -X POST http://localhost:8080/api/auth -H "Content-Type: application/json" -d '{}'` -- expect 400
5. Test auth (wrong password): `curl -X POST http://localhost:8080/api/auth -H "Content-Type: application/json" -d '{"password":"wrong"}'` -- expect 401
6. Test auth (correct password): `curl -X POST http://localhost:8080/api/auth -H "Content-Type: application/json" -d '{"password":"testpass123"}'` -- expect 200 with token
7. Kill the server process
8. Clean up: rm -rf server/data
  </verify>
  <done>
- `node --env-file=.env index.js` starts server on port 8080 without errors
- GET /api/health returns 200 with JSON containing status, timestamp, volumeMounted, nodeVersion, uptime
- POST /api/auth with correct password returns 200 with bearer token
- POST /api/auth with wrong/missing password returns 401/400
- Requests without Authorization header to protected routes return 401
- SQLite database file created on startup in WAL mode
- server/.env file exists with local dev defaults (gitignored)
  </done>
</task>

</tasks>

<verification>
- `cd server && npm install` completes without errors
- Server starts and binds to port 8080
- Health endpoint responds with 200
- Auth flow works: POST password -> receive token -> use token in Authorization header
- Database created with correct schema (jobs + job_files tables, WAL mode)
- Error handler catches and formats errors as JSON
</verification>

<success_criteria>
- Express 5 server starts and listens on configurable port
- SQLite database initializes with WAL mode, foreign keys, busy timeout
- Health endpoint returns server status without authentication
- Auth endpoint exchanges correct password for bearer token
- Auth middleware rejects requests without valid token
- Error handler returns structured JSON errors
- All files use ESM imports ("type": "module")
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-foundation/06-01-SUMMARY.md`
</output>
