---
phase: 06-backend-foundation
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - Dockerfile
  - fly.toml
  - .dockerignore
  - .gitignore
autonomous: false

must_haves:
  truths:
    - "Docker image builds successfully with node:22-slim + FFmpeg"
    - "Fly.io app deploys and health endpoint responds at public URL"
    - "3GB volume is mounted at /data and writable"
    - "SQLite database persists on the volume across server restarts"
    - "All API endpoints work on the deployed instance (auth, upload, job status)"
    - "CORS allows requests from video-refresher.pages.dev"
  artifacts:
    - path: "Dockerfile"
      provides: "Docker build for Node.js 22 + FFmpeg server"
      contains: "node:22-slim"
    - path: "fly.toml"
      provides: "Fly.io app configuration with volume mount and health checks"
      contains: "vr_data"
    - path: ".dockerignore"
      provides: "Exclude non-server files from Docker context"
      contains: ".planning"
  key_links:
    - from: "Dockerfile"
      to: "server/package.json"
      via: "COPY server/package.json and npm ci"
      pattern: "COPY server/"
    - from: "fly.toml"
      to: "server/index.js"
      via: "PORT=8080 env var and /api/health check path"
      pattern: "api/health"
    - from: "fly.toml"
      to: "/data mount"
      via: "vr_data volume -> /data destination"
      pattern: "destination.*data"

user_setup:
  - service: fly.io
    why: "Server deployment target"
    env_vars:
      - name: AUTH_PASSWORD
        source: "Choose a shared password for team access. Set via: fly secrets set AUTH_PASSWORD=your-password-here"
      - name: TOKEN_SECRET
        source: "Generate with: openssl rand -hex 32. Set via: fly secrets set TOKEN_SECRET=your-hex-string"
    dashboard_config:
      - task: "Ensure Fly.io CLI is authenticated"
        location: "Terminal: run 'fly auth login' if not already authenticated"
---

<objective>
Create deployment configuration (Dockerfile, fly.toml, .dockerignore), deploy to Fly.io, and verify the complete API works in production.

Purpose: The server must be live on Fly.io with a persistent volume, running Docker container with Node.js 22 + FFmpeg, and all endpoints verified. This is the final validation that the backend foundation is real, not just local.

Output: 3 deployment config files + a live, verified Fly.io deployment.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-foundation/06-RESEARCH.md
@.planning/phases/06-backend-foundation/06-01-SUMMARY.md
@.planning/phases/06-backend-foundation/06-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dockerfile, fly.toml, and .dockerignore</name>
  <files>
    Dockerfile
    fly.toml
    .dockerignore
    .gitignore
  </files>
  <action>
All three files go in the project root (NOT inside server/).

**Dockerfile** (project root):
```dockerfile
FROM node:22-slim

# Install FFmpeg (needed for Phase 7, install now to verify Docker works)
RUN apt-get update && \
    apt-get install -y --no-install-recommends ffmpeg && \
    rm -rf /var/lib/apt/lists/*

# Set TMPDIR to volume path (avoid /tmp RAM disk on Fly.io)
ENV TMPDIR=/data/tmp

WORKDIR /app

# Copy package files and install dependencies
COPY server/package.json server/package-lock.json ./
RUN npm ci --production

# Copy server code
COPY server/ .

# Verify FFmpeg is accessible
RUN ffmpeg -version > /dev/null 2>&1

EXPOSE 8080

CMD ["node", "index.js"]
```

**IMPORTANT note on Dockerfile:** The `COPY server/package.json server/package-lock.json ./` copies both files into WORKDIR `/app`. Then `COPY server/ .` copies the full server directory contents into `/app`. This means the final image has `/app/index.js`, `/app/routes/`, etc. -- NOT `/app/server/index.js`. The CMD runs `node index.js` from `/app`. If `server/package-lock.json` does not exist yet, remove it from the COPY line or use a glob pattern: `COPY server/package*.json ./`.

**fly.toml** (project root):
Use the exact configuration from 06-RESEARCH.md. Key settings:
- `app = "video-refresher-api"` (the user may need to change this if the name is taken)
- `primary_region = "iad"`
- `kill_signal = "SIGTERM"`, `kill_timeout = 30`
- `[env]`: NODE_ENV=production, PORT=8080, DATA_DIR=/data, DB_PATH=/data/video-refresher.db, UPLOAD_DIR=/data/uploads, OUTPUT_DIR=/data/output
- `[http_service]`: internal_port=8080, force_https=true, auto_stop_machines="stop", auto_start_machines=true, min_machines_running=1
- `[[http_service.checks]]`: GET /api/health every 30s
- `[mounts]`: source="vr_data", destination="/data", initial_size="3GB"
- `[[vm]]`: memory="512MB", cpu_kind="shared", cpus=2

**.dockerignore** (project root):
```
.git
.gitignore
.planning
node_modules
*.md
README*
DEPLOYMENT*
server.py
wrangler.toml
_headers
_redirects
app.js
index.html
styles.css
ffmpeg-worker.js
server/node_modules
server/.env
```

**Update .gitignore** (project root):
Add these lines if not already present:
```
server/.env
server/data/
```
This prevents local dev secrets and test data from being committed.
  </action>
  <verify>
Verify Docker build locally (if Docker is available):
```bash
docker build -t video-refresher-api . 2>&1 | tail -5
```
If Docker not available, verify file contents are correct:
```bash
head -1 Dockerfile  # Should show: FROM node:22-slim
head -1 fly.toml    # Should show: app = "video-refresher-api"
wc -l .dockerignore # Should have ~12 lines
```
  </verify>
  <done>
- Dockerfile exists in project root with node:22-slim base, FFmpeg install, and server code copy
- fly.toml exists with 3GB volume mount, health checks, min_machines_running=1, and all env vars
- .dockerignore excludes frontend files, .planning, .git, and node_modules
- .gitignore updated with server/.env and server/data/
  </done>
</task>

<task type="auto">
  <name>Task 2: Deploy to Fly.io</name>
  <files></files>
  <action>
Deploy the application to Fly.io using the CLI.

**Step 1: Check Fly CLI is available and authenticated**
```bash
fly version
fly auth whoami
```
If not authenticated, this becomes a checkpoint (user must run `fly auth login`).

**Step 2: Launch the app (first deploy)**
If the app does not exist yet on Fly.io:
```bash
fly launch --no-deploy --copy-config
```
This registers the app with Fly.io using the fly.toml config without deploying yet.

If the app already exists, skip this step.

**Step 3: Set secrets**
The user must provide AUTH_PASSWORD. Prompt them if needed. TOKEN_SECRET can be auto-generated:
```bash
fly secrets set TOKEN_SECRET=$(openssl rand -hex 32)
```
AUTH_PASSWORD must be set by the user:
```bash
fly secrets set AUTH_PASSWORD=<user-provided-password>
```

**Step 4: Deploy**
```bash
fly deploy
```
This builds the Docker image remotely, creates the volume on first deploy (via initial_size), and starts the machine.

**Step 5: Verify deployment**
```bash
# Check app status
fly status

# Check health endpoint
fly proxy 8080:8080 &
sleep 2
curl -s http://localhost:8080/api/health
kill %1

# Or use the public URL directly:
curl -s https://video-refresher-api.fly.dev/api/health
```

**Step 6: Verify volume**
```bash
fly volumes list
fly ssh console -C "ls -la /data"
fly ssh console -C "cat /data/video-refresher.db" | head -c 16 | xxd  # Should show SQLite header
```
  </action>
  <verify>
```bash
# Health check responds
curl -s https://video-refresher-api.fly.dev/api/health | grep '"status":"ok"'

# Volume is mounted (check health response)
curl -s https://video-refresher-api.fly.dev/api/health | grep '"volumeMounted":true'

# Machine is running
fly status | grep running
```
  </verify>
  <done>
- Fly.io app is deployed and running
- Health endpoint responds at public URL
- 3GB volume mounted at /data
- Secrets (AUTH_PASSWORD, TOKEN_SECRET) configured
- Docker container runs Node.js 22 with FFmpeg available
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete backend API deployed to Fly.io with:
- Health endpoint (GET /api/health)
- Auth endpoint (POST /api/auth) with shared password
- Job upload endpoint (POST /api/jobs) with multi-file MP4 upload
- Job status endpoint (GET /api/jobs/:id)
- Job list endpoint (GET /api/jobs)
- SQLite database on 3GB persistent volume
- Docker container with Node.js 22 + FFmpeg
  </what-built>
  <how-to-verify>
Run these curl commands against the live deployment (replace URL if app name differs):

1. Health check:
   ```bash
   curl https://video-refresher-api.fly.dev/api/health
   ```
   Expected: 200 with `{"status":"ok","volumeMounted":true,...}`

2. Authenticate:
   ```bash
   curl -X POST https://video-refresher-api.fly.dev/api/auth \
     -H "Content-Type: application/json" \
     -d '{"password":"YOUR_PASSWORD"}'
   ```
   Expected: 200 with `{"token":"..."}`

3. Upload a test video (use any small MP4):
   ```bash
   TOKEN="paste-token-here"
   curl -X POST https://video-refresher-api.fly.dev/api/jobs \
     -H "Authorization: Bearer $TOKEN" \
     -F "videos=@/path/to/small-test.mp4;type=video/mp4" \
     -F "variations=3"
   ```
   Expected: 202 with jobId, files array, variationsPerVideo

4. Check job status:
   ```bash
   JOB_ID="paste-job-id-here"
   curl https://video-refresher-api.fly.dev/api/jobs/$JOB_ID \
     -H "Authorization: Bearer $TOKEN"
   ```
   Expected: 200 with job details and file entries (status: queued)

5. Verify persistence -- restart the machine and check the job still exists:
   ```bash
   fly machines restart
   sleep 10
   curl https://video-refresher-api.fly.dev/api/jobs/$JOB_ID \
     -H "Authorization: Bearer $TOKEN"
   ```
   Expected: Same job data returned after restart
  </how-to-verify>
  <resume-signal>Type "approved" if all 5 checks pass, or describe which checks failed</resume-signal>
</task>

</tasks>

<verification>
- Docker builds without errors (node:22-slim + FFmpeg + server code)
- Fly.io deploy succeeds (app running, health check passing)
- Volume mounted at /data with 3GB capacity
- All 5 API endpoints functional on deployed instance
- Data persists across machine restart
- CORS headers present in responses
</verification>

<success_criteria>
- Dockerfile builds a working image with Node.js 22 and FFmpeg
- fly.toml configures 3GB volume, health checks, and min_machines_running=1
- App is live on Fly.io and health endpoint responds
- Auth, upload, and job status endpoints all work on the deployed instance
- SQLite database and uploaded files persist across server restarts
- CORS allows requests from Cloudflare Pages frontend origin
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-foundation/06-03-SUMMARY.md`
</output>
