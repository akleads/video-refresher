---
phase: 06-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - server/lib/id.js
  - server/middleware/upload.js
  - server/routes/jobs.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "User can upload multiple MP4 files in a single POST request and receive a job ID back (HTTP 202)"
    - "User can query job status by job ID and see per-video entries with status: queued"
    - "User can list all jobs"
    - "Uploaded files are written to UPLOAD_DIR on the volume, not /tmp"
    - "Non-MP4 files are rejected with a clear error"
    - "Requests without valid bearer token are rejected with 401"
  artifacts:
    - path: "server/lib/id.js"
      provides: "nanoid wrapper for generating job and file IDs"
      exports: ["generateId"]
    - path: "server/middleware/upload.js"
      provides: "Multer DiskStorage configured for Fly Volume path"
      exports: ["upload"]
    - path: "server/routes/jobs.js"
      provides: "POST /api/jobs and GET /api/jobs/:id and GET /api/jobs endpoints"
      exports: ["createJobsRouter"]
    - path: "server/index.js"
      provides: "Updated Express app with jobs routes mounted"
      contains: "api/jobs"
  key_links:
    - from: "server/routes/jobs.js"
      to: "server/middleware/upload.js"
      via: "upload.array('videos', 10) in POST handler"
      pattern: "upload\\.array"
    - from: "server/routes/jobs.js"
      to: "server/db/queries.js"
      via: "queries.insertJob and queries.insertJobFile calls"
      pattern: "insertJob|insertJobFile"
    - from: "server/routes/jobs.js"
      to: "server/middleware/auth.js"
      via: "requireAuth middleware on all job routes"
      pattern: "requireAuth"
    - from: "server/index.js"
      to: "server/routes/jobs.js"
      via: "app.use('/api/jobs', createJobsRouter(...))"
      pattern: "api/jobs"
    - from: "server/middleware/upload.js"
      to: "UPLOAD_DIR env var"
      via: "Multer destination set to process.env.UPLOAD_DIR"
      pattern: "UPLOAD_DIR"
---

<objective>
Add multi-file upload and job management API routes to the Express server.

Purpose: Deliver the core API contract -- upload videos, create jobs, query job status. After this plan, the full API surface exists (auth + health + jobs) and can be verified locally via curl before deployment.

Output: 3 new files (id.js, upload.js, jobs.js) and updated index.js with jobs routes mounted.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-foundation/06-RESEARCH.md
@.planning/phases/06-backend-foundation/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create upload middleware, ID generator, and jobs routes</name>
  <files>
    server/lib/id.js
    server/middleware/upload.js
    server/routes/jobs.js
  </files>
  <action>
**server/lib/id.js:**
- Import `nanoid` from `nanoid` (ESM import)
- Export `generateId()` function that returns `nanoid()` (21-char URL-safe ID)
- This is a thin wrapper so the ID strategy can be changed in one place

**server/middleware/upload.js:**
- Import multer from `multer`, path from `node:path`
- Import `generateId` from `../lib/id.js`
- Read `UPLOAD_DIR` from `process.env.UPLOAD_DIR || './data/uploads'`
- Configure `multer.diskStorage`:
  - `destination`: callback returns `UPLOAD_DIR`
  - `filename`: callback generates `${generateId()}${path.extname(file.originalname)}` -- unique filename with original extension
- Create multer instance with:
  - `storage`: the diskStorage above
  - `limits.fileSize`: 500 * 1024 * 1024 (500MB per file)
  - `limits.files`: 10 (max 10 files per request)
  - `fileFilter`: accept only `video/mp4` mimetype. Reject others with `cb(new Error('Only MP4 files are accepted'), false)`
- Export the multer instance as `upload`
- Follow exact pattern from 06-RESEARCH.md "Pattern 3"

**server/routes/jobs.js:**
- Export `createJobsRouter(db, queries)` factory function that returns a Router
- Import `requireAuth` from `../middleware/auth.js`
- Import `upload` from `../middleware/upload.js`
- Import `generateId` from `../lib/id.js`

**POST `/` handler** (create job with uploads):
- Middleware chain: `requireAuth`, `upload.array('videos', 10)`
- Validate `req.files` exists and has length > 0 (return 400 if not)
- Read `variationsPerVideo` from `req.body.variations`, parse as int, default to 5, clamp to range 1-20
- Generate job ID with `generateId()`
- Use `queries.insertJob(jobId, req.files.length, req.files.length * variationsPerVideo)` to insert job row
- Loop over `req.files`, for each: generate file ID, call `queries.insertJobFile(fileId, jobId, f.originalname, f.path, f.size)`
- Collect file info into response array
- Return HTTP 202 with JSON:
  ```json
  {
    "jobId": "...",
    "status": "queued",
    "files": [{ "id": "...", "name": "original.mp4", "size": 12345 }],
    "variationsPerVideo": 5,
    "totalVariations": 15,
    "statusUrl": "/api/jobs/{jobId}"
  }
  ```

**GET `/:id` handler** (job status):
- Middleware: `requireAuth`
- Use `queries.getJob(req.params.id)` to fetch job
- Return 404 `{ error: "Job not found" }` if null
- Use `queries.getJobFiles(req.params.id)` to fetch files
- Return JSON:
  ```json
  {
    "jobId": "...",
    "status": "queued",
    "totalVideos": 3,
    "totalVariations": 15,
    "files": [{ "id": "...", "name": "...", "size": 12345, "status": "queued" }],
    "createdAt": "...",
    "expiresAt": "...",
    "error": null
  }
  ```

**GET `/` handler** (list jobs):
- Middleware: `requireAuth`
- Use `queries.listJobs()` to get recent jobs
- Return JSON array of job summaries (id, status, totalVideos, totalVariations, createdAt)
  </action>
  <verify>
Run from project root -- verify imports resolve and module loads:
```bash
cd server && node -e "import('./routes/jobs.js').then(m => console.log('Jobs module loaded, exports:', Object.keys(m)))"
```
Should print: `Jobs module loaded, exports: [ 'createJobsRouter' ]`
  </verify>
  <done>
- server/lib/id.js exports generateId() returning nanoid strings
- server/middleware/upload.js exports configured Multer instance with DiskStorage on UPLOAD_DIR
- server/routes/jobs.js exports createJobsRouter factory with POST /, GET /:id, GET / routes
- All routes require bearer token auth
- Upload accepts up to 10 MP4 files, 500MB each, rejects non-MP4
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount jobs routes and verify full API locally</name>
  <files>
    server/index.js
  </files>
  <action>
**Update server/index.js:**
- Add import for `createJobsRouter` from `./routes/jobs.js`
- After database initialization and queries creation, create jobs router: `const jobsRouter = createJobsRouter(db, queries)`
- Mount: `app.use('/api/jobs', jobsRouter)` -- place AFTER auth and health routes, BEFORE errorHandler

**Verify the full API locally:**
1. Start server with `node --env-file=.env index.js`
2. Authenticate: POST /api/auth to get a token
3. Upload test: Create a small test MP4 file (use ffmpeg to generate a 1-second test video if available, otherwise use a tiny valid MP4 binary). POST to /api/jobs with multipart form data including the test file and `variations=3`.
4. Check response is 202 with jobId, files array, and variationsPerVideo.
5. Query job status: GET /api/jobs/{jobId} with bearer token -- verify per-video entries with status: queued.
6. List jobs: GET /api/jobs with bearer token -- verify job appears in list.
7. Test error cases: upload with no files (400), upload without auth (401), get nonexistent job (404).
8. Clean up: kill server, remove test data directory.

If ffmpeg is not available locally for test MP4 generation, create a minimal valid MP4 file using Node.js (a tiny valid ftyp+moov MP4 header is ~300 bytes). Alternatively, test upload with a small text file renamed to .mp4 to verify Multer accepts based on mimetype (set Content-Type: video/mp4 in the multipart form).
  </action>
  <verify>
Start server and run full verification sequence:
```bash
# Start server
cd server && node --env-file=.env index.js &
SERVER_PID=$!
sleep 1

# Get auth token
TOKEN=$(curl -s -X POST http://localhost:8080/api/auth \
  -H "Content-Type: application/json" \
  -d '{"password":"testpass123"}' | node -e "process.stdin.on('data',d=>console.log(JSON.parse(d).token))")

# Upload test (create minimal test file)
dd if=/dev/zero bs=1024 count=1 of=/tmp/test.mp4 2>/dev/null
UPLOAD_RESULT=$(curl -s -X POST http://localhost:8080/api/jobs \
  -H "Authorization: Bearer $TOKEN" \
  -F "videos=@/tmp/test.mp4;type=video/mp4" \
  -F "variations=3")
echo "Upload result: $UPLOAD_RESULT"

# Extract jobId
JOB_ID=$(echo $UPLOAD_RESULT | node -e "process.stdin.on('data',d=>console.log(JSON.parse(d).jobId))")

# Query job status
curl -s http://localhost:8080/api/jobs/$JOB_ID -H "Authorization: Bearer $TOKEN"

# List jobs
curl -s http://localhost:8080/api/jobs -H "Authorization: Bearer $TOKEN"

# Test 401 (no auth)
curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/api/jobs

# Cleanup
kill $SERVER_PID 2>/dev/null
rm -rf ./data /tmp/test.mp4
```

Expected: Upload returns 202 with jobId, status query returns job with files (status: queued), list returns array with job, unauthenticated request returns 401.
  </verify>
  <done>
- POST /api/jobs accepts multipart upload with bearer token and returns 202 with job ID
- GET /api/jobs/:id returns job with per-video file entries (status: queued)
- GET /api/jobs returns list of jobs
- Uploaded files land in UPLOAD_DIR (not /tmp)
- All job routes require valid bearer token
- Error cases return proper HTTP status codes (400, 401, 404)
  </done>
</task>

</tasks>

<verification>
- All 4 API endpoints work: health (GET), auth (POST), jobs create (POST), job status (GET), jobs list (GET)
- File upload writes to configured UPLOAD_DIR path
- Job and file records persist in SQLite
- Auth token gates all job endpoints
- Error responses are structured JSON with appropriate HTTP status codes
</verification>

<success_criteria>
- POST /api/jobs with valid token + MP4 files returns 202 with jobId and file details
- GET /api/jobs/:id with valid token returns job with per-video entries (status: queued)
- GET /api/jobs with valid token returns list of recent jobs
- Uploaded files exist on disk at UPLOAD_DIR path
- Non-MP4 files rejected, missing auth rejected, empty upload rejected
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-foundation/06-02-SUMMARY.md`
</output>
