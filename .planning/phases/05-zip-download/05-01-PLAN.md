---
phase: 05-zip-download
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - app.js
  - styles.css
autonomous: false

must_haves:
  truths:
    - "User can click 'Download All as ZIP' button after batch generation completes"
    - "ZIP file downloads containing all processed variations with STORE compression"
    - "All variation blob URLs are cleaned up after ZIP download completes"
    - "ZIP download button only appears when processedVideos has entries"
  artifacts:
    - path: "app.js"
      provides: "downloadAllAsZip() function using JSZip with STORE compression"
      contains: "downloadAllAsZip"
    - path: "app.js"
      provides: "JSZip CDN import"
      contains: "jszip"
    - path: "index.html"
      provides: "Download All as ZIP button and status text element"
      contains: "downloadAllBtn"
    - path: "styles.css"
      provides: "ZIP download button and status styling"
      contains: "download-all-btn"
  key_links:
    - from: "index.html"
      to: "app.js"
      via: "downloadAllBtn click handler"
      pattern: "downloadAllBtn.*addEventListener"
    - from: "app.js downloadAllAsZip()"
      to: "processedVideos array"
      via: "iterates processedVideos to fetch blobs and add to ZIP"
      pattern: "processedVideos.*processedURL"
    - from: "app.js downloadAllAsZip()"
      to: "blobRegistry"
      via: "revokes variation blob URLs after ZIP download"
      pattern: "blobRegistry\\.revoke"
---

<objective>
Implement ZIP download for all batch-generated video variations using JSZip with STORE compression.

Purpose: Complete the final phase of the batch processing milestone — users can download all variations as a single ZIP file instead of clicking individual download buttons 5-20 times.
Output: Working "Download All as ZIP" button that packages all processedVideos into a ZIP with STORE compression, triggers download, and cleans up blob URLs afterward.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-zip-download/05-RESEARCH.md
@.planning/phases/04-core-batch-generation/04-02-SUMMARY.md
@index.html
@app.js
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JSZip import, ZIP download button, downloadAllAsZip() function, and styling</name>
  <files>app.js, index.html, styles.css</files>
  <action>
**app.js — Add JSZip import and downloadAllAsZip() function:**

1. Add JSZip CDN import at top of file alongside existing imports:
```javascript
import JSZip from 'https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm';
```

2. Add `downloadAllAsZip()` async function (place after `generateBatch()`, before `updateProcessedVideosList()`):

The function must:
- Guard: if `processedVideos.length === 0`, return early (no alert needed, button shouldn't be visible)
- Get DOM references: `downloadAllBtn`, `zipStatus`
- Disable button, show status text "Preparing ZIP..."
- Create `new JSZip()` instance
- Loop through `processedVideos` array:
  - For each entry, `fetch(video.processedURL)` to get blob from blob URL
  - Add to zip via `zip.file(video.processedName, blob, { compression: "STORE" })`
  - Update status: `Adding file 2/10...`
- Generate ZIP blob: `zip.generateAsync({ type: "blob", compression: "STORE" }, (metadata) => { update status with metadata.percent })`
- Create blob URL for ZIP via `URL.createObjectURL(zipBlob)` (do NOT use blobRegistry for the ZIP itself — it's ephemeral)
- Derive ZIP filename: take `processedVideos[0].originalName`, strip `.mp4`, append `_variations.zip`
- Create anchor element, set href to ZIP URL, set download attribute to ZIP filename, append to body, click, remove from body
- After 500ms delay (setTimeout), revoke the ZIP blob URL via `URL.revokeObjectURL(zipURL)`
- Revoke all variation blob URLs via `blobRegistry.revoke(video.processedURL)` for each processedVideo
- Clear `processedVideos = []`
- Call `updateProcessedVideosList()` to clear the grid
- Hide the download-all button
- Update status: "ZIP downloaded successfully!" then hide status after 3 seconds
- Wrap entire body in try/catch — on error, show error in status text, log to console
- In finally block: re-enable button

3. Expose function on window for onclick: `window.downloadAllAsZip = downloadAllAsZip;`

4. Add visibility management — modify `updateProcessedVideosList()`:
After the existing function body, add logic to show/hide the "Download All as ZIP" button:
```javascript
const downloadAllBtn = document.getElementById('downloadAllBtn');
if (downloadAllBtn) {
    downloadAllBtn.style.display = processedVideos.length > 1 ? 'inline-block' : 'none';
}
```
Show the button when there are 2+ processed videos (1 video = just use individual download). Hide when array is empty.

**index.html — Add ZIP download button and status:**

In the `processed-videos-section` div (id="processedVideosSection"), after the `<h3>All Processed Videos</h3>` and before the `<div id="processedVideosList">`, add:
```html
<div class="download-all-container">
    <button id="downloadAllBtn" class="download-all-btn" onclick="downloadAllAsZip()" style="display: none;">
        Download All as ZIP
    </button>
    <p id="zipStatus" class="zip-status" style="display: none;"></p>
</div>
```

**styles.css — Add ZIP download button and status styling:**

Add after the `.batch-progress` block (before `footer`):

```css
/* ZIP download */
.download-all-container {
    margin-bottom: 1rem;
    text-align: center;
}

.download-all-btn {
    padding: 12px 2rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 1.05em;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.download-all-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
}

.download-all-btn:disabled {
    background: #6c757d;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.zip-status {
    margin-top: 0.5rem;
    font-size: 0.9em;
    color: #667eea;
    font-weight: 500;
}
```
  </action>
  <verify>
1. Open index.html in browser (via local server with COOP/COEP headers)
2. Confirm JSZip loads without console errors (check Network tab for jsdelivr request)
3. Upload a video, generate 3+ variations via batch
4. Confirm "Download All as ZIP" button appears in the processed videos section
5. Click the button — ZIP should download with `_variations.zip` suffix
6. After download, confirm processedVideos list clears and button hides
7. Confirm no blob URL memory leaks in DevTools (Application > Blob URLs or Memory tab)
  </verify>
  <done>
- JSZip imported from jsdelivr CDN without errors
- "Download All as ZIP" button visible after batch generates 2+ variations
- Clicking button downloads ZIP file containing all variations
- ZIP uses STORE compression (file sizes in ZIP match individual blob sizes)
- All variation blob URLs revoked after ZIP download
- processedVideos array cleared and UI updated after download
- Button hidden when no processed videos exist
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete ZIP download feature: JSZip integration with STORE compression, "Download All as ZIP" button with progress feedback, blob URL cleanup after download.
  </what-built>
  <how-to-verify>
1. Start local server: `python3 server.py` (from project root)
2. Open http://localhost:8080 in Chrome
3. Upload any MP4 video file
4. Set variation count to 3 and click "Generate Variations"
5. Wait for batch to complete — confirm "Download All as ZIP" button appears
6. Click "Download All as ZIP"
7. Verify:
   - Status text shows progress ("Adding file 1/3...", "Creating ZIP: XX%")
   - ZIP file downloads with name like `videoname_variations.zip`
   - After download, processed videos list clears
   - "Download All as ZIP" button disappears
8. Extract the ZIP file and verify:
   - Contains 3 MP4 files with correct variation names
   - Files play correctly
   - File sizes in ZIP match original variation sizes (STORE = no re-compression)
9. Open DevTools Console — confirm no errors
10. Optional: Upload another video and generate 1 variation — confirm ZIP button does NOT appear (only shows for 2+ videos)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 5 complete when:
- DL-01: All variations downloadable as single ZIP file via JSZip — verified by downloading ZIP after batch generation
- DL-02: ZIP uses STORE compression — verified by comparing ZIP internal file sizes to original blob sizes (should be identical, no re-compression)
- ZIP download triggered with single click after batch completes — verified by clicking button once
- All blob URLs cleaned up after ZIP download completes — verified by checking processedVideos array is empty and DevTools memory
</verification>

<success_criteria>
1. User generates batch of 3+ variations, clicks "Download All as ZIP", receives ZIP file containing all variations
2. ZIP file uses STORE compression (no size increase from re-compression)
3. After ZIP download, all variation blob URLs are revoked and processedVideos array is cleared
4. "Download All as ZIP" button only visible when 2+ processed videos exist
5. Status text provides feedback during ZIP generation ("Adding file X/Y...", "Creating ZIP: XX%")
</success_criteria>

<output>
After completion, create `.planning/phases/05-zip-download/05-01-SUMMARY.md`
</output>
