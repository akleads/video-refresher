---
phase: 09-frontend-integration
plan: 04
type: execute
wave: 3
depends_on: ["09-02", "09-03"]
files_modified:
  - ffmpeg-worker.js
  - _headers
  - app.js
autonomous: false

must_haves:
  truths:
    - "ffmpeg-worker.js is deleted from the project"
    - "No file in the project references ffmpeg, FFmpeg, wasm, jszip, or SharedArrayBuffer"
    - "COOP/COEP headers removed from _headers since SharedArrayBuffer is no longer needed"
    - "app.js properly calls cleanup functions when navigating between views"
    - "Full end-to-end flow works: login -> upload -> job progress -> download"
  artifacts:
    - path: "_headers"
      provides: "Cloudflare Pages headers without COOP/COEP"
      contains: "# No special headers"
  key_links:
    - from: "app.js"
      to: "views/job-detail.js"
      via: "calls cleanupJobDetail when navigating away from job detail"
      pattern: "cleanupJobDetail"
    - from: "app.js"
      to: "views/job-list.js"
      via: "calls cleanupJobList when navigating away from job list"
      pattern: "cleanupJobList"
---

<objective>
Remove all FFmpeg.wasm artifacts, update Cloudflare Pages headers, wire up view cleanup functions in the router, and verify the complete end-to-end flow works.

Purpose: Ensures zero traces of client-side FFmpeg processing remain and that the app functions as a complete API-driven SPA with proper resource cleanup during navigation.
Output: Clean codebase with no FFmpeg references, updated headers, and a verified end-to-end user flow.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-frontend-integration/09-CONTEXT.md
@.planning/phases/09-frontend-integration/09-01-SUMMARY.md
@.planning/phases/09-frontend-integration/09-02-SUMMARY.md
@.planning/phases/09-frontend-integration/09-03-SUMMARY.md
@app.js
@_headers
</context>

<tasks>

<task type="auto">
  <name>Task 1: Remove FFmpeg.wasm artifacts and update headers</name>
  <files>ffmpeg-worker.js, _headers, app.js</files>
  <action>
**1. Delete ffmpeg-worker.js:**
- `rm ffmpeg-worker.js`
- This file is the client-side FFmpeg Web Worker, no longer needed

**2. Update _headers file:**
- The current _headers sets Cross-Origin-Opener-Policy and Cross-Origin-Embedder-Policy for SharedArrayBuffer support (needed by FFmpeg.wasm multi-threaded mode)
- Since v2 has no client-side FFmpeg, these headers are not needed and actually RESTRICT cross-origin resource loading unnecessarily
- Replace contents with:
```
# Cloudflare Pages custom headers
# COOP/COEP removed - no longer needed without FFmpeg.wasm SharedArrayBuffer
```

**3. Update app.js -- wire cleanup functions:**
- Import `{ cleanupJobDetail }` from `./views/job-detail.js`
- Import `{ cleanupJobList }` from `./views/job-list.js`
- In the `showView()` function (or equivalent route change handler), BEFORE showing the new view:
  - Call `cleanupJobDetail()` if navigating AWAY from job detail view
  - Call `cleanupJobList()` if navigating AWAY from job list view
  - This stops polling timers when leaving those views to prevent background API calls
- Implementation: track `currentView` in module scope, on route change call cleanup for the previous view before rendering the new one

**4. Verify no FFmpeg references remain:**
- Search all frontend files (index.html, app.js, styles.css, views/*.js, lib/*.js) for:
  - 'ffmpeg' (case insensitive)
  - 'wasm'
  - 'jszip' or 'JSZip'
  - 'SharedArrayBuffer'
  - 'ffmpeg-worker'
  - 'cdn.jsdelivr.net/npm/@ffmpeg'
- All searches must return zero matches
- The server/ directory is NOT checked (server-side FFmpeg is correct and intentional)

**5. Verify no orphaned files:**
- Check that ffmpeg-worker.js no longer exists
- Check that no other FFmpeg-related files exist at the project root
  </action>
  <verify>
1. `ls ffmpeg-worker.js` returns "No such file"
2. `grep -ri 'ffmpeg\|wasm\|jszip\|SharedArrayBuffer' index.html app.js styles.css views/ lib/` returns no matches
3. `cat _headers` shows no COOP/COEP headers
4. app.js imports and calls cleanupJobDetail and cleanupJobList
  </verify>
  <done>
ffmpeg-worker.js deleted.
_headers no longer sets COOP/COEP.
app.js calls cleanup functions on view transitions.
Zero references to FFmpeg.wasm, JSZip, SharedArrayBuffer, or wasm bundles in any frontend file.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete v2 frontend: login, multi-video upload, job progress tracking with polling, job history, ZIP download -- fully API-driven with zero FFmpeg.wasm code.</what-built>
  <how-to-verify>
  1. Start the server locally: `cd server && npm start` (or ensure Fly.io deployment is accessible)
  2. Serve the frontend: `python3 -m http.server 8000` from project root (or `npx serve -p 8000`)
  3. Open http://localhost:8000 in browser

  **Login flow:**
  4. You should see a login screen with password input
  5. Enter wrong password -> error message appears inline
  6. Enter correct password -> redirected to upload page, nav tabs visible

  **Upload flow:**
  7. Drag-and-drop one or more MP4 files onto the upload zone
  8. File list shows names, sizes, and remove buttons
  9. Set variation count (e.g., 3)
  10. Click "Start Processing" -> upload progress bar appears
  11. After upload completes -> redirected to job detail page

  **Progress tracking:**
  12. Job detail shows "Queued" badge initially
  13. Status changes to "Processing" with progress bar advancing
  14. On completion: "Completed" badge, download button, expiry countdown

  **Download:**
  15. Click "Download ZIP" -> ZIP file downloads
  16. Open ZIP -> variations organized by source video name

  **Job history:**
  17. Click "My Jobs" tab -> job list shows the job(s) you created
  18. Status badges match job states
  19. Close tab, re-open -> "My Jobs" still shows jobs (session persists via localStorage)

  **Cleanup verification:**
  20. Open browser DevTools Network tab -> no requests to cdn.jsdelivr.net or any wasm files
  21. Console has no FFmpeg-related errors or logs
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. ffmpeg-worker.js does not exist
2. _headers has no COOP/COEP settings
3. Full-text search of frontend files confirms zero FFmpeg/wasm references
4. App loads without console errors
5. Complete flow: login -> upload -> progress -> download works end-to-end
6. Polling stops when navigating away from job detail/list views
7. Tab hidden -> polling pauses, tab visible -> polling resumes
</verification>

<success_criteria>
- All FFmpeg.wasm code completely removed
- COOP/COEP headers removed from Cloudflare Pages config
- View cleanup functions properly called on navigation
- End-to-end flow verified by human tester
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-integration/09-04-SUMMARY.md`
</output>
