---
phase: 09-frontend-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - index.html
  - styles.css
  - app.js
  - lib/api.js
  - lib/router.js
  - lib/utils.js
autonomous: true

must_haves:
  truths:
    - "Hash-based routing navigates between login, upload, jobs, and job detail views"
    - "API client attaches Bearer token from localStorage to all requests"
    - "401 responses from any API call redirect to login with session expired message"
    - "Index.html loads app.js as module entry point with view containers"
  artifacts:
    - path: "lib/api.js"
      provides: "Centralized API client with auth header injection and 401 handling"
      min_lines: 30
    - path: "lib/router.js"
      provides: "Hash-based SPA router with parameterized routes"
      min_lines: 20
    - path: "lib/utils.js"
      provides: "Shared helpers (formatBytes, timeUntil, formatTime)"
      min_lines: 15
    - path: "app.js"
      provides: "Main entry point with route registration and auth guard"
      min_lines: 25
    - path: "index.html"
      provides: "SPA shell with nav tabs, view containers, no FFmpeg references"
      min_lines: 30
    - path: "styles.css"
      provides: "Complete styles for login, upload, job list, job detail, nav tabs, progress bars"
      min_lines: 200
  key_links:
    - from: "app.js"
      to: "lib/router.js"
      via: "import and route registration"
      pattern: "import.*router"
    - from: "lib/api.js"
      to: "localStorage"
      via: "token retrieval for Authorization header"
      pattern: "localStorage\\.getItem.*token"
    - from: "index.html"
      to: "app.js"
      via: "script type=module src"
      pattern: "script.*module.*app\\.js"
---

<objective>
Create the SPA infrastructure: HTML shell with tab navigation, hash-based router, API client with auth/401 handling, utility functions, main app entry point, and all CSS styles for the new UI.

Purpose: Provides the foundation that all views depend on -- routing, API communication, styling, and HTML containers. Without this, no view can render or communicate with the server.
Output: 6 files forming the complete SPA skeleton that views/login.js, views/upload.js, views/job-detail.js, and views/job-list.js will plug into.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-frontend-integration/09-CONTEXT.md
@.planning/phases/09-frontend-integration/09-RESEARCH.md
@server/routes/auth.js
@server/routes/jobs.js
@server/middleware/auth.js
@server/index.js
@index.html
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lib/ modules (api.js, router.js, utils.js)</name>
  <files>lib/api.js, lib/router.js, lib/utils.js</files>
  <action>
Create the `lib/` directory at the project root (same level as index.html).

**lib/api.js** - Centralized API client:
- Determine API base URL: if `window.location.hostname === 'localhost'` use `http://localhost:8080`, otherwise use the Fly.io production URL `https://video-refresher-api.fly.dev`
- Export `async function apiCall(url, options = {})` that:
  - Reads token from `localStorage.getItem('token')`
  - Merges `Authorization: Bearer ${token}` into headers (only if token exists)
  - Calls `fetch(API_BASE + url, ...)`
  - On 401 response: removes token from localStorage, sets `window.location.hash = '#login?expired=1'`, throws Error('Session expired')
  - On non-ok response: throws Error with status and response body
  - On success: returns `response` (NOT auto-parsed JSON -- caller decides if it needs .json() or .blob())
- Export `function uploadFiles(url, formData, onProgress)` that:
  - Returns a Promise wrapping XMLHttpRequest
  - Reads token from localStorage, sets Authorization header
  - Uses `xhr.upload.addEventListener('progress', ...)` for upload progress (NOT xhr.onprogress)
  - Does NOT set Content-Type header (browser sets boundary for multipart/form-data)
  - Opens POST to `API_BASE + url`
  - Resolves with parsed JSON on success (status 200-299)
  - Rejects with Error on failure
  - On 401: clears token, redirects to login hash
- Export `function getToken()` and `function setToken(token)` and `function clearToken()` as localStorage wrappers
- Export `function isAuthenticated()` that returns true if token exists in localStorage

**lib/router.js** - Hash-based SPA router:
- Export `class Router` with:
  - `routes` Map storing pattern -> handler
  - `add(pattern, handler)` method -- pattern is a string like 'upload' or 'job/:id'
  - `start()` method -- adds hashchange listener, calls handleRoute for current hash
  - `navigate(hash)` method -- sets window.location.hash
  - `handleRoute()` internal method -- parses hash, matches pattern (supporting :param segments), calls handler with params object
- Route patterns: '' and 'login' map to login handler, 'upload' maps to upload, 'jobs' maps to job list, 'job/:id' maps to job detail
- Support query string parsing (e.g., '#login?expired=1' extracts { expired: '1' })
- Before calling the route handler, check if route requires auth (all except 'login' and '') and redirect to '#login' if not authenticated (using isAuthenticated from api.js)

**lib/utils.js** - Shared utility functions:
- Export `function formatBytes(bytes)` - human readable file sizes (B, KB, MB, GB)
- Export `function timeUntil(isoDate)` - returns 'expired', 'Xh', 'Xm', '<1m' countdown string. Append 'Z' to isoDate for UTC parsing.
- Export `function timeAgo(isoDate)` - returns 'just now', 'Xm ago', 'Xh ago', 'Xd ago'
- Export `function $(selector)` - shorthand for document.querySelector
- Export `function $$(selector)` - shorthand for document.querySelectorAll

All files use ES module syntax (import/export). No external dependencies.
  </action>
  <verify>
All three files exist in lib/ directory. Each file:
- Uses ES module exports
- Has no external import dependencies (only imports from sibling lib/ files if needed)
- Contains the functions listed above
  </verify>
  <done>
lib/api.js exports apiCall, uploadFiles, getToken, setToken, clearToken, isAuthenticated.
lib/router.js exports Router class with add, start, navigate methods.
lib/utils.js exports formatBytes, timeUntil, timeAgo, $, $$.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create index.html shell, app.js entry point, and styles.css</name>
  <files>index.html, app.js, styles.css</files>
  <action>
**index.html** - Replace the current file entirely. New structure:
```
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Video Refresher</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app">
    <!-- Nav (hidden on login page, shown on all others) -->
    <nav id="nav" class="nav" style="display:none;">
      <div class="nav-brand">Video Refresher</div>
      <div class="nav-tabs">
        <a href="#upload" class="nav-tab" data-route="upload">New Job</a>
        <a href="#jobs" class="nav-tab" data-route="jobs">My Jobs</a>
      </div>
      <button id="logoutBtn" class="nav-logout">Logout</button>
    </nav>

    <!-- View containers (only one visible at a time) -->
    <div id="view-login" class="view"></div>
    <div id="view-upload" class="view"></div>
    <div id="view-jobs" class="view"></div>
    <div id="view-job-detail" class="view"></div>
  </div>
  <script type="module" src="app.js"></script>
</body>
</html>
```
- NO FFmpeg imports, NO CDN script tags, NO JSZip references
- NO COOP/COEP meta tags (those come from _headers for Cloudflare Pages, but we won't need them in v2)
- Clean, minimal shell -- views render their content into the view containers

**app.js** - Replace current file entirely. New content:
- Import Router from lib/router.js
- Import { clearToken, isAuthenticated } from lib/api.js
- Import view render functions from views/login.js, views/upload.js, views/job-detail.js, views/job-list.js (these files will be created in Plans 02 and 03 -- for now, create simple placeholder functions that will be overwritten)
- Create router instance
- Register routes:
  - '' -> showView('login', renderLogin)
  - 'login' -> showView('login', renderLogin)
  - 'upload' -> showView('upload', renderUpload)
  - 'jobs' -> showView('jobs', renderJobList)
  - 'job/:id' -> showView('job-detail', (params) => renderJobDetail(params.id))
- `showView(viewName, renderFn)` helper:
  - Hides all .view elements
  - Shows the matching #view-{viewName} container
  - Shows/hides nav (hidden for login view, visible for all others)
  - Updates active nav tab styling
  - Calls renderFn(params) to populate the view
- Wire up logout button: clearToken() + navigate to '#login'
- Call router.start() on DOMContentLoaded
- If not authenticated and hash is not '#login', redirect to '#login'

Since views/login.js etc won't exist yet, create minimal placeholder files:
- views/login.js: `export function renderLogin(params) { document.getElementById('view-login').innerHTML = '<p>Login view loading...</p>'; }`
- views/upload.js: `export function renderUpload(params) { document.getElementById('view-upload').innerHTML = '<p>Upload view loading...</p>'; }`
- views/job-detail.js: `export function renderJobDetail(jobId) { document.getElementById('view-job-detail').innerHTML = '<p>Job detail loading...</p>'; }`
- views/job-list.js: `export function renderJobList(params) { document.getElementById('view-jobs').innerHTML = '<p>Job list loading...</p>'; }`

**styles.css** - Replace current file entirely with styles for the new UI:
- Keep the same color scheme (gradient #667eea -> #764ba2)
- Global reset (*, box-sizing)
- Body: gradient background, min-height 100vh, font-family system stack
- #app container: max-width 800px, centered, white background, rounded corners, box-shadow
- Nav: flex row, brand on left, tabs center, logout right. Tabs are anchor links styled as pills/tabs. Active tab has highlighted background.
- Login view: centered card with app title, password input, submit button, error message area. Clean and minimal.
- Upload view:
  - Drag-and-drop zone (dashed border, icon, text -- similar to v1 but updated)
  - File list with filename, size, remove button per row
  - Variation count input with label
  - Submit button
  - Upload progress bar (shown during upload)
- Job detail view:
  - Status badge (colored: queued=gray, processing=blue, completed=green, failed=red, expired=gray)
  - Overall progress bar (for processing state)
  - Summary text (file count, variation count, partial failure count)
  - Download button (large, prominent, only when completed)
  - Expiry countdown text
  - Back to jobs link
- Job list view:
  - List of job cards/rows
  - Each row: status badge, "X videos x Y variations", time ago, download/view button
  - Expired jobs grayed out
- Progress bars: same gradient style as v1 (linear-gradient #667eea -> #764ba2)
- Status badges: inline-block, small rounded pill, color-coded
- Buttons: primary (gradient), secondary (outline), danger (red for cancel)
- Form inputs: clean borders, focus states
- Responsive: stack nav tabs below brand on mobile, single column layouts
- Transitions on hover states, drag-over states
- .dragover class for upload zone active state

Do NOT include any styles for v1 components (video preview grid, processed videos grid, batch section, queue section, etc). Clean slate.
  </action>
  <verify>
1. `index.html` has no FFmpeg/JSZip/wasm references (grep for 'ffmpeg', 'jszip', 'wasm' returns nothing)
2. `index.html` has `<script type="module" src="app.js"></script>`
3. `app.js` imports from lib/router.js, lib/api.js, and all four view files
4. `styles.css` contains styles for .nav, .view, status badges, progress bars, upload area, login form
5. All placeholder view files exist in views/ directory
  </verify>
  <done>
index.html is a clean SPA shell with nav + 4 view containers, zero FFmpeg references.
app.js is the entry point with hash routing to all views and auth guard.
styles.css covers all UI components for the new 2-tab API-driven interface.
Four placeholder view files exist in views/.
  </done>
</task>

</tasks>

<verification>
1. Open index.html in browser -- should see a white container with no errors in console
2. Hash navigation works: #login, #upload, #jobs, #job/test-id all show different view containers
3. `grep -r 'ffmpeg\|jszip\|wasm' index.html app.js` returns no matches
4. All imports resolve without 404s (check Network tab)
5. lib/api.js apiCall function correctly builds Authorization header from localStorage token
</verification>

<success_criteria>
- SPA shell renders in browser without console errors
- Hash routing navigates between 4 views (login, upload, jobs, job-detail)
- Nav tabs visible on non-login views, hidden on login
- API client correctly handles auth token and 401 responses
- Styles provide complete visual foundation for all views
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-integration/09-01-SUMMARY.md`
</output>
