---
phase: 09-frontend-integration
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - views/job-detail.js
  - views/job-list.js
autonomous: true

must_haves:
  truths:
    - "Job detail page shows status badge, overall progress bar, and file summary"
    - "Job detail polls server for updates and stops polling when job completes or fails"
    - "Polling pauses when tab is hidden (Page Visibility API) and resumes when tab is visible"
    - "Completed job shows download button that triggers ZIP download"
    - "Job list shows all jobs with status badges, file/variation counts, and time ago"
    - "Job list auto-refreshes via polling while page is open"
    - "Expired jobs shown with Expired badge and no download button"
  artifacts:
    - path: "views/job-detail.js"
      provides: "Job progress/detail view with adaptive polling and download"
      min_lines: 120
    - path: "views/job-list.js"
      provides: "Job history list with polling refresh"
      min_lines: 80
  key_links:
    - from: "views/job-detail.js"
      to: "lib/api.js"
      via: "apiCall for GET /api/jobs/:id"
      pattern: "apiCall.*api/jobs/"
    - from: "views/job-detail.js"
      to: "lib/api.js"
      via: "apiCall for GET /api/jobs/:id/download (blob)"
      pattern: "api/jobs.*download"
    - from: "views/job-list.js"
      to: "lib/api.js"
      via: "apiCall for GET /api/jobs"
      pattern: "apiCall.*api/jobs"
    - from: "views/job-detail.js"
      to: "Page Visibility API"
      via: "document.addEventListener('visibilitychange')"
      pattern: "visibilitychange"
---

<objective>
Implement the job detail view (progress tracking with adaptive polling, download) and job list view (history of all jobs with status polling) -- the two output-focused views of the application.

Purpose: These views deliver the core "fire-and-forget" value: submit a job, close the tab, come back later and see results. Without them, users cannot track progress or download their processed videos.
Output: Two view files (views/job-detail.js, views/job-list.js) that replace the placeholder stubs from Plan 01.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-frontend-integration/09-CONTEXT.md
@.planning/phases/09-frontend-integration/09-RESEARCH.md
@.planning/phases/09-frontend-integration/09-01-SUMMARY.md
@server/routes/jobs.js
@lib/api.js
@lib/router.js
@lib/utils.js
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement job detail view with adaptive polling</name>
  <files>views/job-detail.js</files>
  <action>
Replace the placeholder views/job-detail.js with a complete implementation.

**Export:** `export function renderJobDetail(jobId)` and `export function cleanupJobDetail()` (for stopping polls when navigating away)

**Polling infrastructure (module-level):**
- `let pollTimer = null` - current setTimeout ID
- `let pollInterval = 2000` - starts at 2s
- `const MAX_POLL_INTERVAL = 10000` - caps at 10s
- `const BACKOFF_MULTIPLIER = 1.5`
- `let isPolling = false`
- `let currentJobId = null`
- Visibility change handler (module-level, registered once):
  - On hidden: clear pollTimer
  - On visible: if isPolling, immediately call poll()

**`renderJobDetail(jobId)` behavior:**
1. Set `currentJobId = jobId`
2. Render initial loading state into `#view-job-detail`:
   - Back link: "< Back to My Jobs" linking to #jobs
   - Job ID display (small, muted)
   - Status section: badge placeholder, progress bar placeholder
   - Summary section: empty (will be populated by poll)
   - Download section: empty (will be populated on completion)
   - Error section: empty (populated on failure)
3. Immediately fetch job status and render, then start polling
4. Register visibilitychange listener if not already registered

**`poll()` function:**
- If !isPolling or currentJobId is null, return
- Call `apiCall('/api/jobs/${currentJobId}')`
- Parse JSON response
- Call `updateJobDetailUI(data)` to update the DOM
- If job.status is 'completed' or 'failed': stop polling (call cleanupJobDetail)
- If still active (queued/processing): schedule next poll with backoff
  - `pollInterval = Math.min(pollInterval * BACKOFF_MULTIPLIER, MAX_POLL_INTERVAL)`
  - Add jitter: `interval * (1 + (Math.random() * 0.4 - 0.2))` (+-20%)
  - `pollTimer = setTimeout(poll, jitteredInterval)`
- On network error: log error, backoff more aggressively (double interval), schedule retry

**`updateJobDetailUI(data)` function:**
Update DOM elements (NOT re-render entire view -- update existing elements for smooth UX):

- **Status badge**: color-coded pill
  - queued: gray background, "Queued" text
  - processing: blue background, "Processing" text
  - completed: green background, "Completed" text
  - failed: red background, "Failed" text

- **Progress bar**: only visible when status is 'processing'
  - Width = data.overallProgress + '%'
  - Text: "Processing... X%"

- **Summary section**:
  - "X videos, Y variations per video"
  - For completed: count successful outputs. Check files array for completedVariations.
    Show "Z of Y variations completed" if partial failure.
  - For failed: show error message from data.error

- **Download section** (only when status === 'completed'):
  - Large download button "Download ZIP"
  - Expiry countdown: "Expires in Xh" using timeUntil(data.expiresAt)
  - If expired (timeUntil returns 'expired'): show "Expired" text, no download button

- **Download handler**:
  - On click: disable button, show "Preparing download..."
  - Fetch `/api/jobs/${jobId}/download` using apiCall (need raw response, not JSON)
  - Get blob from response: `const blob = await response.blob()`
  - Create blob URL, create anchor element, set href and download attribute, click, cleanup
  - `download` attribute: `video-refresher-${jobId}.zip`
  - Revoke blob URL after 1 second delay
  - Re-enable button on completion or error

**`cleanupJobDetail()` function:**
- Set isPolling = false
- Clear pollTimer
- Set currentJobId = null
- Reset pollInterval to 2000

**Build all DOM with createElement -- NO innerHTML.**

**Imports needed:**
- `{ apiCall }` from `../lib/api.js`
- `{ timeUntil, formatBytes }` from `../lib/utils.js`
  </action>
  <verify>
1. views/job-detail.js exports renderJobDetail and cleanupJobDetail
2. No innerHTML usage: `grep -n 'innerHTML' views/job-detail.js`
3. Uses visibilitychange event listener
4. Polling has backoff (interval increases) and jitter (random offset)
5. Download creates blob URL and triggers download via anchor click
  </verify>
  <done>
Job detail shows status badge, progress bar (when processing), and job summary.
Adaptive polling fetches updates with exponential backoff (2s to 10s) and jitter.
Polling pauses on hidden tab and resumes on visible tab.
Completed jobs show download button with expiry countdown.
Download triggers ZIP download via blob URL with proper cleanup.
Failed/expired states display appropriate messages.
cleanupJobDetail stops polling when navigating away.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement job list view with polling</name>
  <files>views/job-list.js</files>
  <action>
Replace the placeholder views/job-list.js with a complete implementation.

**Export:** `export function renderJobList(params)` and `export function cleanupJobList()` (for stopping polls when navigating away)

**Polling (module-level):**
- `let listPollTimer = null`
- `let listPolling = false`
- Fixed interval for job list: 5000ms (5 seconds) -- job list doesn't need aggressive polling
- Visibility change handler: pause when hidden, resume when visible (can share pattern with job-detail or register separately)

**`renderJobList(params)` behavior:**
1. Render into `#view-jobs`:
   - Page heading "My Jobs"
   - Job list container (empty initially, will be populated by fetch)
   - Empty state message (shown when no jobs exist): "No jobs yet. Start by uploading videos."
2. Immediately fetch job list and render
3. Start polling

**`fetchAndRenderJobs()` function:**
- Call `apiCall('/api/jobs')` to get array of jobs
- Parse JSON response
- Sort jobs by createdAt descending (newest first)
- Call `renderJobsList(jobs)` to update DOM

**`renderJobsList(jobs)` function:**
- If no jobs: show empty state, return
- For each job, create a row/card element:
  - **Status badge**: color-coded pill (same colors as job-detail: queued=gray, processing=blue, completed=green, failed=red)
  - **Job info**: "X videos x Y variations" (using job.totalVideos and job.totalVariations)
  - **Time**: timeAgo(job.createdAt) -- e.g., "5m ago", "2h ago"
  - **Action button**:
    - If completed: "Download" button (navigates to #job/{id} for download, NOT direct download -- keep it simple)
    - If queued/processing: "View Progress" link to #job/{id}
    - If failed: "View Details" link to #job/{id}
  - Check if job is expired: if createdAt + 24h < now, show "Expired" badge instead of status, gray out the row, no action button
- Clear the job list container and append new elements (do NOT re-render if job count/order hasn't changed -- but for simplicity, replacing content is acceptable since this is a small list)

**Expiry check logic:**
- Parse job.createdAt, add 24 hours
- If past: job is expired regardless of status field
- Show "Expired" badge, muted text, no clickable action

**`cleanupJobList()` function:**
- Set listPolling = false
- Clear listPollTimer

**Build all DOM with createElement -- NO innerHTML.**

**Imports needed:**
- `{ apiCall }` from `../lib/api.js`
- `{ timeAgo }` from `../lib/utils.js`
  </action>
  <verify>
1. views/job-list.js exports renderJobList and cleanupJobList
2. No innerHTML usage: `grep -n 'innerHTML' views/job-list.js`
3. Jobs sorted newest first
4. Status badges present for all job states
5. Expired jobs handled (no action button, muted styling)
  </verify>
  <done>
Job list shows all jobs sorted newest first with status badges, file/variation counts, and time ago.
Active jobs have "View Progress" links, completed jobs have "Download" links.
Expired jobs (24h+) shown with Expired badge and grayed out.
5-second polling refreshes job list while view is open.
Polling pauses on hidden tab and resumes on visible tab.
cleanupJobList stops polling when navigating away.
  </done>
</task>

</tasks>

<verification>
1. Navigate to #job/some-id -> shows loading then job status from API
2. Job in 'processing' state shows progress bar that updates via polling
3. Job in 'completed' state shows download button and expiry countdown
4. Download button triggers ZIP file download
5. Navigate to #jobs -> shows list of all jobs sorted by time
6. Job list refreshes automatically every 5 seconds
7. Hide tab -> polling stops (check Network tab). Show tab -> polling resumes.
8. No innerHTML in either file: `grep -n 'innerHTML' views/job-detail.js views/job-list.js`
</verification>

<success_criteria>
- Job detail view shows real-time progress with adaptive polling (2s-10s backoff)
- Polling respects Page Visibility API (pauses when hidden, resumes when visible)
- Download button triggers ZIP download for completed jobs
- Job list shows all jobs with correct status badges and timestamps
- Expired jobs are visually distinct with no download action
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-integration/09-03-SUMMARY.md`
</output>
