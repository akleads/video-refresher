---
phase: 09-frontend-integration
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - views/login.js
  - views/upload.js
autonomous: true

must_haves:
  truths:
    - "User enters password, submits, and receives token stored in localStorage on success"
    - "Invalid password shows inline error message, does not redirect or blank the page"
    - "Session expired parameter shows 'Session expired' message on login page"
    - "User can drag-and-drop or file-pick multiple MP4 files that accumulate in a file list"
    - "Each file in the list shows name, size, and a remove button"
    - "Submitting upload sends multipart FormData via XHR with upload progress bar"
    - "After successful upload, user is navigated to job detail page"
  artifacts:
    - path: "views/login.js"
      provides: "Login form with password input, error display, auth API call"
      min_lines: 40
    - path: "views/upload.js"
      provides: "Drag-drop zone, file list, variation input, XHR upload with progress"
      min_lines: 100
  key_links:
    - from: "views/login.js"
      to: "lib/api.js"
      via: "apiCall for POST /api/auth"
      pattern: "apiCall.*api/auth"
    - from: "views/login.js"
      to: "lib/api.js"
      via: "setToken to store received token"
      pattern: "setToken"
    - from: "views/upload.js"
      to: "lib/api.js"
      via: "uploadFiles for POST /api/jobs with FormData"
      pattern: "uploadFiles.*api/jobs"
    - from: "views/upload.js"
      to: "lib/router.js"
      via: "navigate to job detail after upload"
      pattern: "navigate.*job/"
---

<objective>
Implement the login view (password authentication with error handling) and upload view (drag-and-drop multi-file selection with XHR upload progress) -- the two input-focused views of the application.

Purpose: These views enable the user's first interaction: authenticating and submitting video files for processing. Without them, the app is inaccessible.
Output: Two view files (views/login.js, views/upload.js) that replace the placeholder stubs from Plan 01.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/09-frontend-integration/09-CONTEXT.md
@.planning/phases/09-frontend-integration/09-RESEARCH.md
@.planning/phases/09-frontend-integration/09-01-SUMMARY.md
@server/routes/auth.js
@server/routes/jobs.js
@lib/api.js
@lib/router.js
@lib/utils.js
@index.html
@styles.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement login view</name>
  <files>views/login.js</files>
  <action>
Replace the placeholder views/login.js with a complete login view implementation.

**Export:** `export function renderLogin(params)`

**Behavior:**
1. Render a centered login form into `#view-login`:
   - App title "Video Refresher" as heading
   - Subtitle "Enter the shared password to continue"
   - Password input field (type="password", required, autofocus)
   - Submit button "Log In"
   - Error message container (hidden by default)
   - Use textContent for all text to avoid XSS (the v1 codebase had innerHTML XSS risk -- do NOT repeat it)

2. If `params.expired === '1'`, show message "Your session has expired. Please log in again." in a notice/warning style above the form.

3. On form submit:
   - Prevent default
   - Disable submit button, change text to "Logging in..."
   - Call `apiCall('/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) })`
   - On success: parse response JSON, call `setToken(data.token)`, navigate to '#upload'
   - On error (401 from server): show "Invalid password" error message inline. Re-enable button.
   - On network error: show "Network error. Please try again." Re-enable button.
   - Clear password input on error

4. Build all DOM elements programmatically using `document.createElement()` -- do NOT use innerHTML. This is a security requirement.

**Imports needed:**
- `{ apiCall, setToken }` from `../lib/api.js`
- Router's navigate function (either import router instance or use `window.location.hash = '#upload'`)

**Edge cases:**
- Empty password: use HTML5 required attribute, form won't submit
- Rapid double-submit: disable button immediately on click
  </action>
  <verify>
1. views/login.js exists and exports renderLogin function
2. No innerHTML usage (grep for 'innerHTML' returns nothing in this file)
3. Imports apiCall and setToken from lib/api.js
4. Handles expired session parameter display
  </verify>
  <done>
Login form renders with password input and submit button.
Valid password stores token and navigates to upload.
Invalid password shows inline error without page navigation.
Session expired message displays when params.expired === '1'.
Zero innerHTML usage -- all DOM built with createElement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement upload view</name>
  <files>views/upload.js</files>
  <action>
Replace the placeholder views/upload.js with a complete upload view implementation.

**Export:** `export function renderUpload(params)`

**State management:**
- Module-level `let selectedFiles = []` array to accumulate files across drag/pick actions
- Reset selectedFiles to [] each time renderUpload is called (fresh state on view enter)

**Behavior:**

1. Render upload UI into `#view-upload`:
   - Drag-and-drop zone (div with upload icon SVG, "Drop videos here or click to browse" text, "MP4 files only" subtext)
   - Hidden file input (type="file", accept="video/mp4", multiple)
   - File list container (empty initially, populated as files are added)
   - Variation count row: label "Variations per video:", number input (min=1, max=20, value=5)
   - Submit button "Start Processing" (disabled when no files selected)
   - Upload progress section (hidden initially): progress bar + percentage text

2. Drag-and-drop handling:
   - Click on drop zone triggers hidden file input click
   - dragenter/dragover: preventDefault, stopPropagation, add .dragover class
   - dragleave: remove .dragover only if leaving the zone (not entering child)
   - drop: preventDefault, stopPropagation, remove .dragover, extract files, call addFiles()
   - File input change: extract files, call addFiles(), reset input value

3. `addFiles(newFiles)` function:
   - Filter to MP4 only (check file.type === 'video/mp4' OR file.name ends with .mp4)
   - Warn if some files filtered out (show temporary message, not alert())
   - Check file size: if any file > 100MB, show warning message (NOT blocking alert, just a yellow notice that auto-hides after 5s)
   - Append valid files to selectedFiles array (accumulate, don't replace)
   - Re-render file list
   - Enable/disable submit button based on selectedFiles.length > 0

4. File list rendering:
   - For each file: row with filename (truncated with ellipsis if long), file size (formatted with formatBytes from utils), remove button (X)
   - Remove button: splice file from selectedFiles, re-render list
   - Show total count and total size at bottom: "3 files (45.2 MB)"
   - Build all DOM with createElement -- NO innerHTML

5. Submit handler:
   - Validate: at least 1 file, variation count 1-20
   - Disable submit button
   - Show upload progress section
   - Create FormData: append each file as 'videos', append variations count
   - Call `uploadFiles('/api/jobs', formData, onProgress)` from lib/api.js
   - onProgress callback: update progress bar width and percentage text
   - On success (response contains jobId): navigate to `#job/${response.jobId}`
   - On error: show error message, re-enable submit, hide progress
   - On 401: handled by apiCall/uploadFiles (redirect to login)

**Imports needed:**
- `{ uploadFiles }` from `../lib/api.js`
- `{ formatBytes }` from `../lib/utils.js`

**Anti-patterns to avoid:**
- Do NOT set Content-Type on XHR when sending FormData
- Do NOT use innerHTML for any DOM rendering
- Do NOT use alert() for validation -- use inline messages
  </action>
  <verify>
1. views/upload.js exists and exports renderUpload function
2. No innerHTML usage in the file
3. Imports uploadFiles from lib/api.js and formatBytes from lib/utils.js
4. File input has accept="video/mp4" and multiple attribute
5. XHR upload uses xhr.upload.addEventListener('progress', ...) pattern
  </verify>
  <done>
Upload view renders drag-drop zone, file list, variation input, and submit button.
Files accumulate across multiple drag/pick actions with remove capability.
XHR upload shows real-time progress bar during file transfer.
After successful upload, navigates to job detail page for the new job.
Zero innerHTML usage throughout.
  </done>
</task>

</tasks>

<verification>
1. Login: enter wrong password -> inline error appears, no redirect
2. Login: enter correct password -> token in localStorage, redirected to #upload
3. Upload: drag MP4 files -> file list populates with names, sizes, remove buttons
4. Upload: click remove on a file -> file disappears from list
5. Upload: click "Start Processing" -> progress bar appears and advances during upload
6. Upload: after successful upload -> navigated to #job/{jobId}
7. No innerHTML in either file: `grep -n 'innerHTML' views/login.js views/upload.js`
</verification>

<success_criteria>
- Login authenticates and stores token on valid password
- Login shows error on invalid password without breaking UI
- Upload accepts multiple MP4 files via drag-drop and file picker
- Upload sends files as multipart/form-data with visible upload progress
- Navigation to job detail occurs after successful upload
</success_criteria>

<output>
After completion, create `.planning/phases/09-frontend-integration/09-02-SUMMARY.md`
</output>
