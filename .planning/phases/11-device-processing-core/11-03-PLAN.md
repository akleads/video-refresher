---
phase: 11-device-processing-core
plan: 03
type: execute
wave: 3
depends_on: ["11-01", "11-02"]
files_modified:
  - views/device-progress.js
  - app.js
  - index.html
  - styles.css
autonomous: false

must_haves:
  truths:
    - "User sees a distinct device processing view with overall progress bar and per-variation status"
    - "Cancel button stops processing and offers partial ZIP download of completed variations"
    - "Download button appears when processing completes, generating a ZIP matching server output structure"
    - "beforeunload warning prevents accidental page exit during active processing"
    - "No network requests are made to the server API during device processing"
    - "The device processing route is accessible via hash navigation"
  artifacts:
    - path: "views/device-progress.js"
      provides: "Device processing progress UI with cancel and download"
      min_lines: 120
    - path: "app.js"
      provides: "Updated SPA router with device-progress route"
      contains: "device-progress"
    - path: "index.html"
      provides: "New view container for device processing"
      contains: "view-device-progress"
  key_links:
    - from: "views/device-progress.js"
      to: "lib/device-processing/worker-pool.js"
      via: "imports WorkerPool class"
      pattern: "import.*WorkerPool"
    - from: "views/device-progress.js"
      to: "lib/device-processing/progress-tracker.js"
      via: "imports ProgressTracker class"
      pattern: "import.*ProgressTracker"
    - from: "views/device-progress.js"
      to: "lib/device-processing/zip-generator.js"
      via: "imports generateZip and triggerDownload"
      pattern: "import.*generateZip|triggerDownload"
    - from: "views/device-progress.js"
      to: "lib/effects-shared.js"
      via: "imports generateUniqueEffects for effect generation"
      pattern: "import.*generateUniqueEffects"
    - from: "app.js"
      to: "views/device-progress.js"
      via: "imports and registers route handler"
      pattern: "import.*device-progress"
---

<objective>
Create the device processing progress view and wire it into the SPA router. This is the user-facing view for on-device video processing.

Purpose: This plan delivers the complete user experience for device processing -- the view that shows progress, handles cancellation, and provides ZIP download. It ties together all the backend modules (worker pool, progress tracker, ZIP generator) into a cohesive UI. It also adds the route and HTML container so users can navigate to device processing.

Output: New view file, updated app.js with route, updated index.html with view container, CSS styles for device progress.
</objective>

<execution_context>
@/Users/alexkozhemiachenko/.claude/get-shit-done/workflows/execute-plan.md
@/Users/alexkozhemiachenko/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-device-processing-core/11-RESEARCH.md
@.planning/phases/11-device-processing-core/11-01-SUMMARY.md
@.planning/phases/11-device-processing-core/11-02-SUMMARY.md
@views/upload.js
@views/job-detail.js
@app.js
@index.html
@styles.css
@lib/device-processing/worker-pool.js
@lib/device-processing/progress-tracker.js
@lib/device-processing/zip-generator.js
@lib/effects-shared.js
@lib/capability-detection.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create device processing progress view</name>
  <files>
    views/device-progress.js
  </files>
  <action>
    Create `views/device-progress.js` as an ES module view following the existing view pattern (createElement for all DOM, no innerHTML):

    **Imports:**
    - `{ WorkerPool }` from `../lib/device-processing/worker-pool.js`
    - `{ ProgressTracker }` from `../lib/device-processing/progress-tracker.js`
    - `{ generateZip, triggerDownload }` from `../lib/device-processing/zip-generator.js`
    - `{ generateUniqueEffects }` from `../lib/effects-shared.js`

    **Exports:**
    - `renderDeviceProgress(files, variationCount)` -- Main render function. Receives the array of File objects and number of variations from the upload view (Phase 13 will wire this, but for now the function exists and is callable via route params or direct call).
    - `cleanupDeviceProgress()` -- Cleanup function for when user navigates away.

    **Module state:**
    - `workerPool` (WorkerPool instance or null)
    - `processing` (boolean)
    - `beforeUnloadHandler` (function reference for removal)

    **renderDeviceProgress(files, variationCount):**

    1. Get container `document.getElementById('view-device-progress')`, clear it.

    2. Build UI using createElement (match existing app styling patterns):
       - Title: "Processing on Device" (h1)
       - Subtitle: "Processing locally in your browser -- no data sent to server" (p, gray text)
       - Status text: "Initializing FFmpeg..." (div, updated during processing)
       - Overall progress bar (reuse existing CSS classes: progress-bar-track, progress-bar-fill)
       - Overall progress text (e.g., "3 of 10 variations complete")
       - Current variation indicator: "Processing variation 4..." with its own smaller progress bar
       - Cancel button (styled with btn btn-danger class): "Cancel Processing"
       - Download button (styled with btn btn-primary class, initially hidden): "Download ZIP"
       - Results summary section (initially hidden): shows completed/failed/total counts
       - "Start New Batch" link (initially hidden): navigates to #upload

    3. Start processing flow:
       a. Create WorkerPool (2 workers).
       b. Update status: "Loading FFmpeg.wasm..."
       c. Call `await workerPool.init()`. If fails, show error with message "FFmpeg.wasm failed to load. Try server processing instead." and a link to #upload. Return early.
       d. Update status with mode: "FFmpeg loaded (multi-threaded)" or "FFmpeg loaded (single-threaded)"
       e. Set `processing = true`, attach `beforeunload` handler.
       f. Process each file sequentially:
          - For each file, generate effects: `generateUniqueEffects(Math.random, variationCount)` (use Math.random as RNG, matching how server generates different effects per video).
          - Create ProgressTracker for this file's variations.
          - Wire progress tracker's onUpdate to update the DOM progress elements.
          - Call `workerPool.processVideo(file, effects, onProgress, onVariationComplete)`.
          - Collect results.
       g. After all files processed:
          - Set `processing = false`, remove beforeunload handler.
          - Update status to "Processing complete!" (or "Processing complete with errors" if any failed).
          - Show results summary: "X of Y variations completed successfully".
          - Show Download button.
          - Show "Start New Batch" link.

    4. Cancel button handler:
       - Call `workerPool.cancel()` to get partial results.
       - Set `processing = false`, remove beforeunload handler.
       - Update status: "Processing cancelled"
       - Show partial results count: "X of Y variations completed before cancellation"
       - If any results exist, show Download button with note "(partial)"
       - Show "Start New Batch" link.

    5. Download button handler:
       - Collect all results into array of `{ name, blob }` (names already formatted by worker pool as `videoName/variation_001.mp4`).
       - Call `generateZip(results)` to get ZIP blob.
       - Call `triggerDownload(zipBlob, 'processed-videos.zip')`.
       - Button remains enabled for re-download.

    6. beforeunload handler:
       - If `processing` is true, `event.preventDefault()` and `return ''`.

    **cleanupDeviceProgress():**
    - If workerPool exists and processing is active, terminate workers.
    - Remove beforeunload handler.
    - Reset module state.

    **UI styling notes:**
    - Use existing CSS classes where possible (btn, btn-primary, btn-danger, progress-bar-track, progress-bar-fill, status-badge)
    - Inline styles for layout (matching upload.js pattern of `style.cssText`)
    - Distinct appearance from server job-detail view to make it clear this is local processing (add a small "device" badge or icon indicator)
    - Use the gradient progress bar style consistent with the rest of the app

    **Important: How files get to this view.**
    For now, implement a temporary mechanism: the view reads from a module-level variable or sessionStorage. The upload view (Phase 13 integration) will set files before navigating. For this plan, create a `setDeviceProcessingData(files, variationCount)` export that the upload view can call before navigating to `#device-progress`. Store in module-level variables, not sessionStorage (files can't be serialized).
  </action>
  <verify>
    - `views/device-progress.js` exists and exports `renderDeviceProgress`, `cleanupDeviceProgress`, and `setDeviceProcessingData`
    - Imports WorkerPool, ProgressTracker, generateZip, triggerDownload, generateUniqueEffects
    - Uses createElement for all DOM (no innerHTML)
    - beforeunload handler attached when processing starts, removed when done
    - Cancel button calls workerPool.cancel() and shows partial results
    - Download button calls generateZip and triggerDownload
    - Sequential file processing with per-file ProgressTracker
  </verify>
  <done>
    Device progress view renders processing status with overall + per-variation progress, cancel button with partial download, download button for completed ZIP, and beforeunload warning during active processing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire device progress view into SPA router and HTML</name>
  <files>
    app.js
    index.html
    styles.css
  </files>
  <action>
    1. **index.html**: Add a new view container div after the existing view containers:
       ```html
       <div id="view-device-progress" class="view"></div>
       ```
       Place it after `<div id="view-job-detail" class="view"></div>`.

    2. **app.js**:
       a. Add import at top: `import { renderDeviceProgress, cleanupDeviceProgress } from './views/device-progress.js';`
       b. Add cleanup for device-progress in `showView` function: When navigating away from 'device-progress', call `cleanupDeviceProgress()`.
       c. Register new route: `router.add('device-progress', (params) => showView('device-progress', renderDeviceProgress)(params));`
       d. Note: The renderDeviceProgress function reads files from module-level state set by `setDeviceProcessingData()`, not from route params (since File objects can't be serialized to URLs).

    3. **styles.css**: Add device processing specific styles:
       - `.device-badge` -- Small badge indicating "On Device" processing (green background, white text, small rounded pill)
       - `.device-progress-section` -- Container for the progress area
       - `.variation-status` -- Text showing current variation being processed
       - `.results-summary` -- Summary section showing completed/failed counts
       - Reuse existing progress bar classes (progress-bar-track, progress-bar-fill)
  </action>
  <verify>
    - `index.html` contains `<div id="view-device-progress" class="view"></div>`
    - `app.js` imports from `views/device-progress.js`
    - `app.js` has route for `device-progress`
    - `app.js` showView handles cleanup for `device-progress`
    - `styles.css` has `.device-badge` and `.device-progress-section` classes
    - Navigating to `#device-progress` in browser shows the view container
  </verify>
  <done>
    SPA router recognizes `#device-progress` route, shows correct view container, cleans up workers on navigation away, and CSS styles are in place.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete device processing pipeline: FFmpeg.wasm Web Workers, worker pool, progress tracker, ZIP generator, device progress view, and SPA routing. The entire Phase 11 device processing core.
  </what-built>
  <how-to-verify>
    1. Run the local dev server: `cd /Users/alexkozhemiachenko/Downloads/Claude/video-refresher && npm run dev` (or `python3 server.py`)
    2. Open browser to localhost (ensure cross-origin isolation is enabled -- check `window.crossOriginIsolated` in console)
    3. To test device processing, you can temporarily modify the upload view's submit handler to call `setDeviceProcessingData(selectedFiles, variations)` and navigate to `#device-progress` instead of uploading to server. Or:
       a. Open browser console
       b. Import the modules: `import('./views/device-progress.js').then(m => { m.setDeviceProcessingData([testFile], 3); window.location.hash = '#device-progress'; })`
       c. Or navigate to `#device-progress` and check that the view renders (it will show "no files" error if setDeviceProcessingData wasn't called)
    4. Verify:
       - View renders with "Processing on Device" title
       - Progress bars appear and update during processing
       - Cancel button stops processing and shows partial results
       - Download button generates and downloads a ZIP file
       - ZIP contains files in the correct folder structure
       - No network requests to the API during processing (check Network tab)
       - beforeunload warning appears if you try to close tab during processing
  </how-to-verify>
  <resume-signal>Type "approved" to complete Phase 11, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Device progress view renders correctly with all UI elements
- Processing flow works end-to-end: init workers -> process videos -> show results -> download ZIP
- Cancel produces partial download
- No server API calls during device processing
- beforeunload warning active during processing
- SPA routing works for #device-progress
- Cleanup works when navigating away
</verification>

<success_criteria>
- Complete device processing UI is functional and distinct from server processing
- Progress shows both overall and per-variation status
- Cancel and download work correctly
- No server dependency during processing
- View is properly integrated into SPA routing with cleanup
- All four Phase 11 requirements (DEVC-01 through DEVC-04) are satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-device-processing-core/11-03-SUMMARY.md`
</output>
