# Milestone v1.0: Batch Processing MVP

**Status:** SHIPPED 2026-02-07
**Phases:** 1-5
**Total Plans:** 8

## Overview

This roadmap transformed the existing single-video processing tool into a batch variation generator. The journey began with FFmpeg.wasm modernization, then established memory stability (critical for batch operations), optimized performance, built core batch generation with progress tracking, and completed with ZIP download for bulk variations. Each phase delivered a verifiable capability that unblocked the next.

## Phases

### Phase 1: FFmpeg.wasm Upgrade

**Goal**: FFmpeg.wasm upgraded to 0.12.x with multi-threading support and verified stability
**Depends on**: Nothing (first phase)
**Plans**: 2 plans

Plans:
- [x] 01-01: FFmpeg 0.12.x initialization with SharedArrayBuffer detection and COOP/COEP header verification
- [x] 01-02: Migrate processVideo() to 0.12.x async API and verify end-to-end processing

**Details:**
- Upgraded from 0.11.6 to 0.12.14 with breaking API changes handled
- SharedArrayBuffer detection for automatic multi-threaded vs single-threaded selection
- CDN loading via toBlobURL (jsdelivr) for CORS bypass
- Self-hosted FFmpeg class worker (ffmpeg-worker.js) to resolve CORS cross-origin issue
- End-to-end verified: upload → process → preview → download

### Phase 2: Memory Management

**Goal**: Memory leaks eliminated and cleanup infrastructure established for batch stability
**Depends on**: Phase 1
**Plans**: 2 plans

Plans:
- [x] 02-01: BlobURLRegistry, blob URL revocation lifecycle, bounded processedVideos with eviction cleanup
- [x] 02-02: FFmpeg instance recovery on corruption errors + human verification of memory stability

**Details:**
- BlobURLRegistry class tracks all blob URLs with centralized revocation
- processedVideos capped at 20 entries with automatic oldest-entry eviction
- FFmpeg instance auto-recovers from corruption errors (OOM, abort, RuntimeError)
- Memory stability verified across 10 consecutive processing operations
- beforeunload safety net revokes all remaining blob URLs

### Phase 3: Performance Optimization

**Goal**: Processing speed optimized for efficient batch operations
**Depends on**: Phase 2
**Plans**: 1 plan

Plans:
- [x] 03-01: Ultrafast encoding preset, buffer reuse infrastructure, and performance timing

**Details:**
- Replaced tiered encoding with unified ultrafast preset
- loadVideoBuffer() for one-time buffer reading
- preloadedBuffer parameter for buffer reuse across operations
- cleanupInput parameter for conditional MEMFS cleanup
- Performance timing via performance.now()

### Phase 4: Core Batch Generation

**Goal**: User can generate multiple unique variations from single upload with progress tracking
**Depends on**: Phase 3
**Plans**: 2 plans

Plans:
- [x] 04-01: Batch logic foundations: unique effect generator, variation filename formatter, and processVideo extension
- [x] 04-02: Batch UI controls, orchestration with cancellation, progress tracking, and end-to-end verification

**Details:**
- generateUniqueEffects() with Set-based duplicate detection
- formatVariationFilename() for consistent naming (originalname_var1_abc123.mp4)
- Batch controls UI with variation count input (1-20)
- generateBatch() orchestrator with sequential processing and buffer reuse
- Orchestration-layer cancellation between variations
- First completed variation displays in preview immediately

### Phase 5: ZIP Download

**Goal**: All batch variations downloadable as single ZIP file
**Depends on**: Phase 4
**Plans**: 1 plan

Plans:
- [x] 05-01: JSZip integration with STORE compression, "Download All as ZIP" button, blob URL cleanup

**Details:**
- JSZip 3.10.1 via jsdelivr CDN
- STORE compression (no re-compression of already-compressed video)
- Progress feedback during ZIP creation
- Blob URL cleanup after download
- Fixed critical ArrayBuffer neutering bug in batch generation

---

## Milestone Summary

**Key Decisions:**
- Use jsdelivr CDN for FFmpeg.wasm 0.12.x (proven compatibility)
- Self-host FFmpeg class worker for CORS-safe loading
- Cap processedVideos at 20 entries for memory management
- Use ultrafast encoding preset for all videos (speed over marginal quality)
- Sequential batch processing to avoid FFmpeg conflicts
- Orchestration-layer cancellation (FFmpeg doesn't support mid-encoding abort)
- STORE compression for ZIP (videos already H.264 compressed)
- Copy buffer before ffmpeg.writeFile to prevent ArrayBuffer neutering

**Issues Resolved:**
- FFmpeg class Worker CORS cross-origin error (self-hosted worker solution)
- Known FFmpeg 0.12.x bug returning negative progress values (clamped to 0-1)
- SharedArrayBuffer detection requires both typeof check and crossOriginIsolated flag
- ArrayBuffer neutering from postMessage transfer in ffmpeg.writeFile() (buffer copy solution)

**Issues Deferred:**
- No automated tests (523→1001 lines of app.js still untested)
- XSS risk from innerHTML with filenames (noted but not addressed in v1)

**Technical Debt Incurred:**
- Effect parameter ranges hardcoded (could be configurable)
- No retry logic for failed individual variations in batch
- Single app.js file growing large (1001 lines) — may benefit from module splitting

---

_For current project status, see .planning/ROADMAP.md_
