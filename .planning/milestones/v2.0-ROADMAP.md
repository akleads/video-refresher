# Milestone v2.0: Server-Side Multi-Video Processing

**Status:** SHIPPED 2026-02-08
**Phases:** 6-9
**Total Plans:** 12

## Overview

Move processing to a backend server on Fly.io, support multiple source videos per batch, and enable fire-and-forget workflow (close tab, return for results).

## Phases

### Phase 6: Backend Foundation

**Goal**: A running Express API on Fly.io that accepts multi-video uploads, authenticates users with a shared password, and persists job state in SQLite -- processing is stubbed but the entire infrastructure is deployed and verified.
**Depends on**: v1.0 (existing frontend on Cloudflare Pages)
**Requirements**: INFRA-01, INFRA-02, INFRA-03, INFRA-04, INFRA-05, PROC-01, PROC-03
**Plans**: 3 plans

Plans:
- [x] 06-01-PLAN.md -- Server foundation: Express 5 app, SQLite database, auth system, health endpoint
- [x] 06-02-PLAN.md -- Jobs API: multi-file upload with Multer, job creation, job status queries
- [x] 06-03-PLAN.md -- Deployment: Dockerfile, fly.toml, deploy to Fly.io, verify live endpoints

**Success Criteria** (all met):
  1. User can POST a shared password to the auth endpoint and receive a bearer token that gates all other endpoints
  2. User can upload multiple MP4 files in a single request and receive a job ID back (HTTP 202)
  3. User can query a job status endpoint with the job ID and see per-video entries in the response (status: queued)
  4. The server is live on Fly.io with a 3GB volume, Docker container runs Node.js 22 + FFmpeg binary, and the health endpoint responds
  5. All uploaded files are written to the Fly Volume (not /tmp), and SQLite database persists across server restarts

### Phase 7: FFmpeg Processing Engine

**Goal**: Uploaded videos are processed into variations using native FFmpeg with the same random effects as v1, with progress tracking and error handling per video -- the core value of v2.
**Depends on**: Phase 6
**Requirements**: PROC-02, PROC-04, PROC-05, PROC-06
**Plans**: 3 plans

Plans:
- [x] 07-01-PLAN.md -- Schema extensions, FFmpeg spawn wrapper, and effects generator
- [x] 07-02-PLAN.md -- Video processor and job queue worker
- [x] 07-03-PLAN.md -- Startup recovery, graceful shutdown, and status endpoint enhancement

**Success Criteria** (all met):
  1. After submitting a job via API, output variation files appear on the Fly Volume with visually distinct random effects matching v1 quality (zoom, color, noise, speed, mirror)
  2. Polling the job status endpoint shows per-video progress percentage that advances from 0 to 100 as FFmpeg processes each video
  3. Jobs continue processing after the API client disconnects (fire-and-forget verified by uploading, killing the connection, and polling later to see completion)
  4. If the server restarts mid-processing, interrupted jobs are marked as failed/retryable in SQLite (not silently lost)
  5. A video that fails to process (corrupt input, FFmpeg error) does not block the rest of the batch -- other videos complete normally

### Phase 8: Download, Cleanup, and Job Lifecycle

**Goal**: The backend lifecycle is complete end-to-end -- upload, process, download as ZIP, auto-expire after 24 hours, and evict oldest results when storage is full.
**Depends on**: Phase 7
**Requirements**: STOR-01, STOR-02, STOR-03, STOR-04, DOWN-01, DOWN-02, DOWN-03
**Plans**: 2 plans

Plans:
- [x] 08-01-PLAN.md -- Streaming ZIP download endpoint and upload file cleanup after processing
- [x] 08-02-PLAN.md -- Cleanup daemon for automatic job expiry and storage-cap eviction

**Success Criteria** (all met):
  1. User can download a single ZIP file containing all variations organized into folders by source video name, and the ZIP uses STORE compression (no re-compression of H.264)
  2. Download remains available until the job expires (24 hours after completion) or is evicted by storage pressure
  3. Jobs older than 24 hours are automatically deleted (files removed from volume, rows cleaned from SQLite) without manual intervention
  4. When total stored output exceeds the volume cap, the oldest completed jobs are evicted first to make room for new results
  5. Upload source files are deleted from the volume after processing completes (not held for 24 hours)

### Phase 9: Frontend Integration

**Goal**: Users interact with the full application through the browser -- login, upload multiple videos, watch progress, see job history, and download results -- with all client-side FFmpeg.wasm code removed.
**Depends on**: Phase 8
**Requirements**: FEND-01, FEND-02, FEND-03, FEND-04, FEND-05, FEND-06, FEND-07
**Plans**: 4 plans

Plans:
- [x] 09-01-PLAN.md -- SPA infrastructure: index.html shell, hash router, API client, utilities, styles, app entry point
- [x] 09-02-PLAN.md -- Login view (password auth) and upload view (drag-drop, XHR progress)
- [x] 09-03-PLAN.md -- Job detail view (adaptive polling, download) and job list view (history)
- [x] 09-04-PLAN.md -- FFmpeg.wasm cleanup, header updates, view cleanup wiring, E2E verification

**Success Criteria** (all met):
  1. User sees a login screen, enters the shared password, and gains access to the app (invalid password shows an error, not a blank page)
  2. User can drag-and-drop or file-pick multiple MP4 files, set a variation count, and submit a batch -- the UI shows the job was accepted and begins polling for progress
  3. Progress display updates per-video status (queued, processing with percentage, complete, failed) via polling without requiring the tab to stay open
  4. Job list page shows all active, completed, and expired jobs with download buttons for completed jobs and status indicators for in-progress ones
  5. All FFmpeg.wasm code, worker files, and client-side processing logic are removed -- the frontend makes zero references to FFmpeg.wasm and loads no wasm bundles

---

## Milestone Summary

**Key Decisions:**
- Use 3GB Fly Volume (peak batch usage ~1.28GB)
- node:22-slim Docker base (better-sqlite3 needs glibc)
- child_process.spawn for FFmpeg (fluent-ffmpeg archived May 2025)
- HMAC tokens instead of JWT (simpler, zero deps)
- SQLite WAL mode for concurrent reads during writes
- Multer DiskStorage direct to Fly Volume (avoids /tmp RAM disk)
- Store FFmpeg pid in SQLite for zombie cleanup on restart
- Job 'completed' if any file succeeds (partial results delivered)
- archiver { store: true } for ZIPs (no re-compression of H.264)
- 85% eviction threshold with 5-minute cleanup interval
- XHR for file uploads (enables upload progress events)
- createElement for all DOM (prevents XSS, no innerHTML)
- Adaptive polling (2s → 10s backoff with jitter)
- Page Visibility API to pause polling when tab hidden

**Issues Resolved:**
- FFmpeg filter parity between native FFmpeg and FFmpeg.wasm resolved (Debian bookworm ships FFmpeg 5.1.8)
- COOP/COEP headers removed from Cloudflare Pages (no longer needed without SharedArrayBuffer)

**Issues Deferred:**
- SSE for real-time progress (polling works, SSE is a nice-to-have)
- Job cancellation (kill in-progress FFmpeg)
- Retry individual failed videos
- Resumable uploads for large files

**Technical Debt Incurred:**
- None significant — clean architecture with clear separation of concerns

---
_For current project status, see .planning/ROADMAP.md_
